import{c as ke,u as O,j as e,C as K,b as se,d as ae,e as te,f as H,a8 as ge,B as A,a_ as Pe,a$ as De,b0 as me,b1 as $,b2 as Ie,b3 as M,b4 as Re,aj as W,aV as fe,r as m,aH as xe,aW as Z,bI as ue,aK as P,L as pe,S as Te,m as We,n as Qe,p as Fe,q as he,I as ee,b5 as ne,x as g,aQ as $e,ab as ve,ac as je,ad as _e,ae as we,af as Ce,ah as be,T as Me,a2 as Ve,a3 as ze,a4 as J,a5 as X}from"./index-v68zVK4x.js";import{b as Le}from"./browser-CjSdxGTc.js";import{R as Se}from"./refresh-cw-C0d5nUEp.js";import{Q as Oe}from"./qr-code-D6JTyGnX.js";import{P as Ke}from"./pen-BFxXknah.js";import{C as Y}from"./circle-check-DnVeMRDK.js";import{S as He}from"./save-zL82AGvd.js";import{A as Ge,a as Be,b as Ue,c as Je,d as Xe,e as Ye,f as Ze,g as es}from"./alert-dialog-DWcOo5bl.js";import{C as ss}from"./circle-alert-hkr6z4Ez.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=ke("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);function ts({sessions:r,isLoading:p,loadingStatus:u,onAddNew:i,onEdit:N,onDelete:j,onConnect:v,onCheckStatus:C}){O();const y=c=>{switch(c){case"open":return e.jsx(W,{className:"bg-green-500",children:"Conectado"});case"close":return e.jsx(W,{variant:"destructive",children:"Desconectado"});case"connecting":return e.jsx(W,{variant:"secondary",children:"Conectando..."});default:return e.jsx(W,{variant:"outline",children:"Verificando..."})}};return e.jsxs(K,{children:[e.jsxs(se,{children:[e.jsx(ae,{children:"Sess√µes Configuradas"}),e.jsx(te,{children:"Gerencie as sess√µes do WhatsApp da sua empresa"})]}),e.jsx(H,{children:p?e.jsx("p",{children:"Carregando..."}):r.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ge,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Nenhuma sess√£o configurada."}),e.jsx(A,{onClick:i,className:"mt-4",children:"Adicionar Primeira Sess√£o"})]}):e.jsxs(Pe,{children:[e.jsx(De,{children:e.jsxs(me,{children:[e.jsx($,{children:"Nome da Sess√£o"}),e.jsx($,{children:"Nome do Agente"}),e.jsx($,{children:"Status"}),e.jsx($,{children:"Prompt"}),e.jsx($,{className:"text-right",children:"A√ß√µes"})]})}),e.jsx(Ie,{children:r.map(c=>e.jsxs(me,{children:[e.jsx(M,{className:"font-medium",children:c.session_name}),e.jsx(M,{children:c.agent_name}),e.jsx(M,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[y(c.connection_status),e.jsx(A,{size:"sm",variant:"ghost",onClick:()=>C(c.session_name),disabled:u[c.session_name],children:e.jsx(Se,{className:`h-4 w-4 ${u[c.session_name]?"animate-spin":""}`})})]})}),e.jsx(M,{children:e.jsx("span",{className:"text-sm text-muted-foreground",children:c.agent_prompt?c.agent_prompt.length>50?c.agent_prompt.substring(0,50)+"...":c.agent_prompt:"Sem prompt definido"})}),e.jsx(M,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[c.connection_status!=="open"&&e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>v(c.session_name),children:[e.jsx(Oe,{className:"h-4 w-4 mr-1"}),"Conectar"]}),e.jsx(A,{size:"sm",variant:"ghost",onClick:()=>N(c),children:e.jsx(Ke,{className:"h-4 w-4"})}),e.jsx(A,{size:"sm",variant:"ghost",onClick:()=>j(c.id),children:e.jsx(Re,{className:"h-4 w-4"})})]})})]},c.id))})]})})]})}function ns({sessions:r}){const{toast:p}=O(),u=fe(),[i,N]=m.useState(""),[j,v]=m.useState(""),[C,y]=m.useState(""),[c,o]=m.useState(!1),[d,b]=m.useState(!1),[f,q]=m.useState(null);m.useEffect(()=>{(async()=>{const{data:{user:h}}=await g.auth.getUser();if(h){const{data:V}=await g.from("profiles").select("company_id").eq("id",h.id).single();V&&q(V.company_id)}})()},[]);const{data:x}=xe({queryKey:["store-settings",f],queryFn:async()=>{if(!f)return null;const{data:l,error:h}=await g.from("store_settings").select("default_whatsapp_session").eq("company_id",f).single();return h&&h.code!=="PGRST116"?(console.error("Erro ao buscar configura√ß√µes:",h),null):l},enabled:!!f});m.useEffect(()=>{if(x!=null&&x.default_whatsapp_session&&!i){const l=r.find(h=>h.session_name===x.default_whatsapp_session&&h.connection_status==="open");l&&N(l.session_name)}},[x,r,i]);const S=Z({mutationFn:async l=>{if(!f)throw new Error("Company ID n√£o encontrado");const{error:h}=await g.from("store_settings").upsert({company_id:f,default_whatsapp_session:l},{onConflict:"company_id"});if(h)throw h},onSuccess:()=>{u.invalidateQueries({queryKey:["store-settings"]}),p({title:"Sess√£o padr√£o salva",description:"Esta sess√£o ser√° selecionada automaticamente nos pr√≥ximos testes."})},onError:l=>{console.error("Erro ao salvar sess√£o padr√£o:",l),p({title:"Erro ao salvar",description:"N√£o foi poss√≠vel salvar a sess√£o padr√£o.",variant:"destructive"})}}),D=async()=>{if(!i){p({title:"Erro",description:"Selecione uma sess√£o para enviar a mensagem.",variant:"destructive"});return}if(!j||!C){p({title:"Erro",description:"Preencha o n√∫mero de telefone e a mensagem.",variant:"destructive"});return}const l=j.replace(/\D/g,"");if(l.length<10||l.length>11){p({title:"N√∫mero inv√°lido",description:"O n√∫mero deve ter entre 10 e 11 d√≠gitos.",variant:"destructive"});return}o(!0),b(!1);try{const h=await g.functions.invoke("whatsapp-send",{body:{instanceName:i,number:`55${l}`,message:C}});if(h.error)throw new Error(h.error.message);b(!0),p({title:"‚úÖ Mensagem enviada com sucesso!",description:`Mensagem enviada para ${j} via ${i}`,className:"bg-green-50 border-green-200"}),y(""),v(""),setTimeout(()=>b(!1),3e3)}catch(h){console.error("Erro ao enviar mensagem:",h),p({title:"‚ùå Erro ao enviar",description:h instanceof Error?h.message:"N√£o foi poss√≠vel enviar a mensagem.",variant:"destructive"})}finally{o(!1)}},I=r.filter(l=>l.connection_status==="open");return e.jsxs(K,{className:d?"border-green-500 animate-pulse":"",children:[e.jsx(se,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:["Teste de Envio",d&&e.jsx(Y,{className:"h-5 w-5 text-green-500 animate-scale-in"})]}),e.jsx(te,{children:"Envie uma mensagem de teste pelo WhatsApp"})]}),i&&(x==null?void 0:x.default_whatsapp_session)===i&&e.jsxs(W,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(ue,{className:"h-3 w-3"}),"Padr√£o"]})]})}),e.jsxs(H,{className:"space-y-4",children:[d&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[e.jsx(Y,{className:"h-5 w-5"}),e.jsx("p",{className:"font-medium",children:"Mensagem enviada com sucesso!"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-1",children:"Verifique o WhatsApp do destinat√°rio para confirmar o recebimento."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(P,{htmlFor:"session",children:"Sess√£o"}),i&&i!==(x==null?void 0:x.default_whatsapp_session)&&e.jsxs(A,{variant:"ghost",size:"sm",onClick:()=>S.mutate(i),disabled:S.isPending,className:"text-xs",children:[S.isPending?e.jsx(pe,{className:"h-3 w-3 mr-1 animate-spin"}):e.jsx(ue,{className:"h-3 w-3 mr-1"}),"Definir como padr√£o"]})]}),e.jsxs(Te,{value:i,onValueChange:N,children:[e.jsx(We,{children:e.jsx(Qe,{placeholder:"Selecione uma sess√£o conectada"})}),e.jsx(Fe,{children:I.length===0?e.jsx(he,{value:"none",disabled:!0,children:"Nenhuma sess√£o conectada"}):I.map(l=>e.jsx(he,{value:l.session_name,children:e.jsxs("div",{className:"flex items-center gap-2",children:[l.session_name,(x==null?void 0:x.default_whatsapp_session)===l.session_name&&e.jsx(W,{variant:"outline",className:"text-xs",children:"Padr√£o"})]})},l.id))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{htmlFor:"phone",children:"N√∫mero do WhatsApp"}),e.jsx(ee,{id:"phone",placeholder:"Ex: 11999998888",value:j,onChange:l=>v(l.target.value),disabled:!i||c,className:d?"border-green-400":""})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{htmlFor:"message",children:"Mensagem"}),e.jsx(ne,{id:"message",placeholder:"Digite sua mensagem de teste...",value:C,onChange:l=>y(l.target.value),rows:4,disabled:!i||c,className:d?"border-green-400":""})]}),e.jsx(A,{onClick:D,disabled:!i||c||!j||!C,className:"w-full relative overflow-hidden",variant:"default",children:c?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 mr-2 animate-spin"}),"Enviando mensagem..."]}):d?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Mensagem Enviada!"]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"h-4 w-4 mr-2"}),"Enviar Mensagem"]})})]})]})}function rs(){const{toast:r}=O(),[p,u]=m.useState(null),[i,N]=m.useState([{status:"pending",label:"Novo Pedido",message:`üîî *Novo Pedido!*

Recebemos seu pedido #{order_number}!

üì¶ *Itens:*
{order_items}

üí∞ *Total:* R$ {order_total}

Estamos preparando com carinho! üòä`,enabled:!0},{status:"preparando",label:"Preparando",message:`üë®‚Äçüç≥ *Pedido em Prepara√ß√£o*

Seu pedido #{order_number} est√° sendo preparado!

‚è±Ô∏è Tempo estimado: {estimated_time} minutos`,enabled:!0},{status:"pronto",label:"Pronto",message:`‚úÖ *Pedido Pronto!*

Seu pedido #{order_number} est√° pronto!

üèÉ Em breve sair√° para entrega.`,enabled:!0},{status:"em_entrega",label:"Em Entrega",message:`üö¥ *Saiu para Entrega!*

Seu pedido #{order_number} est√° a caminho!

üìç Endere√ßo: {delivery_address}`,enabled:!0},{status:"concluido",label:"Conclu√≠do",message:`üéâ *Pedido Entregue!*

Obrigado pela prefer√™ncia!

Esperamos voc√™ novamente! ‚ù§Ô∏è`,enabled:!0},{status:"cancelado",label:"Cancelado",message:`‚ùå *Pedido Cancelado*

Seu pedido #{order_number} foi cancelado.

Motivo: {cancellation_reason}

Qualquer d√∫vida, estamos √† disposi√ß√£o.`,enabled:!1}]),[j,v]=m.useState(!1);m.useEffect(()=>{async function o(){const{data:{user:d}}=await g.auth.getUser();if(d){const{data:b}=await g.from("profiles").select("company_id").eq("id",d.id).single();if(b!=null&&b.company_id){u(b.company_id);const{data:f,error:q}=await g.from("whatsapp_config").select("*").eq("company_id",b.company_id).eq("config_type","status_message");if(!q&&f&&f.length>0){const x=i.map(S=>{const D=f.find(I=>I.status===S.status);return D?{...S,message:D.message_template,enabled:D.is_active}:S});N(x)}}}}o()},[]);const C=(o,d)=>{N(b=>b.map(f=>f.status===o?{...f,message:d}:f))},y=(o,d)=>{N(b=>b.map(f=>f.status===o?{...f,enabled:d}:f))},c=async()=>{if(!p){r({title:"Erro",description:"ID da empresa n√£o encontrado.",variant:"destructive"});return}v(!0);try{for(const o of i){const{error:d}=await g.from("whatsapp_config").upsert({company_id:p,config_type:"status_message",status:o.status,message_template:o.message,is_active:o.enabled},{onConflict:"company_id,status,config_type"});if(d)throw d}r({title:"Configura√ß√µes salvas!",description:"As mensagens de status foram atualizadas com sucesso."})}catch(o){console.error("Erro ao salvar mensagens:",o),r({title:"Erro ao salvar",description:"N√£o foi poss√≠vel salvar as configura√ß√µes.",variant:"destructive"})}finally{v(!1)}};return e.jsxs(K,{children:[e.jsxs(se,{children:[e.jsx(ae,{children:"Mensagens por Status"}),e.jsx(te,{children:"Configure as mensagens autom√°ticas para cada mudan√ßa de status do pedido"})]}),e.jsxs(H,{className:"space-y-6",children:[i.map(o=>e.jsxs("div",{className:"space-y-3 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(P,{className:"text-base font-semibold",children:o.label}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{htmlFor:`enabled-${o.status}`,className:"text-sm",children:"Enviar notifica√ß√£o"}),e.jsx($e,{id:`enabled-${o.status}`,checked:o.enabled,onCheckedChange:d=>y(o.status,d)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(P,{htmlFor:`msg-${o.status}`,className:"text-sm text-muted-foreground",children:["Mensagem (use vari√°veis: ","{order_number}",", ","{order_items}",", ","{order_total}",", ","{estimated_time}",", ","{delivery_address}",")"]}),e.jsx(ne,{id:`msg-${o.status}`,value:o.message,onChange:d=>C(o.status,d.target.value),rows:5,disabled:!o.enabled,className:"font-mono text-sm"})]})]},o.status)),e.jsxs(A,{onClick:c,disabled:j,className:"w-full",children:[e.jsx(He,{className:"h-4 w-4 mr-2"}),j?"Salvando...":"Salvar Configura√ß√µes"]})]})]})}function os({open:r,onOpenChange:p,formData:u,onFormChange:i,onSave:N,onCancel:j,isEditing:v}){return e.jsx(ve,{open:r,onOpenChange:p,children:e.jsxs(je,{className:"sm:max-w-[500px]",children:[e.jsxs(_e,{children:[e.jsx(we,{children:v?"Editar Sess√£o":"Nova Sess√£o WhatsApp"}),e.jsx(Ce,{children:v?"Atualize as informa√ß√µes da sess√£o WhatsApp.":"Configure uma nova sess√£o do WhatsApp para sua empresa."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"session_name",children:"Nome da Sess√£o *"}),e.jsx(ee,{id:"session_name",placeholder:"Ex: Atendimento Principal",value:u.session_name,onChange:C=>i({...u,session_name:C.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"agent_name",children:"Nome do Agente *"}),e.jsx(ee,{id:"agent_name",placeholder:"Ex: Assistente Virtual",value:u.agent_name,onChange:C=>i({...u,agent_name:C.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"agent_prompt",children:"Prompt do Agente"}),e.jsx(ne,{id:"agent_prompt",placeholder:"Defina o comportamento e personalidade do agente...",value:u.agent_prompt,onChange:C=>i({...u,agent_prompt:C.target.value}),rows:4})]})]}),e.jsxs(be,{children:[e.jsx(A,{variant:"outline",onClick:j,children:"Cancelar"}),e.jsx(A,{onClick:N,children:v?"Salvar":"Criar"})]})]})})}function is({open:r,qrCode:p,sessionName:u,onClose:i,onRefresh:N}){return e.jsx(ve,{open:r,onOpenChange:j=>!j&&i(),children:e.jsxs(je,{className:"sm:max-w-[425px]",children:[e.jsxs(_e,{children:[e.jsx(we,{children:"Conectar WhatsApp"}),e.jsxs(Ce,{children:["Escaneie o QR Code abaixo com o WhatsApp da sess√£o: ",u]})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-6",children:[p&&e.jsx("img",{src:p,alt:"QR Code WhatsApp",className:"w-64 h-64 border-2 border-border rounded-lg"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-4 text-center",children:'O QR Code expira em alguns minutos. Se necess√°rio, clique em "Gerar Novo QR Code".'})]}),e.jsxs(be,{children:[e.jsx(A,{variant:"outline",onClick:i,children:"Fechar"}),e.jsxs(A,{onClick:()=>N(u),children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Gerar Novo QR Code"]})]})]})})}function xs(){const{toast:r}=O(),p=fe(),[u,i]=m.useState(null),[N,j]=m.useState(!1),[v,C]=m.useState(null),[y,c]=m.useState(null),[o,d]=m.useState({open:!1,qrCode:"",sessionName:""}),[b,f]=m.useState({}),[q,x]=m.useState({session_name:"",agent_name:"",agent_prompt:""});m.useEffect(()=>{async function s(){const{data:{user:a}}=await g.auth.getUser();if(a){const{data:t}=await g.from("profiles").select("company_id").eq("id",a.id).single();t!=null&&t.company_id&&i(t.company_id)}}s()},[]);const{data:S=[],isLoading:D}=xe({queryKey:["whatsapp-sessions",u],queryFn:async()=>{if(console.log("[WhatsApp] Loading sessions for company:",u),!u)return[];const{data:s,error:a}=await g.from("whatsapp_config").select("*").eq("company_id",u).eq("config_type","session").order("created_at",{ascending:!1});if(a)throw console.error("[WhatsApp] Failed to load sessions:",a),a;return console.log("[WhatsApp] Sessions loaded:",(s==null?void 0:s.length)||0),s},enabled:!!u,staleTime:3e4,gcTime:6e4}),I=Z({mutationFn:async s=>{if(s.id){const{error:a}=await g.from("whatsapp_config").update({session_name:s.session_name,agent_name:s.agent_name,agent_prompt:s.agent_prompt||null}).eq("id",s.id);if(a)throw a;return{isNew:!1,data:s}}else{const{error:a}=await g.from("whatsapp_config").insert({company_id:u,config_type:"session",session_name:s.session_name,agent_name:s.agent_name,agent_prompt:s.agent_prompt||null});if(a)throw a;return{isNew:!0,data:s}}},onSuccess:async({isNew:s,data:a})=>{if(p.invalidateQueries({queryKey:["whatsapp-sessions"]}),r({title:v?"Sess√£o atualizada":"Sess√£o adicionada",description:`A sess√£o foi ${v?"atualizada":"adicionada"} com sucesso.`}),re(),s)try{const t=await g.functions.invoke("whatsapp-evolution",{body:{sessionName:a.session_name,agentName:a.agent_name,agentPrompt:a.agent_prompt||""}});t.error?(console.error("Erro ao comunicar com Evolution API:",t.error),r({title:"Aten√ß√£o",description:"Sess√£o salva, mas houve erro ao comunicar com Evolution API.",variant:"destructive"})):console.log("Sucesso ao comunicar com Evolution API:",t.data)}catch(t){console.error("Erro ao chamar edge function:",t)}},onError:()=>{r({title:`Erro ao ${v?"atualizar":"adicionar"}`,description:`N√£o foi poss√≠vel ${v?"atualizar":"adicionar"} a sess√£o.`,variant:"destructive"})}}),l=Z({mutationFn:async s=>{const a=S.find(n=>n.id===s),{error:t}=await g.from("whatsapp_config").delete().eq("id",s);if(t)throw t;if(a)try{await g.functions.invoke("whatsapp-evolution",{body:{instanceName:a.session_name,action:"delete"}})}catch(n){console.error("Erro ao deletar da Evolution API:",n)}},onSuccess:()=>{p.invalidateQueries({queryKey:["whatsapp-sessions"]}),r({title:"Sess√£o removida",description:"A sess√£o foi removida com sucesso."})},onError:()=>{r({title:"Erro ao remover",description:"N√£o foi poss√≠vel remover a sess√£o.",variant:"destructive"})}}),h=()=>{x({session_name:"",agent_name:"",agent_prompt:""}),C(null),j(!0)},V=s=>{x({session_name:s.session_name,agent_name:s.agent_name,agent_prompt:s.agent_prompt||""}),C(s),j(!0)},re=()=>{j(!1),C(null),x({session_name:"",agent_name:"",agent_prompt:""})},Ne=()=>{if(!q.session_name.trim()||!q.agent_name.trim()){r({title:"Campos obrigat√≥rios",description:"Nome da sess√£o e nome do agente s√£o obrigat√≥rios.",variant:"destructive"});return}if(!v&&S.find(a=>a.session_name.toLowerCase()===q.session_name.trim().toLowerCase())){r({title:"Nome duplicado",description:"J√° existe uma sess√£o com este nome. Por favor, escolha outro nome.",variant:"destructive"});return}v?I.mutate({...q,id:v.id}):I.mutate(q)},Ee=s=>{l.mutate(s),c(null)},oe=m.useRef({}),G=m.useRef({}),z=m.useRef({}),B=m.useRef({}),ie=1e4,Ae=s=>{var t,n,_;const a=((n=(t=s==null?void 0:s.data)==null?void 0:t.instance)==null?void 0:n.state)??((_=s==null?void 0:s.instance)==null?void 0:_.state)??(s==null?void 0:s.state)??(s==null?void 0:s.status);return a==="open"||a==="close"||a==="connecting"?a:"unknown"},ce=s=>{var n,_,k,R,F,w,E,L,T,P,D,j,I;const t=[(n=s==null?void 0:s.data)==null?void 0:n.code,(_=s==null?void 0:s.data)==null?void 0:_.base64,(R=(k=s==null?void 0:s.data)==null?void 0:k.qrcode)==null?void 0:R.base64,(F=(w=s==null?void 0:s.data)==null?void 0:w.qrcode)==null?void 0:F.code,(E=s==null?void 0:s.data)==null?void 0:E.qrcode,(L=s==null?void 0:s.qrcode)==null?void 0:L.base64,(T=s==null?void 0:s.qrcode)==null?void 0:T.code,s==null?void 0:s.qrcode,s==null?void 0:s.base64,s==null?void 0:s.code,(D=(P=s==null?void 0:s.data)==null?void 0:P.instance)==null?void 0:D.qrcode,(j=(I=s==null?void 0:s.data)==null?void 0:I.instance)==null?void 0:j.qrcode,(j=s==null?void 0:s.instance)==null?void 0:j.qrcode].find(de=>de!=null);if(typeof t=="string"&&t.trim().length>0)return t;if(t&&typeof t=="object"){const de=t.base64||t.code||t.value||t.qr;return typeof de=="string"&&de.trim().length>0?de:null}return null},Q=s=>{const a=z.current[s];a&&(clearInterval(a),z.current[s]=null);const t=B.current[s];t&&(clearTimeout(t),B.current[s]=null)};m.useEffect(()=>{const s=async()=>{for(const a of S)await U(a.session_name,!0,!0)};s();const a=setInterval(s,1e4);return()=>{clearInterval(a),Object.keys(z.current).forEach(t=>Q(t))}},[S]);const U=async(s,a=!1,t=!1)=>{var k,R,F;console.log(`[WhatsApp] Checking instance status: ${s}`);const n=Date.now(),_=oe.current[s]||0;if(!a&&!t&&n-_<ie){const w=Math.ceil((ie-(n-_))/1e3);return r({title:"Aguarde",description:`Pr√≥xima verifica√ß√£o dispon√≠vel em ${w} segundos`}),((k=S.find(E=>E.session_name===s))==null?void 0:k.connection_status)||"unknown"}f(w=>({...w,[s]:!0})),oe.current[s]=n;try{const w=await g.functions.invoke("whatsapp-evolution",{body:{instanceName:s,action:"status"}});if(w.error){const E=((R=w.error)==null?void 0:R.context)||w.error;throw(E==null?void 0:E.error)==="evolution_server_error"?new Error("Servidor da Evolution API indispon√≠vel. Verifique se o servi√ßo est√° online."):new Error(w.error.message||"Erro ao verificar status")}if((F=w.data)!=null&&F.success){const E=Ae(w.data),L=S.map(T=>T.session_name===s?{...T,connection_status:E}:T);return p.setQueryData(["whatsapp-sessions",u],L),a||r({title:"Status atualizado",description:`Status da sess√£o: ${E==="open"?"Conectado":E==="close"?"Desconectado":"Conectando..."}`}),E}return"unknown"}catch(w){return console.error(`[WhatsApp] Failed to check status for ${s}:`,w),a||r({title:"Erro ao verificar status",description:w instanceof Error?w.message:"N√£o foi poss√≠vel verificar o status da conex√£o",variant:"destructive"}),"unknown"}finally{f(w=>({...w,[s]:!1}))}},ye=async s=>{var a,t;console.log(`[WhatsApp] Ensuring instance exists: ${s}`);try{const n=await g.functions.invoke("whatsapp-evolution",{body:{instanceName:s,action:"status"}});if(n.error||!((a=n.data)!=null&&a.success)){const _=S.find(R=>R.session_name===s);if(!_)throw new Error("Sess√£o n√£o encontrada no banco de dados");const k=await g.functions.invoke("whatsapp-evolution",{body:{sessionName:_.session_name,agentName:_.agent_name,agentPrompt:_.agent_prompt||""}});if(k.error)throw new Error(k.error.message||"Erro ao criar inst√¢ncia")}return!0}catch(n){const _=n==null?void 0:n.context;throw(_==null?void 0:_.error)==="evolution_server_error"||(t=n==null?void 0:n.message)!=null&&t.includes("evolution_server_error")?new Error("Servidor da Evolution API est√° com problemas internos. Verifique se o servi√ßo est√° online."):n}},qe=s=>{Q(s),console.log(`[WhatsApp] Starting status polling for ${s}`),z.current[s]=setInterval(async()=>{const a=await U(s,!0,!0);console.log(`[WhatsApp] Current status for ${s}: ${a}`),a==="open"?(Q(s),d({open:!1,qrCode:"",sessionName:""}),r({title:"Conectado com sucesso!",description:"Sua sess√£o do WhatsApp est√° conectada."}),p.invalidateQueries({queryKey:["whatsapp-sessions"]})):a==="close"&&Q(s)},3e3),B.current[s]=setTimeout(()=>{Q(s),r({title:"Tempo esgotado",description:"O QR Code expirou. Gere um novo QR Code para continuar.",variant:"destructive"})},12e4)},le=async s=>{if(G.current[s]){r({title:"Aguarde",description:"J√° existe uma conex√£o em andamento para esta sess√£o."});return}G.current[s]=!0,console.log(`[WhatsApp] Starting connect flow for ${s}`);try{if(r({title:"Verificando inst√¢ncia",description:"Validando comunica√ß√£o com Evolution API..."}),await ye(s),await U(s,!0,!0)==="open"){r({title:"Sess√£o j√° conectada",description:"Esta sess√£o j√° est√° ativa no WhatsApp."}),p.invalidateQueries({queryKey:["whatsapp-sessions"]});return}r({title:"Gerando QR Code",description:"Aguarde enquanto geramos o QR Code..."});const t=await g.functions.invoke("whatsapp-evolution",{body:{instanceName:s,action:"connect"}});if(t.error)throw new Error(t.error.message||"Falha ao solicitar QR Code");let n=ce(t.data);if(!n){const k=Date.now(),R=3e4;for(;Date.now()-k<R&&!n;){const P=await g.functions.invoke("whatsapp-evolution",{body:{instanceName:s,action:"status"}});n=ce(P.data),n||await new Promise(D=>setTimeout(D,2e3))}}if(!n)throw new Error("QR Code n√£o dispon√≠vel. Tente novamente em alguns segundos.");const _=n.startsWith("data:image")?n:await Le.toDataURL(n,{width:300,margin:2});d({open:!0,qrCode:_,sessionName:s}),qe(s)}catch(a){console.error("[WhatsApp] Connect flow failed:",a);const t=a instanceof Error?a.message:"N√£o foi poss√≠vel gerar o QR Code.",n=t.includes("Evolution API")||t.includes("evolution_server_error");r({title:n?"Servidor Evolution indispon√≠vel":"Erro ao gerar QR Code",description:n?"O servidor da Evolution API est√° fora do ar ou com problemas internos. Reinicie o servi√ßo e tente novamente.":t,variant:"destructive"})}finally{G.current[s]=!1}};return e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsx(K,{className:"border-yellow-500 bg-yellow-50 dark:bg-yellow-950/20",children:e.jsx(H,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ss,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-500 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-yellow-800 dark:text-yellow-200",children:"Limite de verifica√ß√µes de status"}),e.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Para evitar sobrecarga na API, as verifica√ß√µes de status t√™m um intervalo m√≠nimo de 10 segundos entre cada chamada."})]})]})})}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-6 w-6"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Configura√ß√µes WhatsApp"})]}),e.jsxs(A,{onClick:h,children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Nova Sess√£o"]})]}),e.jsxs(Ve,{defaultValue:"sessions",className:"space-y-4",children:[e.jsxs(ze,{className:"grid w-full grid-cols-3",children:[e.jsx(J,{value:"sessions",children:"Sess√µes"}),e.jsx(J,{value:"test",children:"Teste de Envio"}),e.jsx(J,{value:"status",children:"Mensagens de Status"})]}),e.jsx(X,{value:"sessions",children:e.jsx(ts,{sessions:S,isLoading:D,loadingStatus:b,onAddNew:h,onEdit:V,onDelete:s=>c(s),onConnect:le,onCheckStatus:U})}),e.jsx(X,{value:"test",children:e.jsx(ns,{sessions:S})}),e.jsx(X,{value:"status",children:e.jsx(rs,{})})]}),e.jsx(os,{open:N,onOpenChange:j,formData:q,onFormChange:x,onSave:Ne,onCancel:re,isEditing:!!v}),e.jsx(Ge,{open:!!y,onOpenChange:()=>c(null),children:e.jsxs(Be,{children:[e.jsxs(Ue,{children:[e.jsx(Je,{children:"Confirmar exclus√£o"}),e.jsx(Xe,{children:"Tem certeza que deseja remover esta sess√£o do WhatsApp? Esta a√ß√£o n√£o pode ser desfeita."})]}),e.jsxs(Ye,{children:[e.jsx(Ze,{children:"Cancelar"}),e.jsx(es,{onClick:()=>y&&Ee(y),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Remover"})]})]})}),e.jsx(is,{open:o.open,qrCode:o.qrCode,sessionName:o.sessionName,onClose:()=>d({open:!1,qrCode:"",sessionName:""}),onRefresh:le})]})}export{xs as default};
