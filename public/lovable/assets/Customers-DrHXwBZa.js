import{c as X,r as N,u as Y,aV as ee,aZ as se,aH as q,x as y,aW as B,j as e,C as ae,b as te,d as le,B as h,T as L,f as re,P as ne,I as i,a_ as de,a$ as ie,b0 as H,b1 as g,b2 as oe,b3 as f,a7 as ce,M as me,aT as he,aP as xe,b4 as $,ab as ue,ac as pe,ad as je,ae as ge,af as fe,aK as c,a6 as I,V as ve,b5 as Ne,ah as ye,aD as be,aO as Ce}from"./index-v68zVK4x.js";import{C as _e}from"./calendar-xaMh49tc.js";import{S as O}from"./square-pen-Bvg6CdWq.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=X("House",[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"1d0kgt"}]]),w={label:"Casa",is_default:!0,address:"",address_number:"",address_complement:"",neighborhood:"",city:"",state:"",zip_code:""},R=m=>{const A=m.addresses||[],o=A.find(b=>b.is_default)||A[0];if(!o)return"-";let l=[o.address,o.address_number].filter(Boolean).join(", ");return o.neighborhood&&(l+=` - ${o.neighborhood}`),o.city&&(l+=`, ${o.city}`,o.state&&(l+=`/${o.state}`)),l||"-"},K=m=>{if(!m)return null;try{return be(new Date(m),"dd/MM/yy",{locale:Ce})}catch{return null}};function De(){var M,P;const[m,A]=N.useState(""),[o,E]=N.useState(!1),[l,b]=N.useState(null),[r,u]=N.useState({name:"",phone:"",email:"",notes:""}),[d,p]=N.useState([{...w}]),[S,v]=N.useState(null),{toast:C}=Y(),D=ee(),{isAdmin:_}=se(),{data:n}=q({queryKey:["profile"],queryFn:async()=>{const{data:{user:s}}=await y.auth.getUser();if(!s)return null;const{data:a}=await y.from("profiles").select("company_id").eq("id",s.id).single();return a}}),{data:Q=[],isLoading:U}=q({queryKey:["customers",n==null?void 0:n.company_id,_],queryFn:async()=>{if(!(n!=null&&n.company_id))return[];const{data:s,error:a}=await y.from("customers").select("*").eq("company_id",n.company_id).order("name");if(a)throw a;return(s||[]).map(t=>({...t,addresses:Array.isArray(t.addresses)?t.addresses:[]}))},enabled:!!(n!=null&&n.company_id)}),T=B({mutationFn:async()=>{if(!(n!=null&&n.company_id))throw new Error("Company ID not found");const s=d.filter(t=>t.address||t.neighborhood);s.length>0&&!s.some(t=>t.is_default)&&(s[0].is_default=!0);const a={name:r.name,phone:r.phone,email:r.email||null,notes:r.notes||null,addresses:s};if(l){const{error:t}=await y.from("customers").update(a).eq("id",l.id);if(t)throw t}else{const{error:t}=await y.from("customers").insert([{...a,company_id:n.company_id}]);if(t)throw t}},onSuccess:()=>{D.invalidateQueries({queryKey:["customers"]}),C({title:l?"Cliente atualizado":"Cliente cadastrado",description:"Operação realizada com sucesso."}),k()},onError:s=>{C({title:"Erro ao salvar cliente",description:s.message,variant:"destructive"})}}),V=B({mutationFn:async s=>{const{error:a}=await y.from("customers").delete().eq("id",s);if(a)throw a},onSuccess:()=>{D.invalidateQueries({queryKey:["customers"]}),C({title:"Cliente excluído",description:"Cliente removido com sucesso."})},onError:s=>{C({title:"Erro ao excluir cliente",description:s.message,variant:"destructive"})}}),F=s=>{var a;s?(b(s),u({name:s.name,phone:s.phone,email:s.email||"",notes:s.notes||""}),p(((a=s.addresses)==null?void 0:a.length)>0?s.addresses:[{...w}])):(b(null),u({name:"",phone:"",email:"",notes:""}),p([{...w}])),v(null),E(!0)},k=()=>{E(!1),b(null),u({name:"",phone:"",email:"",notes:""}),p([{...w}]),v(null)},J=()=>{if(!r.name||!r.phone){C({title:"Campos obrigatórios",description:"Nome e telefone são obrigatórios.",variant:"destructive"});return}T.mutate()},W=()=>{const s={...w,label:`Endereço ${d.length+1}`,is_default:d.length===0};p([...d,s]),v(d.length)},Z=s=>{const a=d.filter((t,j)=>j!==s);d[s].is_default&&a.length>0&&(a[0].is_default=!0),p(a),v(null)},G=s=>{const a=d.map((t,j)=>({...t,is_default:j===s}));p(a)},x=(s,a,t)=>{const j=[...d];j[s]={...j[s],[a]:t},p(j)},z=Q.filter(s=>{var a;return s.name.toLowerCase().includes(m.toLowerCase())||s.phone.includes(m)||((a=s.email)==null?void 0:a.toLowerCase().includes(m.toLowerCase()))});return e.jsxs("div",{className:"p-6",children:[e.jsxs(ae,{children:[e.jsx(te,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(le,{className:"text-2xl font-bold",children:"Clientes"}),_&&e.jsxs(h,{onClick:()=>F(),children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Novo Cliente"]})]})}),e.jsxs(re,{children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(i,{placeholder:"Buscar por nome, telefone ou email...",value:m,onChange:s=>A(s.target.value),className:"pl-10"})]})}),U?e.jsx("div",{className:"text-center py-8",children:"Carregando..."}):z.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:m?"Nenhum cliente encontrado.":"Nenhum cliente cadastrado."}):e.jsxs(de,{children:[e.jsx(ie,{children:e.jsxs(H,{children:[e.jsx(g,{children:"Nome"}),e.jsx(g,{children:"Telefone"}),e.jsx(g,{children:"Email"}),e.jsx(g,{children:"Endereço"}),e.jsx(g,{children:"Último Pedido"}),e.jsx(g,{className:"text-center",children:"Total"}),e.jsx(g,{className:"text-right",children:"Ações"})]})}),e.jsx(oe,{children:z.map(s=>{var a;return e.jsxs(H,{children:[e.jsx(f,{className:"font-medium",children:s.name}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"h-3 w-3 text-muted-foreground"}),s.phone]})}),e.jsx(f,{children:_?s.email&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{className:"h-3 w-3 text-muted-foreground"}),s.email]}):e.jsx("span",{className:"text-muted-foreground",children:"***@***.com"})}),e.jsx(f,{children:_?e.jsxs("div",{className:"flex items-center gap-1 max-w-[200px]",children:[e.jsx(he,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"truncate",title:R(s),children:R(s)}),((a=s.addresses)==null?void 0:a.length)>1&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["(+",s.addresses.length-1,")"]})]}):e.jsx("span",{className:"text-muted-foreground",children:"***"})}),e.jsx(f,{children:s.last_order_at?e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(_e,{className:"h-3 w-3 text-muted-foreground"}),K(s.last_order_at)]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"-"})}),e.jsx(f,{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(xe,{className:"h-3 w-3 text-muted-foreground"}),s.total_orders||0]})}),e.jsx(f,{className:"text-right",children:_?e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>F(s),title:"Editar",children:e.jsx(O,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>{confirm("Deseja realmente excluir este cliente?")&&V.mutate(s.id)},title:"Excluir",children:e.jsx($,{className:"h-4 w-4 text-destructive"})})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Sem permissão"})})]},s.id)})})]})]})]}),e.jsx(ue,{open:o,onOpenChange:E,children:e.jsxs(pe,{className:"sm:max-w-[500px] md:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(je,{children:[e.jsx(ge,{children:l?"Editar Cliente":"Novo Cliente"}),e.jsx(fe,{children:l?"Atualize as informações do cliente.":"Preencha os dados para cadastrar um novo cliente."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:"Informações Básicas"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"name",children:"Nome *"}),e.jsx(i,{id:"name",value:r.name,onChange:s=>u({...r,name:s.target.value}),placeholder:"Ex: João Silva"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"phone",children:"Telefone *"}),e.jsx(i,{id:"phone",value:r.phone,onChange:s=>u({...r,phone:s.target.value}),placeholder:"(11) 99999-9999"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"email",children:"Email"}),e.jsx(i,{id:"email",type:"email",value:r.email,onChange:s=>u({...r,email:s.target.value}),placeholder:"cliente@exemplo.com"})]})]}),e.jsx(I,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:"Endereços"}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:W,children:[e.jsx(L,{className:"h-4 w-4 mr-1"}),"Adicionar"]})]}),d.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground text-sm border border-dashed rounded-lg",children:"Nenhum endereço cadastrado"}):e.jsx("div",{className:"space-y-3",children:d.map((s,a)=>e.jsxs("div",{className:`border rounded-lg p-4 space-y-3 transition-colors ${S===a?"border-primary bg-muted/30":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.label.toLowerCase().includes("trabalho")?e.jsx(ve,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(we,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(i,{value:s.label,onChange:t=>x(a,"label",t.target.value),className:"h-7 w-32 text-sm font-medium",placeholder:"Ex: Casa"}),s.is_default&&e.jsx("span",{className:"text-xs bg-primary/10 text-primary px-2 py-0.5 rounded",children:"Padrão"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!s.is_default&&e.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:()=>G(a),className:"text-xs",children:"Definir padrão"}),S===a?e.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:()=>v(null),children:"Fechar"}):e.jsx(h,{type:"button",variant:"ghost",size:"icon",onClick:()=>v(a),children:e.jsx(O,{className:"h-4 w-4"})}),d.length>1&&e.jsx(h,{type:"button",variant:"ghost",size:"icon",onClick:()=>Z(a),children:e.jsx($,{className:"h-4 w-4 text-destructive"})})]})]}),S!==a&&(s.address||s.neighborhood)&&e.jsxs("div",{className:"text-sm text-muted-foreground pl-6",children:[[s.address,s.address_number].filter(Boolean).join(", "),s.neighborhood&&` - ${s.neighborhood}`,s.city&&`, ${s.city}`,s.state&&`/${s.state}`]}),S===a&&e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_100px] gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs",children:"Rua"}),e.jsx(i,{value:s.address,onChange:t=>x(a,"address",t.target.value),placeholder:"Ex: Rua das Flores"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs",children:"Número"}),e.jsx(i,{value:s.address_number,onChange:t=>x(a,"address_number",t.target.value),placeholder:"123"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs",children:"Complemento"}),e.jsx(i,{value:s.address_complement||"",onChange:t=>x(a,"address_complement",t.target.value),placeholder:"Apto 45"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs",children:"Bairro"}),e.jsx(i,{value:s.neighborhood,onChange:t=>x(a,"neighborhood",t.target.value),placeholder:"Centro"})]})]}),e.jsxs("div",{className:"grid grid-cols-[1fr_60px_100px] gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs",children:"Cidade"}),e.jsx(i,{value:s.city,onChange:t=>x(a,"city",t.target.value),placeholder:"São Paulo"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs",children:"UF"}),e.jsx(i,{value:s.state,onChange:t=>x(a,"state",t.target.value.toUpperCase()),maxLength:2,placeholder:"SP"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{className:"text-xs",children:"CEP"}),e.jsx(i,{value:s.zip_code||"",onChange:t=>x(a,"zip_code",t.target.value),placeholder:"00000-000"})]})]})]})]},a))})]}),e.jsx(I,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"notes",children:"Observações"}),e.jsx(Ne,{id:"notes",value:r.notes,onChange:s=>u({...r,notes:s.target.value}),rows:3,placeholder:"Observações sobre o cliente..."})]}),l&&e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:"Histórico"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Último pedido"}),e.jsx("div",{className:"font-medium",children:l.last_order_at?e.jsxs(e.Fragment,{children:[((M=l.last_order_data)==null?void 0:M.order_number)&&e.jsxs("span",{className:"text-primary",children:["#",l.last_order_data.order_number]})," ","em ",K(l.last_order_at)]}):e.jsx("span",{className:"text-muted-foreground",children:"Nunca pediu"})})]}),e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Total de pedidos"}),e.jsx("div",{className:"font-medium",children:l.total_orders||0})]})]}),((P=l.last_order_data)==null?void 0:P.items)&&l.last_order_data.items.length>0&&e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-2",children:"Itens do último pedido"}),e.jsx("ul",{className:"text-sm space-y-1",children:l.last_order_data.items.map((s,a)=>e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium",children:[s.quantity,"x"]}),e.jsx("span",{children:s.name})]},a))})]})]})]}),e.jsxs(ye,{children:[e.jsx(h,{variant:"outline",onClick:k,children:"Cancelar"}),e.jsx(h,{onClick:J,disabled:T.isPending,children:l?"Salvar":"Cadastrar"})]})]})})]})}export{De as Customers};
