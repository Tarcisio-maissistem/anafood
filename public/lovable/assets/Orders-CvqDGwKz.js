import{c as ee,j as e,G as ue,aQ as le,S as H,m as U,n as V,p as W,q as G,aR as se,B as A,Q as Me,C as me,z as pe,b as Le,d as ze,H as xe,f as De,a7 as he,aS as fe,ab as ge,ac as je,ad as ve,ae as ye,a6 as z,aT as Fe,aU as be,r as f,R as Be,y as Ke,aK as Qe,u as Ne,aV as He,aH as R,x as C,aW as ce,L as Ue,aX as X,aY as J,aI as Ve,aJ as We}from"./index-DebmrVr5.js";import{T as te,u as Ge,a as Xe}from"./theme-toggle-ChhbzSBS.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=ee("BellOff",[["path",{d:"M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5",key:"o7mx20"}],["path",{d:"M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7",key:"16f1lm"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=ee("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=ee("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),Z=[{id:"pending",title:"Novo",color:"bg-blue-500"},{id:"preparing",title:"Em Preparo",color:"bg-yellow-500"},{id:"ready",title:"Pronto",color:"bg-green-500"},{id:"delivering",title:"Em Entrega",color:"bg-purple-500"},{id:"completed",title:"Concluído",color:"bg-muted"},{id:"cancelled",title:"Cancelado",color:"bg-red-500"}],es={novo:"pending",pendente:"pending",pending:"pending",preparando:"preparing",preparing:"preparing",pronto:"ready",ready:"ready",em_entrega:"delivering",delivering:"delivering",entregando:"delivering",concluido:"completed",concluída:"completed",completed:"completed",cancelado:"cancelled",cancelled:"cancelled"},Y=s=>es[s==null?void 0:s.toLowerCase()]||"pending",ss=(s,l)=>{switch(s){case"pending":return"preparing";case"preparing":return l==="pickup"?"ready":"delivering";case"ready":return"completed";case"delivering":return"completed";default:return s}},ts=["Cliente desistiu","Erro no pedido","Falta de insumos","Endereço incorreto","Cliente não atendeu","Outros"],de=[15,30,45,60,90,120];function as({settings:s,onSettingsChange:l,searchTerm:n,onSearchChange:g,showFilters:j,onToggleFilters:y,selectedOrdersCount:w,onBulkStatusChange:d}){return e.jsxs("div",{className:"sticky top-0 bg-background/95 backdrop-blur-sm z-10 border-b pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx(le,{checked:s.storeOpen,onCheckedChange:r=>l({storeOpen:r})}),e.jsx("span",{className:`text-sm font-medium ${s.storeOpen?"text-success":"text-destructive"}`,children:s.storeOpen?"Aberto":"Fechado"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm",children:"Aceite Automático"}),e.jsx(le,{checked:s.autoAccept,onCheckedChange:r=>l({autoAccept:r})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4"}),e.jsxs(H,{value:String(s.deliveryTime),onValueChange:r=>l({deliveryTime:Number(r)}),children:[e.jsx(U,{className:"w-28 h-8",children:e.jsx(V,{})}),e.jsx(W,{children:de.map(r=>e.jsxs(G,{value:String(r),children:[r," min"]},r))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs(H,{value:String(s.pickupTime),onValueChange:r=>l({pickupTime:Number(r)}),children:[e.jsx(U,{className:"w-28 h-8",children:e.jsx(V,{})}),e.jsx(W,{children:de.map(r=>e.jsxs(G,{value:String(r),children:[r," min"]},r))})]})]}),e.jsx("input",{type:"text",placeholder:"Buscar pedidos...",value:n,onChange:r=>g(r.target.value),className:"text-sm border rounded px-3 py-1 w-48"}),w>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:[w," selecionados"]}),e.jsxs(H,{onValueChange:d,children:[e.jsx(U,{className:"w-40 h-8",children:e.jsx(V,{placeholder:"Alterar status"})}),e.jsx(W,{children:Z.map(r=>e.jsx(G,{value:r.id,children:r.title},r.id))})]})]}),e.jsx(A,{variant:s.soundEnabled?"default":"outline",size:"sm",onClick:()=>l({soundEnabled:!s.soundEnabled}),children:s.soundEnabled?e.jsx(Ye,{className:"w-4 h-4"}):e.jsx(Je,{className:"w-4 h-4"})}),e.jsxs(A,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Me,{className:"w-4 h-4 mr-1"}),"Filtros"]})]}),j&&e.jsxs(me,{className:"mt-3 p-3",children:[e.jsx("h3",{className:"font-semibold mb-2 text-sm",children:"Colunas Visíveis"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:Z.map(r=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pe,{checked:s.visibleColumns[r.id],onCheckedChange:b=>l({visibleColumns:{...s.visibleColumns,[r.id]:b}}),disabled:r.id==="pending"&&s.autoAccept}),e.jsx("label",{className:"text-sm",children:r.title})]},r.id))})]})]})}function ns({order:s,isSelected:l,onSelect:n,onClick:g,onPrint:j,onStatusChange:y,onDragStart:w,onDragEnd:d,alertTime:r,isPrinting:b,onOpenWhatsApp:x}){const u=Math.floor((Date.now()-new Date(s.created_at).getTime())/6e4),q=s.status==="preparing"&&u>=r,P=()=>{const m=ss(s.status,s.type);y(s.id,m,s.status,s)};return e.jsxs(me,{className:`cursor-move hover:shadow-lg transition-all duration-200 ease-out select-none hover:scale-[1.02] ${q?"border-destructive border-2":""} ${s.status==="pending"?"bg-blue-50/50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800 animate-pulse-subtle":""}`,draggable:!0,onDragStart:m=>w(m,s),onDragEnd:d,onClick:g,children:[e.jsxs(Le,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{checked:l,onCheckedChange:n,onClick:m=>m.stopPropagation()}),e.jsxs(ze,{className:"text-sm",children:["#",s.order_number||s.id.slice(0,8)]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[q&&e.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 rounded-full bg-destructive/10 text-destructive",children:[e.jsx(Ze,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs font-medium",children:"Atrasado"})]}),s.status==="preparing"&&e.jsxs("div",{className:`flex items-center gap-1 text-xs ${q?"text-destructive font-medium":"text-muted-foreground"}`,children:[e.jsx(xe,{className:"w-3 h-3"}),u," min"]})]})]}),s.status==="pending"&&e.jsx("div",{className:"flex justify-center mt-2",children:e.jsx("div",{className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-primary/10 to-primary/5 text-primary border border-primary/20",children:s.source==="whatsapp"?"Delivery WhatsApp":s.source==="digital_menu"?"Delivery Cardápio Digital":s.source==="counter"?"Pedido Balcão":s.type==="delivery"?"Delivery Cardápio Digital":"Pedido Balcão"})}),e.jsx("div",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs mt-2 ${s.type==="delivery"?"bg-blue-500/10 text-blue-600 dark:bg-blue-500/20 dark:text-blue-400":"bg-green-500/10 text-green-600 dark:bg-green-500/20 dark:text-green-400"}`,children:s.type==="delivery"?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-3 h-3"}),"Entrega"]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-3 h-3"}),"Retirada"]})})]}),e.jsxs(De,{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.customer_name}),s.customer_phone&&e.jsxs("button",{onClick:m=>{m.stopPropagation(),x(s.customer_phone,s.order_number)},className:"flex items-center gap-1 text-xs text-green-600 hover:underline",children:[e.jsx(he,{className:"w-3 h-3"}),s.customer_phone]})]}),e.jsxs("div",{className:"flex gap-1",children:[s.status!=="pending"&&s.status!=="cancelled"&&e.jsxs(A,{variant:"outline",size:"sm",className:"flex-1 h-7 text-xs",onClick:m=>{m.stopPropagation(),j(s,!0)},disabled:b,children:[e.jsx(fe,{className:"w-3 h-3 mr-1"}),b?"Imprimindo...":"Imprimir"]}),s.status!=="completed"&&s.status!=="cancelled"&&e.jsx(A,{variant:"default",size:"sm",className:"flex-1 h-7 text-xs",onClick:m=>{m.stopPropagation(),P()},children:"Avançar"})]})]})]})}function rs({column:s,orders:l,onDrop:n,onDragOver:g,onCardClick:j,onCardSelect:y,selectedOrders:w,onPrintOrder:d,onUpdateStatus:r,onDragStart:b,onDragEnd:x,alertTime:u,isPrinting:N,isDraggedOver:q,onOpenWhatsApp:P}){return e.jsxs("div",{className:"flex-shrink-0 w-80",onDragOver:g,onDrop:m=>n(m,s.id),children:[e.jsx("div",{className:`${s.color} text-white p-3 rounded-t-lg`,children:e.jsxs("h3",{className:"font-semibold",children:[s.title," (",l.length,")"]})}),e.jsx("div",{className:`bg-card border border-border min-h-[400px] max-h-[calc(100vh-300px)] overflow-y-auto p-2 rounded-b-lg space-y-2 transition-all duration-200 ${q?"bg-primary/5":""}`,children:l.length>0?l.map(m=>e.jsx(ns,{order:m,isSelected:w.has(m.id),onSelect:()=>y(m.id),onClick:()=>j(m),onPrint:d,onStatusChange:r,onDragStart:b,onDragEnd:x,alertTime:u,isPrinting:N,onOpenWhatsApp:P},m.id)):e.jsx("div",{className:"text-center py-8 text-muted-foreground text-sm",children:"Nenhum pedido"})})]})}function is({order:s,open:l,onClose:n,onPrint:g,onCancel:j,onOpenWhatsApp:y,isPrinting:w}){var b,x;if(!s)return null;const d=((b=s.items)==null?void 0:b.reduce((u,N)=>u+(N.price||0)*(N.quantity||0),0))||0,r=d+(s.delivery_fee||0);return e.jsx(ge,{open:l,onOpenChange:n,children:e.jsxs(je,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ve,{children:e.jsxs(ye,{className:"text-xl",children:["Pedido #",s.order_number]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.type==="delivery"?e.jsxs("div",{className:"flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/10 text-blue-600 text-sm",children:[e.jsx(te,{className:"w-4 h-4"}),"Entrega"]}):e.jsxs("div",{className:"flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/10 text-green-600 text-sm",children:[e.jsx(se,{className:"w-4 h-4"}),"Retirada"]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(xe,{className:"w-4 h-4"}),new Date(s.created_at).toLocaleString("pt-BR")]})]}),e.jsx(z,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Cliente"}),e.jsx("p",{className:"text-sm",children:s.customer_name}),s.customer_phone&&e.jsxs("button",{onClick:()=>y(s.customer_phone,s.order_number),className:"flex items-center gap-1 text-sm text-green-600 hover:underline mt-1",children:[e.jsx(he,{className:"w-4 h-4"}),s.customer_phone]}),s.address&&e.jsxs("div",{className:"flex gap-1 text-sm text-muted-foreground mt-1",children:[e.jsx(Fe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.address})]})]}),e.jsx(z,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Itens do Pedido"}),e.jsx("div",{className:"space-y-2",children:(x=s.items)==null?void 0:x.map((u,N)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[u.quantity,"x ",u.name]}),u.observations&&e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:["Obs: ",u.observations]})]}),e.jsxs("p",{className:"font-medium",children:["R$ ",((u.price||0)*(u.quantity||0)).toFixed(2)]})]},N))})]}),e.jsx(z,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["R$ ",d.toFixed(2)]})]}),s.delivery_fee&&s.delivery_fee>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Taxa de entrega:"}),e.jsxs("span",{children:["R$ ",s.delivery_fee.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between font-bold text-lg pt-2 border-t",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["R$ ",r.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Pagamento:"}),e.jsx("span",{className:"capitalize",children:s.payment_method})]})]}),s.observations&&e.jsxs(e.Fragment,{children:[e.jsx(z,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-1",children:"Observações"}),e.jsx("p",{className:"text-sm text-muted-foreground italic",children:s.observations})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[s.status!=="cancelled"&&s.status!=="completed"&&e.jsxs(A,{variant:"destructive",onClick:j,className:"flex-1",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Cancelar Pedido"]}),s.status!=="pending"&&s.status!=="cancelled"&&e.jsxs(A,{variant:"outline",onClick:()=>g(s,!0),disabled:w,className:"flex-1",children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),w?"Imprimindo...":"Reimprimir"]})]})]})]})})}function os({open:s,onClose:l,onConfirm:n,orderNumber:g}){const[j,y]=f.useState(""),w=()=>{j&&(n(j),y(""))};return e.jsx(ge,{open:s,onOpenChange:l,children:e.jsxs(je,{className:"max-w-md",children:[e.jsx(ve,{children:e.jsxs(ye,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5 text-destructive"}),"Cancelar Pedido #",g]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione o motivo do cancelamento:"}),e.jsx(Be,{value:j,onValueChange:y,children:ts.map(d=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ke,{value:d,id:d}),e.jsx(Qe,{htmlFor:d,className:"cursor-pointer",children:d})]},d))}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(A,{variant:"outline",onClick:l,className:"flex-1",children:"Voltar"}),e.jsx(A,{variant:"destructive",onClick:w,disabled:!j,className:"flex-1",children:"Confirmar Cancelamento"})]})]})]})})}function ls(){const{toast:s}=Ne(),l=He(),{companyId:n}=Ge(),[g,j]=f.useState(null),[y,w]=f.useState(!1),[d,r]=f.useState(null),[b,x]=f.useState(new Set),[u,N]=f.useState(""),[q,P]=f.useState(!1),[m,D]=f.useState(null),[M,we]=f.useState(!1),[_e,F]=f.useState(!1),[S,ae]=f.useState({storeOpen:!0,autoAccept:!1,soundEnabled:!0,deliveryTime:30,pickupTime:45,alertTime:10,autoPrint:!0,notificationSound:"/sounds/default-notification.mp3",visibleColumns:{pending:!0,preparing:!0,ready:!0,delivering:!0,completed:!0,cancelled:!1}}),$=f.useCallback(()=>{m&&(m.pause(),m.currentTime=0,D(null))},[m]),{data:B=[],isLoading:Ce}=R({queryKey:["orders",n],queryFn:async()=>n?(console.log("Fetching orders via API for company:",n),(await X.getOrders(n)).data.map(a=>({...a,status:Y(a.status)}))):[],enabled:!!n,refetchInterval:!1,refetchOnWindowFocus:!1}),{data:I}=R({queryKey:["store-settings",n],queryFn:async()=>{if(!n)return null;const{data:t,error:a}=await C.from("store_settings").select("*").eq("company_id",n).single();if(a)throw a;return t},enabled:!!n}),{data:v}=R({queryKey:["company-data",n],queryFn:async()=>{if(!n)return null;const{data:t,error:a}=await C.from("companies").select("*").eq("id",n).single();if(a)throw a;return t},enabled:!!n}),K=I==null?void 0:I.printer_settings,Q=K==null?void 0:K.layout_configs;f.useEffect(()=>{const t=()=>{if(!M){const a=S.notificationSound||"/sounds/default-notification.mp3",o=new Audio(a);o.volume=.01,o.play().then(()=>{o.pause(),o.currentTime=0,we(!0),console.log("✅ Áudio pré-carregado com sucesso:",a)}).catch(()=>{console.log("⏳ Aguardando interação do usuário para áudio")})}};return document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0}),()=>{document.removeEventListener("click",t),document.removeEventListener("keydown",t),document.removeEventListener("touchstart",t)}},[M,S.notificationSound]),f.useEffect(()=>{if(!n)return;const t=C.channel("orders-realtime").on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:`company_id=eq.${n}`},a=>{if(console.log("🔔 Real-time update received:",a),a.eventType==="INSERT"){const o=a.new;if(console.log("🆕 Novo pedido recebido:",o.order_number),$(),S.soundEnabled&&M){const p=S.notificationSound||"/sounds/default-notification.mp3",c=new Audio(p);c.loop=!0,c.volume=.7;const _=c.play();_!==void 0&&_.then(()=>{console.log("✅ Som tocando:",p),D(c)}).catch(O=>{console.error("❌ Erro ao tocar som:",O),s({title:"🔇 Som desabilitado",description:"Clique em qualquer lugar para habilitar notificações sonoras"})}),setTimeout(()=>{c.pause(),c.currentTime=0,D(null)},2e4)}s({title:"🎉 Novo Pedido!",description:`Pedido #${o.order_number} de ${o.customer_name}`})}l.invalidateQueries({queryKey:["orders",n]})}).subscribe(a=>{console.log("🔔 Realtime subscription status:",a)});return()=>{$(),C.removeChannel(t)}},[n,S.soundEnabled,M,l,s,$]),R({queryKey:["store-settings",n],queryFn:async()=>{if(!n)return null;const{data:t}=await C.from("store_settings").select("*").eq("company_id",n).single();if(t){const a=t.visible_columns,o=t.printer_settings;ae({storeOpen:t.store_open??!0,autoAccept:t.auto_accept??!1,soundEnabled:t.sound_enabled??!0,deliveryTime:t.delivery_time??30,pickupTime:t.pickup_time??45,alertTime:t.alert_time??10,autoPrint:(o==null?void 0:o.auto_print)??!0,notificationSound:t.notification_sound??"/sounds/default-notification.mp3",visibleColumns:{pending:(a==null?void 0:a.pending)??!0,preparing:(a==null?void 0:a.preparing)??!0,ready:(a==null?void 0:a.ready)??!0,delivering:(a==null?void 0:a.delivering)??!0,completed:(a==null?void 0:a.completed)??!0,cancelled:(a==null?void 0:a.cancelled)??!1}})}return t},enabled:!!n,refetchInterval:!1,refetchOnWindowFocus:!1});const L=ce({mutationFn:async({orderId:t,status:a,previousStatus:o,order:p,cancellationReason:c})=>{var _;if(!n)throw new Error("Company not found");if(await X.updateOrderStatus(t,a,n),o==="pending"&&a==="preparing"&&p){$();const{data:O}=await C.from("store_settings").select("printer_settings").eq("company_id",n).single(),k=O==null?void 0:O.printer_settings;if((k==null?void 0:k.auto_print)??!0){const{data:i}=await C.from("companies").select("*").eq("id",n).single(),oe=h=>h?typeof h=="string"?h:[h.street&&h.number?`${h.street}, ${h.number}`:h.street,h.complement,h.neighborhood,h.city&&h.state?`${h.city} - ${h.state}`:h.city,h.zip_code?`CEP: ${h.zip_code}`:null].filter(Boolean).join(`
`):"",$e={...p,company_name:(i==null?void 0:i.name)||"EMPRESA",company_fantasy_name:(i==null?void 0:i.fantasy_name)||(i==null?void 0:i.name),company_phone:(i==null?void 0:i.phone)||"",company_address:oe(i==null?void 0:i.address),company_email:(i==null?void 0:i.email)||""},T=(_=k==null?void 0:k.sectors)==null?void 0:_.caixa;T!=null&&T.enabled&&(T!=null&&T.printer_name)&&J.printOrder($e,T.printer_name,!1,"caixa",T.layout,T.copies||1).then(()=>console.log("✅ Impressão automática realizada")).catch(h=>console.error("❌ Erro na impressão automática:",h))}}return{orderId:t,status:a}},onMutate:async({orderId:t,status:a})=>{await l.cancelQueries({queryKey:["orders",n]});const o=l.getQueryData(["orders",n]);return l.setQueryData(["orders",n],p=>p&&p.map(c=>c.id===t?{...c,status:a,updated_at:new Date().toISOString()}:c)),{previousOrders:o}},onSuccess:()=>{s({title:"Status atualizado",description:"O status do pedido foi atualizado com sucesso."})},onError:(t,a,o)=>{o!=null&&o.previousOrders&&l.setQueryData(["orders",n],o.previousOrders),s({title:"Erro",description:"Erro ao atualizar status do pedido.",variant:"destructive"})}}),Se=ce({mutationFn:async t=>{if(!n)throw new Error("Company not found");await X.updateStoreSettings(n,t)},onSuccess:()=>{l.invalidateQueries({queryKey:["store-settings",n]})}}),ne=async(t,a=!1)=>{var o,p;console.log("=".repeat(50)),console.log("🖨️ INÍCIO DO PROCESSO DE IMPRESSÃO"),console.log("Pedido:",t.order_number),console.log("Status atual:",t.status),console.log("Reimpressão:",a),console.log("QZ Tray disponível?",typeof window<"u"&&typeof window.qz<"u"),console.log("Order completo recebido:",{id:t.id,order_number:t.order_number,customer_name:t.customer_name,items_count:(o=t.items)==null?void 0:o.length}),P(!0);try{console.log("Chamando qzPrinter.printOrder...");const c=i=>i?typeof i=="string"?i:[i.street&&i.number?`${i.street}, ${i.number}`:i.street,i.complement,i.neighborhood,i.city&&i.state?`${i.city} - ${i.state}`:i.city,i.zip_code?`CEP: ${i.zip_code}`:null].filter(Boolean).join(`
`):"",_={...t,company_name:(v==null?void 0:v.name)||"EMPRESA",company_fantasy_name:(v==null?void 0:v.fantasy_name)||(v==null?void 0:v.name)||"EMPRESA",company_phone:(v==null?void 0:v.phone)||"",company_address:c(v==null?void 0:v.address),company_email:(v==null?void 0:v.email)||""};console.log("✅ Order enriquecido com dados da empresa:",{hasCompanyName:!!_.company_name,hasCompanyPhone:!!_.company_phone,hasCompanyAddress:!!_.company_address,hasCompanyEmail:!!_.company_email,orderNumber:_.order_number});const O=t.status==="pending"?"caixa":"cozinha_1",k=I==null?void 0:I.printer_settings,E=(p=k==null?void 0:k.sectors)==null?void 0:p[O];if(E!=null&&E.enabled&&(E!=null&&E.printer_name))await J.printOrder(_,E.printer_name,a,O,E.layout,E.copies||1);else{const i=Q==null?void 0:Q[O];await J.printOrder(_,void 0,a,O,i,1)}console.log("✅ Impressão concluída com sucesso!"),s({title:"✅ Impressão enviada",description:a?"Reimpressão enviada para a impressora com sucesso.":"O pedido foi enviado para a impressora com sucesso."})}catch(c){console.error("=".repeat(50)),console.error("❌ ERRO AO IMPRIMIR"),console.error("Tipo do erro:",typeof c),console.error("Erro completo:",c),console.error("Stack:",c==null?void 0:c.stack),console.error("=".repeat(50));const _=(c==null?void 0:c.message)||String(c)||"Erro desconhecido ao imprimir";s({title:"❌ Erro ao imprimir",description:_,variant:"destructive"})}finally{P(!1),console.log("✓ Processo de impressão finalizado"),console.log("=".repeat(50))}},Oe=(t,a)=>{r(a),t.dataTransfer.effectAllowed="move",t.currentTarget instanceof HTMLElement&&(t.currentTarget.style.opacity="0.5")},ke=t=>{r(null),t.currentTarget instanceof HTMLElement&&(t.currentTarget.style.opacity="")},Ee=t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="move"},Te=(t,a)=>{t.preventDefault(),d&&d.status!==a&&L.mutate({orderId:d.id,status:a,previousStatus:d.status,order:d}),r(null)},re=(t,a,o,p,c)=>{L.mutate({orderId:t,status:a,previousStatus:o,order:p,cancellationReason:c})},Ae=t=>{const a=new Set(b);a.has(t)?a.delete(t):a.add(t),x(a)},qe=t=>{b.forEach(a=>{L.mutate({orderId:a,status:t})}),x(new Set)},ie=(t,a)=>{if(!t){s({title:"Telefone não disponível",variant:"destructive"});return}const o=t.replace(/\D/g,""),p=`Olá! Sobre o pedido #${a}, como posso ajudar?`,c=`https://wa.me/55${o}?text=${encodeURIComponent(p)}`;window.open(c,"_blank")};f.useEffect(()=>{S.autoAccept&&B.filter(a=>a.status==="pending").forEach(a=>{re(a.id,"preparing",a.status,a)})},[S.autoAccept,B]);const Pe=t=>{ae(a=>({...a,...t})),Se.mutate(t)},Ie=t=>{g&&(L.mutate({orderId:g.id,status:"cancelled",cancellationReason:t}),F(!1),j(null))},Re=B.filter(t=>{var o,p,c;if(!u)return!0;const a=u.toLowerCase();return((o=t.order_number)==null?void 0:o.toLowerCase().includes(a))||((p=t.customer_name)==null?void 0:p.toLowerCase().includes(a))||((c=t.customer_phone)==null?void 0:c.includes(u))});return Ce?e.jsxs("div",{className:"flex items-center justify-center h-screen",children:[e.jsx(Ue,{className:"w-8 h-8 animate-spin"}),e.jsx("span",{className:"ml-3 text-lg",children:"Carregando pedidos..."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(as,{settings:S,onSettingsChange:Pe,searchTerm:u,onSearchChange:N,showFilters:y,onToggleFilters:()=>w(!y),selectedOrdersCount:b.size,onBulkStatusChange:qe}),e.jsx("div",{className:"flex gap-4 overflow-x-auto pb-4 min-h-[500px]",children:Z.filter(t=>t.id==="pending"&&S.autoAccept?!1:S.visibleColumns[t.id]).map(t=>{const a=Re.filter(p=>Y(p.status)===t.id),o=d&&Y(d.status)!==t.id;return e.jsx(rs,{column:t,orders:a,onDrop:Te,onDragOver:Ee,onCardClick:p=>{$(),j(p)},onCardSelect:Ae,selectedOrders:b,onPrintOrder:ne,onUpdateStatus:re,onDragStart:Oe,onDragEnd:ke,alertTime:S.alertTime,isPrinting:q,isDraggedOver:!!o,onOpenWhatsApp:ie},t.id)})}),e.jsx(is,{order:g,open:!!g,onClose:()=>j(null),onPrint:ne,onCancel:()=>F(!0),onOpenWhatsApp:ie,isPrinting:q}),e.jsx(os,{open:_e,onClose:()=>F(!1),onConfirm:Ie,orderNumber:(g==null?void 0:g.order_number)||""})]})}function ms(){const{toast:s}=Ne(),[l,n]=f.useState(!0),[g,j]=f.useState(""),[y,w]=f.useState(""),[d,r]=f.useState(null);R({queryKey:["company-info"],queryFn:async()=>{const{data:{user:x}}=await C.auth.getUser();if(!x)return null;const{data:u}=await C.from("profiles").select("role, company_id").eq("id",x.id).single(),{data:N}=await C.from("companies").select("*").eq("id",u==null?void 0:u.company_id).single();return N&&(j(N.fantasy_name||N.name),w(N.subdomain),r(N.id)),N}}),R({queryKey:["store-settings",d],queryFn:async()=>{if(!d)return null;const{data:x}=await C.from("store_settings").select("*").eq("company_id",d).single();return x&&n(x.store_open||!1),x},enabled:!!d});const b=async()=>{if(d)try{const x=!l,{error:u}=await C.from("store_settings").update({store_open:x}).eq("company_id",d);if(u)throw u;n(x),s({title:x?"Loja Aberta":"Loja Fechada",description:x?"Sua loja está agora aberta e recebendo pedidos.":"Sua loja está fechada e não receberá novos pedidos."})}catch{s({title:"Erro",description:"Não foi possível alterar o status da loja.",variant:"destructive"})}};return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx("header",{className:"bg-card/50 backdrop-blur border-b border-border sticky top-0 z-10",children:e.jsx("div",{className:"px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ve,{children:e.jsx(We,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold",children:"Gestão de Pedidos"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y?`${y}.anafood.vip`:"Configure seu domínio"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{}),e.jsxs(A,{variant:l?"default":"destructive",size:"sm",onClick:b,children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),l?"Loja Aberta":"Loja Fechada"]})]})]})})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx("div",{className:"h-full p-6",children:e.jsx(ls,{})})})]})}export{ms as default};

