import{c as Z,u as ee,aV as se,r as x,aH as M,x as n,aW as L,j as e,aI as ae,aw as re,C as ie,b as oe,d as te,e as ne,B as f,f as le,P as ce,I as T,a_ as de,a$ as me,b0 as V,b1 as v,b2 as ue,b3 as N,aj as U,b4 as he,ab as xe,ac as je,ad as pe,ae as fe,af as ge,aK as A,S as ve,m as Ne,n as ye,p as we,q as z,N as B,ah as be,o as Ce,s as H,bS as Se}from"./index-v68zVK4x.js";import{A as Ee,a as _e,b as De,c as Te,d as Ue,e as Ae,f as ke,g as Ie}from"./alert-dialog-DWcOo5bl.js";import{U as Pe}from"./user-plus-BPCiXlW2.js";import{S as qe}from"./square-pen-Bvg6CdWq.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=Z("CircleUser",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}],["path",{d:"M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662",key:"154egf"}]]),Oe=Ce({email:H().email({message:"Email inválido"}),fullName:H().min(3,{message:"Nome deve ter no mínimo 3 caracteres"}),role:Se(["company_admin","company_staff"],{errorMap:()=>({message:"Role inválido"})})});function Be(){const{toast:j}=ee(),k=se(),[g,R]=x.useState(""),[K,y]=x.useState(!1),[G,w]=x.useState(!1),[o,p]=x.useState(null),[c,d]=x.useState({email:"",fullName:"",role:"company_staff"}),[m,b]=x.useState({}),{data:a}=M({queryKey:["profile"],queryFn:async()=>{const{data:{user:s}}=await n.auth.getUser();if(!s)throw new Error("User not found");const{data:i,error:r}=await n.from("profiles").select("company_id, id").eq("id",s.id).single();if(r)throw r;return i}}),{data:I=[],isLoading:$}=M({queryKey:["company-users",a==null?void 0:a.company_id],queryFn:async()=>{if(!(a!=null&&a.company_id))return[];const{data:s,error:i}=await n.from("user_roles").select("user_id, role").eq("company_id",a.company_id);if(i)throw i;if(!s||s.length===0)return[];const r=s.map(u=>u.user_id),{data:l,error:t}=await n.from("profiles").select("id, full_name").in("id",r);if(t)throw t;const{data:{users:E},error:F}=await n.auth.admin.listUsers();return F&&console.error("Error fetching auth users:",F),s.map(u=>{const _=l==null?void 0:l.find(D=>D.id===u.user_id),h=E==null?void 0:E.find(D=>D.id===u.user_id);return{id:u.user_id,email:(h==null?void 0:h.email)||"Email não disponível",full_name:(_==null?void 0:_.full_name)||null,role:u.role,created_at:(h==null?void 0:h.created_at)||new Date().toISOString()}})},enabled:!!(a!=null&&a.company_id)}),P=I.filter(s=>{var i;return((i=s.full_name)==null?void 0:i.toLowerCase().includes(g.toLowerCase()))||s.email.toLowerCase().includes(g.toLowerCase())}),C=L({mutationFn:async s=>{var r,l;if(!(a!=null&&a.company_id))throw new Error("Company ID not found");const{data:{session:i}}=await n.auth.getSession();if(!i)throw new Error("Sessão não encontrada");if(s.userId){const t=await n.functions.invoke("user-management",{body:{userId:s.userId,fullName:s.fullName,role:s.role},headers:{"Content-Type":"application/json"},method:"POST"});if(t.error)throw new Error(t.error.message);if((r=t.data)!=null&&r.error)throw new Error(t.data.error)}else{const t=await n.functions.invoke("user-management",{body:{email:s.email,fullName:s.fullName,role:s.role,companyId:a.company_id},headers:{"Content-Type":"application/json"},method:"POST"});if(t.error)throw new Error(t.error.message);if((l=t.data)!=null&&l.error)throw new Error(t.data.error)}},onSuccess:()=>{k.invalidateQueries({queryKey:["company-users"]}),j({title:"Sucesso",description:o?"Usuário atualizado com sucesso":"Usuário criado com sucesso! Um email de confirmação foi enviado para o novo usuário."}),O()},onError:s=>{console.error("Error saving user:",s),j({title:"Erro",description:s.message||"Erro ao salvar usuário",variant:"destructive"})}}),S=L({mutationFn:async s=>{var l;if(s===(a==null?void 0:a.id))throw new Error("Você não pode excluir sua própria conta");const{data:{session:i}}=await n.auth.getSession();if(!i)throw new Error("Sessão não encontrada");const r=await n.functions.invoke("user-management",{body:{userId:s,currentUserId:a==null?void 0:a.id},headers:{"Content-Type":"application/json"},method:"POST"});if(r.error)throw new Error(r.error.message);if((l=r.data)!=null&&l.error)throw new Error(r.data.error)},onSuccess:()=>{k.invalidateQueries({queryKey:["company-users"]}),j({title:"Sucesso",description:"Usuário excluído com sucesso"}),w(!1),p(null)},onError:s=>{console.error("Error deleting user:",s),j({title:"Erro",description:s.message||"Erro ao excluir usuário",variant:"destructive"})}}),q=s=>{s?(p(s),d({email:s.email,fullName:s.full_name||"",role:s.role})):(p(null),d({email:"",fullName:"",role:"company_staff"})),b({}),y(!0)},O=()=>{y(!1),p(null),d({email:"",fullName:"",role:"company_staff"}),b({})},J=()=>{const s=Oe.safeParse(c);if(!s.success){const i={};s.error.errors.forEach(r=>{r.path[0]&&(i[r.path[0]]=r.message)}),b(i);return}C.mutate({...c,userId:o==null?void 0:o.id})},W=s=>{if(s.id===(a==null?void 0:a.id)){j({title:"Ação não permitida",description:"Você não pode excluir sua própria conta",variant:"destructive"});return}p(s),w(!0)},X=()=>{o&&S.mutate(o.id)},Y=s=>s==="company_admin"?e.jsxs(U,{variant:"default",className:"gap-1",children:[e.jsx(B,{className:"w-3 h-3"})," Admin"]}):e.jsx(U,{variant:"secondary",children:"Usuário"});return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx("header",{className:"bg-card/50 backdrop-blur border-b border-border sticky top-0 z-10",children:e.jsx("div",{className:"px-4 py-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ae,{className:"lg:hidden"}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(re,{className:"w-6 h-6"}),"Gerenciamento de Usuários"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Gerencie os usuários e permissões da sua empresa"})]})]})})})}),e.jsx("div",{className:"flex-1 overflow-auto p-6",children:e.jsxs(ie,{children:[e.jsx(oe,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx(te,{children:"Usuários da Empresa"}),e.jsxs(ne,{children:[I.length," usuário(s) cadastrado(s)"]})]}),e.jsxs(f,{onClick:()=>q(),className:"gap-2",children:[e.jsx(Pe,{className:"w-4 h-4"}),"Adicionar Usuário"]})]})}),e.jsxs(le,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(T,{placeholder:"Buscar por nome ou email...",value:g,onChange:s=>R(s.target.value),className:"pl-10"})]})}),$?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Carregando usuários..."}):P.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:g?"Nenhum usuário encontrado":"Nenhum usuário cadastrado"}):e.jsx("div",{className:"rounded-md border",children:e.jsxs(de,{children:[e.jsx(me,{children:e.jsxs(V,{children:[e.jsx(v,{children:"Usuário"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Role"}),e.jsx(v,{className:"text-right",children:"Ações"})]})}),e.jsx(ue,{children:P.map(s=>e.jsxs(V,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:s.full_name||"Sem nome"}),s.id===(a==null?void 0:a.id)&&e.jsx(U,{variant:"outline",className:"text-xs",children:"Você"})]})}),e.jsx(N,{className:"text-muted-foreground",children:s.email}),e.jsx(N,{children:Y(s.role)}),e.jsx(N,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>q(s),title:"Editar",children:e.jsx(qe,{className:"w-4 h-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>W(s),disabled:s.id===(a==null?void 0:a.id),title:s.id===(a==null?void 0:a.id)?"Não pode excluir a si mesmo":"Excluir",className:"text-destructive hover:text-destructive",children:e.jsx(he,{className:"w-4 h-4"})})]})})]},s.id))})]})})]})]})}),e.jsx(xe,{open:K,onOpenChange:y,children:e.jsxs(je,{className:"sm:max-w-[500px]",children:[e.jsxs(pe,{children:[e.jsx(fe,{children:o?"Editar Usuário":"Novo Usuário"}),e.jsx(ge,{children:o?"Atualize as informações do usuário.":"Preencha os dados para criar um novo usuário."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"email",children:"Email *"}),e.jsx(T,{id:"email",type:"email",placeholder:"usuario@exemplo.com",value:c.email,onChange:s=>d({...c,email:s.target.value}),disabled:!!o}),m.email&&e.jsx("p",{className:"text-sm text-destructive",children:m.email})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"fullName",children:"Nome Completo *"}),e.jsx(T,{id:"fullName",placeholder:"João Silva",value:c.fullName,onChange:s=>d({...c,fullName:s.target.value})}),m.fullName&&e.jsx("p",{className:"text-sm text-destructive",children:m.fullName})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"role",children:"Permissão *"}),e.jsxs(ve,{value:c.role,onValueChange:s=>d({...c,role:s}),children:[e.jsx(Ne,{children:e.jsx(ye,{placeholder:"Selecione uma permissão"})}),e.jsxs(we,{children:[e.jsx(z,{value:"company_admin",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Admin"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Acesso total ao sistema"})]})]})}),e.jsx(z,{value:"company_staff",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Usuário"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Acesso limitado ao sistema"})]})]})})]})]}),m.role&&e.jsx("p",{className:"text-sm text-destructive",children:m.role})]})]}),e.jsxs(be,{children:[e.jsx(f,{variant:"outline",onClick:O,children:"Cancelar"}),e.jsx(f,{onClick:J,disabled:C.isPending,children:C.isPending?"Salvando...":o?"Salvar":"Criar"})]})]})}),e.jsx(Ee,{open:G,onOpenChange:w,children:e.jsxs(_e,{children:[e.jsxs(De,{children:[e.jsx(Te,{children:"Tem certeza?"}),e.jsxs(Ue,{children:["Esta ação não pode ser desfeita. O usuário ",e.jsx("strong",{children:o==null?void 0:o.full_name})," será removido permanentemente do sistema."]})]}),e.jsxs(Ae,{children:[e.jsx(ke,{children:"Cancelar"}),e.jsx(Ie,{onClick:X,className:"bg-destructive hover:bg-destructive/90",disabled:S.isPending,children:S.isPending?"Excluindo...":"Excluir"})]})]})})]})}export{Be as default};
