import{c as Q,u as P,aV as U,aH as T,aW as N,x as f,av as D,r as F,j as i,ab as B,ac as $,ad as W,ae as Y,bY as R,aK as L,I as Z,S as X,m as ee,n as te,L as M,p as re,q as ae,A as ne,B as K,aw as se,ah as oe}from"./index-v68zVK4x.js";import{u as A}from"./useCompanyId-BPuD7pC1.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=Q("CircleDot",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=Q("LayoutGrid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=Q("UtensilsCrossed",[["path",{d:"m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8",key:"n7qcjb"}],["path",{d:"M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7",key:"d0u48b"}],["path",{d:"m2.1 21.8 6.4-6.3",key:"yn04lh"}],["path",{d:"m19 5-7 7",key:"194lzd"}]]);function xe(){const{companyId:e}=A(),{toast:n}=P(),t=U(),{data:s,isLoading:r,error:o}=T({queryKey:["pdv-settings",e],queryFn:async()=>{if(!e)return null;const{data:d,error:b}=await f.from("pdv_settings").select("*").eq("company_id",e).single();if(b){if(b.code==="PGRST116"){const{data:_,error:p}=await f.from("pdv_settings").insert({company_id:e}).select().single();if(p)throw p;return _}throw b}return d},enabled:!!e}),m=N({mutationFn:async d=>{if(!e)throw new Error("Company ID not found");const{data:b,error:_}=await f.from("pdv_settings").update(d).eq("company_id",e).select().single();if(_)throw _;return b},onSuccess:()=>{t.invalidateQueries({queryKey:["pdv-settings",e]}),n({title:"Configurações atualizadas",description:"As configurações do PDV foram salvas."})},onError:d=>{n({title:"Erro ao salvar",description:"Não foi possível atualizar as configurações.",variant:"destructive"}),console.error("Error updating PDV settings:",d)}});return{settings:s,isLoading:r,error:o,updateSettings:m.mutate,isUpdating:m.isPending}}const z=e=>{let n;const t=new Set,s=(_,p)=>{const c=typeof _=="function"?_(n):_;if(!Object.is(c,n)){const g=n;n=p??(typeof c!="object"||c===null)?c:Object.assign({},n,c),t.forEach(l=>l(n,g))}},r=()=>n,d={setState:s,getState:r,getInitialState:()=>b,subscribe:_=>(t.add(_),()=>t.delete(_))},b=n=e(s,r,d);return d},ie=e=>e?z(e):z,ce=e=>e;function ue(e,n=ce){const t=D.useSyncExternalStore(e.subscribe,D.useCallback(()=>n(e.getState()),[e,n]),D.useCallback(()=>n(e.getInitialState()),[e,n]));return D.useDebugValue(t),t}const G=e=>{const n=ie(e),t=s=>ue(n,s);return Object.assign(t,n),t},le=e=>e?G(e):G;function de(e,n){let t;try{t=e()}catch{return}return{getItem:r=>{var o;const m=b=>b===null?null:JSON.parse(b,void 0),d=(o=t.getItem(r))!=null?o:null;return d instanceof Promise?d.then(m):m(d)},setItem:(r,o)=>t.setItem(r,JSON.stringify(o,void 0)),removeItem:r=>t.removeItem(r)}}const O=e=>n=>{try{const t=e(n);return t instanceof Promise?t:{then(s){return O(s)(t)},catch(s){return this}}}catch(t){return{then(s){return this},catch(s){return O(s)(t)}}}},me=(e,n)=>(t,s,r)=>{let o={storage:de(()=>window.localStorage),partialize:u=>u,version:0,merge:(u,h)=>({...h,...u}),...n},m=!1,d=0;const b=new Set,_=new Set;let p=o.storage;if(!p)return e((...u)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),t(...u)},s,r);const c=()=>{const u=o.partialize({...s()});return p.setItem(o.name,{state:u,version:o.version})},g=r.setState;r.setState=(u,h)=>(g(u,h),c());const l=e((...u)=>(t(...u),c()),s,r);r.getInitialState=()=>l;let v;const q=()=>{var u,h;if(!p)return;const S=++d;m=!1,b.forEach(w=>{var C;return w((C=s())!=null?C:l)});const I=((h=o.onRehydrateStorage)==null?void 0:h.call(o,(u=s())!=null?u:l))||void 0;return O(p.getItem.bind(p))(o.name).then(w=>{if(w)if(typeof w.version=="number"&&w.version!==o.version){if(o.migrate){const C=o.migrate(w.state,w.version);return C instanceof Promise?C.then(a=>[!0,a]):[!0,C]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,w.state];return[!1,void 0]}).then(w=>{var C;if(S!==d)return;const[a,y]=w;if(v=o.merge(y,(C=s())!=null?C:l),t(v,!0),a)return c()}).then(()=>{S===d&&(I==null||I(v,void 0),v=s(),m=!0,_.forEach(w=>w(v)))}).catch(w=>{S===d&&(I==null||I(void 0,w))})};return r.persist={setOptions:u=>{o={...o,...u},u.storage&&(p=u.storage)},clearStorage:()=>{p==null||p.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>q(),hasHydrated:()=>m,onHydrate:u=>(b.add(u),()=>{b.delete(u)}),onFinishHydration:u=>(_.add(u),()=>{_.delete(u)})},o.skipHydration||q(),v||l},he=me,_e=()=>`cart_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,J={type:"counter",source:"pdv"},V=le()(he((e,n)=>({cart:[],context:J,subtotal:0,discount_amount:0,discount_percent:0,service_amount:0,service_percent:0,couvert_amount:0,delivery_fee:0,total:0,cash_register_id:void 0,operator_id:void 0,operator_name:void 0,addItem:t=>{const s=_e(),r=t.unit_price*t.quantity+t.extras_total-(t.discount_amount||0);e(o=>({cart:[...o.cart,{...t,id:s,total_price:r}]})),n().calculateTotals()},updateItem:(t,s)=>{e(r=>({cart:r.cart.map(o=>{if(o.id!==t)return o;const m={...o,...s};return m.total_price=m.unit_price*m.quantity+m.extras_total-(m.discount_amount||0),m})})),n().calculateTotals()},removeItem:t=>{e(s=>({cart:s.cart.filter(r=>r.id!==t)})),n().calculateTotals()},clearCart:()=>{e({cart:[],subtotal:0,discount_amount:0,discount_percent:0,service_amount:0,couvert_amount:0,delivery_fee:0,total:0})},setContext:t=>{e(s=>({context:{...s.context,...t}})),n().calculateTotals()},resetContext:()=>{e({context:J,delivery_fee:0}),n().calculateTotals()},setDiscount:(t,s)=>{e({discount_amount:t,discount_percent:s||0}),n().calculateTotals()},setService:t=>{e({service_percent:t}),n().calculateTotals()},setCouvert:t=>{e({couvert_amount:t}),n().calculateTotals()},setDeliveryFee:t=>{e({delivery_fee:t}),n().calculateTotals()},setSession:(t,s,r)=>{e({cash_register_id:t,operator_id:s,operator_name:r})},clearSession:()=>{e({cash_register_id:void 0,operator_id:void 0,operator_name:void 0})},calculateTotals:()=>{const t=n(),s=t.cart.reduce((m,d)=>m+d.total_price,0),r=s*(t.service_percent/100),o=s+r+t.couvert_amount+t.delivery_fee-t.discount_amount;e({subtotal:s,service_amount:r,total:Math.max(0,o)})}}),{name:"anafood-pos-store",partialize:e=>({cart:e.cart,context:e.context,cash_register_id:e.cash_register_id,operator_id:e.operator_id,operator_name:e.operator_name})}));function pe(){const{companyId:e}=A(),{toast:n}=P(),t=U(),{cart:s,context:r,subtotal:o,service_amount:m,service_percent:d,discount_amount:b,couvert_amount:_,delivery_fee:p,total:c,clearCart:g,resetContext:l}=V(),{data:v=[],isLoading:q}=T({queryKey:["checks-open",e],queryFn:async()=>{if(!e)return[];const{data:a,error:y}=await f.from("checks").select(`
          *,
          check_items(count),
          tables(table_number, name)
        `).eq("company_id",e).in("status",["open","partial"]).order("created_at",{ascending:!1});if(y)throw y;return a},enabled:!!e}),u=a=>T({queryKey:["check",a],queryFn:async()=>{if(!a)return null;const{data:y,error:k}=await f.from("checks").select(`
          *,
          items:check_items(*),
          payments:check_payments(*),
          table:tables(*)
        `).eq("id",a).single();if(k)throw k;return y},enabled:!!a}),h=N({mutationFn:async a=>{if(!e)throw new Error("Company ID not found");const{data:y}=await f.auth.getUser();if(!y.user)throw new Error("User not authenticated");const{data:k,error:E}=await f.rpc("get_next_check_number",{p_company_id:e});if(E)throw E;const j={company_id:e,check_number:k,opened_by:y.user.id,type:(a==null?void 0:a.type)||r.type||"counter",source:r.source||"pdv",table_id:(a==null?void 0:a.table_id)||r.table_id,customer_name:(a==null?void 0:a.customer_name)||r.customer_name,customer_phone:(a==null?void 0:a.customer_phone)||r.customer_phone,waiter_id:(a==null?void 0:a.waiter_id)||r.waiter_id,waiter_name:(a==null?void 0:a.waiter_name)||r.waiter_name,guest_count:(a==null?void 0:a.guest_count)||1,notes:a==null?void 0:a.notes,status:"open",address:r.address,address_number:r.address_number,address_complement:r.address_complement,neighborhood:r.neighborhood,city:r.city,state:r.state,zip_code:r.zip_code,delivery_fee:r.delivery_fee||p,estimated_time:r.estimated_time},{data:x,error:H}=await f.from("checks").insert(j).select().single();if(H)throw H;return x},onSuccess:a=>(t.invalidateQueries({queryKey:["checks-open",e]}),t.invalidateQueries({queryKey:["tables-with-status",e]}),a),onError:a=>{n({title:"Erro ao criar comanda",description:"Não foi possível criar a comanda.",variant:"destructive"}),console.error("Error creating check:",a)}}),S=N({mutationFn:async a=>{if(!e)throw new Error("Company ID not found");const{data:y}=await f.auth.getUser();if(!y.user)throw new Error("User not authenticated");const k=s.map(x=>({check_id:a,company_id:e,created_by:y.user.id,product_id:x.product_id,product_name:x.product_name,product_sku:x.product_sku,unit_price:x.unit_price,quantity:x.quantity,extras:JSON.parse(JSON.stringify(x.extras)),extras_total:x.extras_total,notes:x.notes,promotion_id:x.promotion_id,discount_amount:x.discount_amount,total_price:x.total_price,status:"pending"})),{data:E,error:j}=await f.from("check_items").insert(k).select();if(j)throw j;return E},onSuccess:(a,y)=>{t.invalidateQueries({queryKey:["check",y]}),t.invalidateQueries({queryKey:["checks-open",e]}),g(),n({title:"Itens adicionados",description:"Os itens foram adicionados à comanda."})},onError:a=>{n({title:"Erro ao adicionar itens",description:"Não foi possível adicionar os itens.",variant:"destructive"}),console.error("Error adding items:",a)}}),I=N({mutationFn:async a=>{const{data:y,error:k}=await f.from("checks").update({subtotal:o,service_percent:d,service_amount:m,discount_amount:b,couvert_amount:_,delivery_fee:p,total_amount:c}).eq("id",a).select().single();if(k)throw k;return y},onSuccess:(a,y)=>{t.invalidateQueries({queryKey:["check",y]})}}),w=N({mutationFn:async a=>{var j;const{data:y}=await f.auth.getUser(),{data:k,error:E}=await f.from("checks").update({status:"closed",closed_at:new Date().toISOString(),closed_by:(j=y.user)==null?void 0:j.id,paid_at:new Date().toISOString()}).eq("id",a).select().single();if(E)throw E;return k},onSuccess:()=>{t.invalidateQueries({queryKey:["checks-open",e]}),t.invalidateQueries({queryKey:["tables-with-status",e]}),l(),n({title:"Comanda fechada",description:"A comanda foi encerrada com sucesso."})},onError:a=>{n({title:"Erro ao fechar comanda",description:"Não foi possível fechar a comanda.",variant:"destructive"}),console.error("Error closing check:",a)}}),C=N({mutationFn:async({checkId:a,reason:y})=>{var x;const{data:k}=await f.auth.getUser(),{data:E,error:j}=await f.from("checks").update({status:"cancelled",cancelled_at:new Date().toISOString(),cancelled_by:(x=k.user)==null?void 0:x.id,cancel_reason:y}).eq("id",a).select().single();if(j)throw j;return E},onSuccess:()=>{t.invalidateQueries({queryKey:["checks-open",e]}),t.invalidateQueries({queryKey:["tables-with-status",e]}),n({title:"Comanda cancelada",description:"A comanda foi cancelada."})}});return{openChecks:v,isLoading:q,useCheck:u,createCheck:h.mutateAsync,addItemsToCheck:S.mutate,addItemsToCheckAsync:S.mutateAsync,updateCheckTotals:I.mutate,updateCheckTotalsAsync:I.mutateAsync,closeCheck:w.mutate,closeCheckAsync:w.mutateAsync,cancelCheck:C.mutate,isCreating:h.isPending,isAddingItems:S.isPending}}function ke(){const{companyId:e}=A(),{toast:n}=P(),t=U(),{data:s=[]}=T({queryKey:["table-areas",e],queryFn:async()=>{if(!e)return[];const{data:c,error:g}=await f.from("table_areas").select("*").eq("company_id",e).eq("is_active",!0).order("sort_order",{ascending:!0});if(g)throw g;return c},enabled:!!e}),{data:r=[],isLoading:o}=T({queryKey:["tables-with-status",e],queryFn:async()=>{if(!e)return[];const{data:c,error:g}=await f.from("v_tables_with_checks").select("*").eq("company_id",e).eq("is_active",!0).order("table_number",{ascending:!0});if(g){const{data:l,error:v}=await f.from("tables").select("*, table_areas(name)").eq("company_id",e).eq("is_active",!0).order("table_number",{ascending:!0});if(v)throw v;return l.map(q=>{var u;return{...q,area_name:(u=q.table_areas)==null?void 0:u.name,active_check:null,check_items_count:0,check_total:0,idle_minutes:0,idle_color:null,open_checks_count:0,current_total:0,minutes_idle:0}})}return c.map(l=>({...l,check_total:l.current_total||0,idle_minutes:l.minutes_idle||0,check_items_count:l.open_checks_count||0,active_check:l.open_checks_count>0?{id:l.id,status:"open"}:null}))},enabled:!!e,refetchInterval:3e4}),m=N({mutationFn:async c=>{if(!e)throw new Error("Company ID not found");const{data:g,error:l}=await f.from("tables").insert({company_id:e,...c}).select().single();if(l)throw l;return g},onSuccess:()=>{t.invalidateQueries({queryKey:["tables-with-status",e]}),n({title:"Mesa criada",description:"A mesa foi criada com sucesso."})},onError:c=>{n({title:"Erro ao criar mesa",description:"Não foi possível criar a mesa.",variant:"destructive"}),console.error("Error creating table:",c)}}),d=N({mutationFn:async({id:c,...g})=>{const{data:l,error:v}=await f.from("tables").update(g).eq("id",c).select().single();if(v)throw v;return l},onSuccess:()=>{t.invalidateQueries({queryKey:["tables-with-status",e]})}}),b=N({mutationFn:async({id:c,status:g})=>{const{data:l,error:v}=await f.from("tables").update({status:g}).eq("id",c).select().single();if(v)throw v;return l},onSuccess:()=>{t.invalidateQueries({queryKey:["tables-with-status",e]})}}),_=s.map(c=>({area:c,tables:r.filter(g=>g.area_id===c.id)})),p=r.filter(c=>!c.area_id);return{tables:r,areas:s,tablesByArea:_,tablesWithoutArea:p,isLoading:o,createTable:m.mutate,updateTable:d.mutate,updateTableStatus:b.mutate,isCreating:m.isPending}}function ye(){const{companyId:e}=A(),{data:n=[],isLoading:t}=T({queryKey:["waiters",e],queryFn:async()=>{if(!e)return[];const{data:s,error:r}=await f.from("waiters").select("*").eq("company_id",e).eq("is_active",!0).order("name",{ascending:!0});if(r)throw r;return s},enabled:!!e});return{waiters:n,isLoading:t}}function Se({open:e,onOpenChange:n,table:t,onSuccess:s}){const{waiters:r,isLoading:o}=ye(),{createCheck:m,isCreating:d}=pe(),{setContext:b}=V(),[_,p]=F.useState(""),[c,g]=F.useState(""),[l,v]=F.useState(1);F.useEffect(()=>{e&&(p(""),g(""),v(1))},[e]);const q=async()=>{if(t)try{const h=r.find(I=>I.id===c),S=await m({table_id:t.id,waiter_id:c||void 0,waiter_name:h==null?void 0:h.name,guest_count:l,notes:_||void 0});b({type:"table",table_id:t.id,table_number:parseInt(String(t.table_number))||0,check_id:S.id,check_number:S.check_number,waiter_id:c||void 0,waiter_name:h==null?void 0:h.name}),n(!1),s(S.id)}catch(h){console.error("Error opening check:",h)}},u=()=>{d||n(!1)};return i.jsx(B,{open:e,onOpenChange:u,children:i.jsxs($,{className:"sm:max-w-md",children:[i.jsx(W,{children:i.jsxs(Y,{className:"flex items-center gap-2",children:[i.jsx(R,{className:"w-5 h-5"}),"Abrir Comanda - Mesa ",(t==null?void 0:t.table_number)||(t==null?void 0:t.name)]})}),i.jsxs("div",{className:"space-y-4 py-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx(L,{htmlFor:"identification",children:"Identificação (opcional)"}),i.jsx(Z,{id:"identification",placeholder:"Nome do cliente ou referência",value:_,onChange:h=>p(h.target.value),onKeyDown:h=>h.key==="Enter"&&q()}),i.jsx("p",{className:"text-xs text-muted-foreground",children:"Se não informado, a comanda será identificada pelo número."})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(L,{htmlFor:"waiter",children:"Garçom"}),i.jsxs(X,{value:c,onValueChange:g,children:[i.jsx(ee,{id:"waiter",children:i.jsx(te,{placeholder:"Selecione o garçom",children:o&&i.jsx(M,{className:"w-4 h-4 animate-spin"})})}),i.jsxs(re,{children:[r.map(h=>i.jsx(ae,{value:h.id,children:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(ne,{className:"w-4 h-4"}),h.name]})},h.id)),r.length===0&&!o&&i.jsx("div",{className:"p-2 text-sm text-muted-foreground text-center",children:"Nenhum garçom cadastrado"})]})]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(L,{children:"Quantidade de Pessoas"}),i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(K,{type:"button",variant:"outline",size:"icon",onClick:()=>v(Math.max(1,l-1)),disabled:l<=1,children:"-"}),i.jsxs("div",{className:"flex items-center gap-2 min-w-[80px] justify-center",children:[i.jsx(se,{className:"w-4 h-4 text-muted-foreground"}),i.jsx("span",{className:"text-lg font-semibold",children:l})]}),i.jsx(K,{type:"button",variant:"outline",size:"icon",onClick:()=>v(l+1),children:"+"})]})]})]}),i.jsxs(oe,{className:"gap-2 sm:gap-0",children:[i.jsx(K,{variant:"outline",onClick:u,disabled:d,children:"Voltar"}),i.jsx(K,{onClick:q,disabled:d,children:d?i.jsxs(i.Fragment,{children:[i.jsx(M,{className:"w-4 h-4 mr-2 animate-spin"}),"Abrindo..."]}):i.jsxs(i.Fragment,{children:[i.jsx(R,{className:"w-4 h-4 mr-2"}),"Abrir Comanda"]})})]})]})})}export{ve as C,be as L,Se as O,we as U,pe as a,V as b,ke as c,xe as u};
