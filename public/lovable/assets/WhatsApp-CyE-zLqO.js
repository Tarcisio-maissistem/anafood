import{c as ce,u as le,j as r,C as de,b as Be,d as Pe,e as Me,f as ue,a8 as Ke,B as k,a_ as vt,a$ as xt,b0 as We,b1 as Z,b2 as Et,b3 as X,b4 as Nt,aj as H,aV as Oe,r as T,aH as Je,aW as _e,bD as ze,aK as W,L as qe,S as At,m as _t,n as bt,p as jt,q as $e,I as be,b5 as Re,x as I,aQ as St,ab as Ye,ac as Ge,ad as Ze,ae as Xe,af as et,ah as tt,T as It,a2 as Tt,a3 as Bt,a4 as we,a5 as ye}from"./index-DebmrVr5.js";import{R as nt}from"./refresh-cw-XJNswtV8.js";import{P as Pt,S as Mt}from"./save-DA3_K57Z.js";import{A as Rt,a as kt,b as Dt,c as Lt,d as Ft,e as Ut,f as Wt,g as zt}from"./alert-dialog-9XA5iY7m.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=ce("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=ce("CircleCheck",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=ce("QrCode",[["rect",{width:"5",height:"5",x:"3",y:"3",rx:"1",key:"1tu5fj"}],["rect",{width:"5",height:"5",x:"16",y:"3",rx:"1",key:"1v8r4q"}],["rect",{width:"5",height:"5",x:"3",y:"16",rx:"1",key:"1x03jg"}],["path",{d:"M21 16h-3a2 2 0 0 0-2 2v3",key:"177gqh"}],["path",{d:"M21 21v.01",key:"ents32"}],["path",{d:"M12 7v3a2 2 0 0 1-2 2H7",key:"8crl2c"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M12 3h.01",key:"n36tog"}],["path",{d:"M12 16v.01",key:"133mhm"}],["path",{d:"M16 12h1",key:"1slzba"}],["path",{d:"M21 12v.01",key:"1lwtk9"}],["path",{d:"M12 21v-1",key:"1880an"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=ce("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);var ne={},Vt=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then},st={},D={};let ke;const Ht=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];D.getSymbolSize=function(t){if(!t)throw new Error('"version" cannot be null or undefined');if(t<1||t>40)throw new Error('"version" should be in range from 1 to 40');return t*4+17};D.getSymbolTotalCodewords=function(t){return Ht[t]};D.getBCHDigit=function(e){let t=0;for(;e!==0;)t++,e>>>=1;return t};D.setToSJISFunction=function(t){if(typeof t!="function")throw new Error('"toSJISFunc" is not a valid function.');ke=t};D.isKanjiModeEnabled=function(){return typeof ke<"u"};D.toSJIS=function(t){return ke(t)};var fe={};(function(e){e.L={bit:1},e.M={bit:0},e.Q={bit:3},e.H={bit:2};function t(a){if(typeof a!="string")throw new Error("Param is not a string");switch(a.toLowerCase()){case"l":case"low":return e.L;case"m":case"medium":return e.M;case"q":case"quartile":return e.Q;case"h":case"high":return e.H;default:throw new Error("Unknown EC Level: "+a)}}e.isValid=function(n){return n&&typeof n.bit<"u"&&n.bit>=0&&n.bit<4},e.from=function(n,s){if(e.isValid(n))return n;try{return t(n)}catch{return s}}})(fe);function ot(){this.buffer=[],this.length=0}ot.prototype={get:function(e){const t=Math.floor(e/8);return(this.buffer[t]>>>7-e%8&1)===1},put:function(e,t){for(let a=0;a<t;a++)this.putBit((e>>>t-a-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(e){const t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),e&&(this.buffer[t]|=128>>>this.length%8),this.length++}};var Kt=ot;function se(e){if(!e||e<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=e,this.data=new Uint8Array(e*e),this.reservedBit=new Uint8Array(e*e)}se.prototype.set=function(e,t,a,n){const s=e*this.size+t;this.data[s]=a,n&&(this.reservedBit[s]=!0)};se.prototype.get=function(e,t){return this.data[e*this.size+t]};se.prototype.xor=function(e,t,a){this.data[e*this.size+t]^=a};se.prototype.isReserved=function(e,t){return this.reservedBit[e*this.size+t]};var Ot=se,at={};(function(e){const t=D.getSymbolSize;e.getRowColCoords=function(n){if(n===1)return[];const s=Math.floor(n/7)+2,o=t(n),i=o===145?26:Math.ceil((o-13)/(2*s-2))*2,c=[o-7];for(let l=1;l<s-1;l++)c[l]=c[l-1]-i;return c.push(6),c.reverse()},e.getPositions=function(n){const s=[],o=e.getRowColCoords(n),i=o.length;for(let c=0;c<i;c++)for(let l=0;l<i;l++)c===0&&l===0||c===0&&l===i-1||c===i-1&&l===0||s.push([o[c],o[l]]);return s}})(at);var rt={};const Jt=D.getSymbolSize,Qe=7;rt.getPositions=function(t){const a=Jt(t);return[[0,0],[a-Qe,0],[0,a-Qe]]};var it={};(function(e){e.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const t={N1:3,N2:3,N3:40,N4:10};e.isValid=function(s){return s!=null&&s!==""&&!isNaN(s)&&s>=0&&s<=7},e.from=function(s){return e.isValid(s)?parseInt(s,10):void 0},e.getPenaltyN1=function(s){const o=s.size;let i=0,c=0,l=0,u=null,d=null;for(let C=0;C<o;C++){c=l=0,u=d=null;for(let p=0;p<o;p++){let h=s.get(C,p);h===u?c++:(c>=5&&(i+=t.N1+(c-5)),u=h,c=1),h=s.get(p,C),h===d?l++:(l>=5&&(i+=t.N1+(l-5)),d=h,l=1)}c>=5&&(i+=t.N1+(c-5)),l>=5&&(i+=t.N1+(l-5))}return i},e.getPenaltyN2=function(s){const o=s.size;let i=0;for(let c=0;c<o-1;c++)for(let l=0;l<o-1;l++){const u=s.get(c,l)+s.get(c,l+1)+s.get(c+1,l)+s.get(c+1,l+1);(u===4||u===0)&&i++}return i*t.N2},e.getPenaltyN3=function(s){const o=s.size;let i=0,c=0,l=0;for(let u=0;u<o;u++){c=l=0;for(let d=0;d<o;d++)c=c<<1&2047|s.get(u,d),d>=10&&(c===1488||c===93)&&i++,l=l<<1&2047|s.get(d,u),d>=10&&(l===1488||l===93)&&i++}return i*t.N3},e.getPenaltyN4=function(s){let o=0;const i=s.data.length;for(let l=0;l<i;l++)o+=s.data[l];return Math.abs(Math.ceil(o*100/i/5)-10)*t.N4};function a(n,s,o){switch(n){case e.Patterns.PATTERN000:return(s+o)%2===0;case e.Patterns.PATTERN001:return s%2===0;case e.Patterns.PATTERN010:return o%3===0;case e.Patterns.PATTERN011:return(s+o)%3===0;case e.Patterns.PATTERN100:return(Math.floor(s/2)+Math.floor(o/3))%2===0;case e.Patterns.PATTERN101:return s*o%2+s*o%3===0;case e.Patterns.PATTERN110:return(s*o%2+s*o%3)%2===0;case e.Patterns.PATTERN111:return(s*o%3+(s+o)%2)%2===0;default:throw new Error("bad maskPattern:"+n)}}e.applyMask=function(s,o){const i=o.size;for(let c=0;c<i;c++)for(let l=0;l<i;l++)o.isReserved(l,c)||o.xor(l,c,a(s,l,c))},e.getBestMask=function(s,o){const i=Object.keys(e.Patterns).length;let c=0,l=1/0;for(let u=0;u<i;u++){o(u),e.applyMask(u,s);const d=e.getPenaltyN1(s)+e.getPenaltyN2(s)+e.getPenaltyN3(s)+e.getPenaltyN4(s);e.applyMask(u,s),d<l&&(l=d,c=u)}return c}})(it);var he={};const $=fe,oe=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],ae=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];he.getBlocksCount=function(t,a){switch(a){case $.L:return oe[(t-1)*4+0];case $.M:return oe[(t-1)*4+1];case $.Q:return oe[(t-1)*4+2];case $.H:return oe[(t-1)*4+3];default:return}};he.getTotalCodewordsCount=function(t,a){switch(a){case $.L:return ae[(t-1)*4+0];case $.M:return ae[(t-1)*4+1];case $.Q:return ae[(t-1)*4+2];case $.H:return ae[(t-1)*4+3];default:return}};var ct={},ge={};const ee=new Uint8Array(512),re=new Uint8Array(256);(function(){let t=1;for(let a=0;a<255;a++)ee[a]=t,re[t]=a,t<<=1,t&256&&(t^=285);for(let a=255;a<512;a++)ee[a]=ee[a-255]})();ge.log=function(t){if(t<1)throw new Error("log("+t+")");return re[t]};ge.exp=function(t){return ee[t]};ge.mul=function(t,a){return t===0||a===0?0:ee[re[t]+re[a]]};(function(e){const t=ge;e.mul=function(n,s){const o=new Uint8Array(n.length+s.length-1);for(let i=0;i<n.length;i++)for(let c=0;c<s.length;c++)o[i+c]^=t.mul(n[i],s[c]);return o},e.mod=function(n,s){let o=new Uint8Array(n);for(;o.length-s.length>=0;){const i=o[0];for(let l=0;l<s.length;l++)o[l]^=t.mul(s[l],i);let c=0;for(;c<o.length&&o[c]===0;)c++;o=o.slice(c)}return o},e.generateECPolynomial=function(n){let s=new Uint8Array([1]);for(let o=0;o<n;o++)s=e.mul(s,new Uint8Array([1,t.exp(o)]));return s}})(ct);const lt=ct;function De(e){this.genPoly=void 0,this.degree=e,this.degree&&this.initialize(this.degree)}De.prototype.initialize=function(t){this.degree=t,this.genPoly=lt.generateECPolynomial(this.degree)};De.prototype.encode=function(t){if(!this.genPoly)throw new Error("Encoder not initialized");const a=new Uint8Array(t.length+this.degree);a.set(t);const n=lt.mod(a,this.genPoly),s=this.degree-n.length;if(s>0){const o=new Uint8Array(this.degree);return o.set(n,s),o}return n};var Yt=De,dt={},Q={},Le={};Le.isValid=function(t){return!isNaN(t)&&t>=1&&t<=40};var U={};const ut="[0-9]+",Gt="[A-Z $%*+\\-./:]+";let te="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";te=te.replace(/u/g,"\\u");const Zt="(?:(?![A-Z0-9 $%*+\\-./:]|"+te+`)(?:.|[\r
]))+`;U.KANJI=new RegExp(te,"g");U.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g");U.BYTE=new RegExp(Zt,"g");U.NUMERIC=new RegExp(ut,"g");U.ALPHANUMERIC=new RegExp(Gt,"g");const Xt=new RegExp("^"+te+"$"),en=new RegExp("^"+ut+"$"),tn=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");U.testKanji=function(t){return Xt.test(t)};U.testNumeric=function(t){return en.test(t)};U.testAlphanumeric=function(t){return tn.test(t)};(function(e){const t=Le,a=U;e.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},e.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},e.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},e.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},e.MIXED={bit:-1},e.getCharCountIndicator=function(o,i){if(!o.ccBits)throw new Error("Invalid mode: "+o);if(!t.isValid(i))throw new Error("Invalid version: "+i);return i>=1&&i<10?o.ccBits[0]:i<27?o.ccBits[1]:o.ccBits[2]},e.getBestModeForData=function(o){return a.testNumeric(o)?e.NUMERIC:a.testAlphanumeric(o)?e.ALPHANUMERIC:a.testKanji(o)?e.KANJI:e.BYTE},e.toString=function(o){if(o&&o.id)return o.id;throw new Error("Invalid mode")},e.isValid=function(o){return o&&o.bit&&o.ccBits};function n(s){if(typeof s!="string")throw new Error("Param is not a string");switch(s.toLowerCase()){case"numeric":return e.NUMERIC;case"alphanumeric":return e.ALPHANUMERIC;case"kanji":return e.KANJI;case"byte":return e.BYTE;default:throw new Error("Unknown mode: "+s)}}e.from=function(o,i){if(e.isValid(o))return o;try{return n(o)}catch{return i}}})(Q);(function(e){const t=D,a=he,n=fe,s=Q,o=Le,i=7973,c=t.getBCHDigit(i);function l(p,h,v){for(let w=1;w<=40;w++)if(h<=e.getCapacity(w,v,p))return w}function u(p,h){return s.getCharCountIndicator(p,h)+4}function d(p,h){let v=0;return p.forEach(function(w){const E=u(w.mode,h);v+=E+w.getBitsLength()}),v}function C(p,h){for(let v=1;v<=40;v++)if(d(p,v)<=e.getCapacity(v,h,s.MIXED))return v}e.from=function(h,v){return o.isValid(h)?parseInt(h,10):v},e.getCapacity=function(h,v,w){if(!o.isValid(h))throw new Error("Invalid QR Code version");typeof w>"u"&&(w=s.BYTE);const E=t.getSymbolTotalCodewords(h),y=a.getTotalCodewordsCount(h,v),x=(E-y)*8;if(w===s.MIXED)return x;const f=x-u(w,h);switch(w){case s.NUMERIC:return Math.floor(f/10*3);case s.ALPHANUMERIC:return Math.floor(f/11*2);case s.KANJI:return Math.floor(f/13);case s.BYTE:default:return Math.floor(f/8)}},e.getBestVersionForData=function(h,v){let w;const E=n.from(v,n.M);if(Array.isArray(h)){if(h.length>1)return C(h,E);if(h.length===0)return 1;w=h[0]}else w=h;return l(w.mode,w.getLength(),E)},e.getEncodedBits=function(h){if(!o.isValid(h)||h<7)throw new Error("Invalid QR Code version");let v=h<<12;for(;t.getBCHDigit(v)-c>=0;)v^=i<<t.getBCHDigit(v)-c;return h<<12|v}})(dt);var ft={};const je=D,ht=1335,nn=21522,Ve=je.getBCHDigit(ht);ft.getEncodedBits=function(t,a){const n=t.bit<<3|a;let s=n<<10;for(;je.getBCHDigit(s)-Ve>=0;)s^=ht<<je.getBCHDigit(s)-Ve;return(n<<10|s)^nn};var gt={};const sn=Q;function K(e){this.mode=sn.NUMERIC,this.data=e.toString()}K.getBitsLength=function(t){return 10*Math.floor(t/3)+(t%3?t%3*3+1:0)};K.prototype.getLength=function(){return this.data.length};K.prototype.getBitsLength=function(){return K.getBitsLength(this.data.length)};K.prototype.write=function(t){let a,n,s;for(a=0;a+3<=this.data.length;a+=3)n=this.data.substr(a,3),s=parseInt(n,10),t.put(s,10);const o=this.data.length-a;o>0&&(n=this.data.substr(a),s=parseInt(n,10),t.put(s,o*3+1))};var on=K;const an=Q,ve=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function O(e){this.mode=an.ALPHANUMERIC,this.data=e}O.getBitsLength=function(t){return 11*Math.floor(t/2)+6*(t%2)};O.prototype.getLength=function(){return this.data.length};O.prototype.getBitsLength=function(){return O.getBitsLength(this.data.length)};O.prototype.write=function(t){let a;for(a=0;a+2<=this.data.length;a+=2){let n=ve.indexOf(this.data[a])*45;n+=ve.indexOf(this.data[a+1]),t.put(n,11)}this.data.length%2&&t.put(ve.indexOf(this.data[a]),6)};var rn=O;const cn=Q;function J(e){this.mode=cn.BYTE,typeof e=="string"?this.data=new TextEncoder().encode(e):this.data=new Uint8Array(e)}J.getBitsLength=function(t){return t*8};J.prototype.getLength=function(){return this.data.length};J.prototype.getBitsLength=function(){return J.getBitsLength(this.data.length)};J.prototype.write=function(e){for(let t=0,a=this.data.length;t<a;t++)e.put(this.data[t],8)};var ln=J;const dn=Q,un=D;function Y(e){this.mode=dn.KANJI,this.data=e}Y.getBitsLength=function(t){return t*13};Y.prototype.getLength=function(){return this.data.length};Y.prototype.getBitsLength=function(){return Y.getBitsLength(this.data.length)};Y.prototype.write=function(e){let t;for(t=0;t<this.data.length;t++){let a=un.toSJIS(this.data[t]);if(a>=33088&&a<=40956)a-=33088;else if(a>=57408&&a<=60351)a-=49472;else throw new Error("Invalid SJIS character: "+this.data[t]+`
Make sure your charset is UTF-8`);a=(a>>>8&255)*192+(a&255),e.put(a,13)}};var fn=Y,mt={exports:{}};(function(e){var t={single_source_shortest_paths:function(a,n,s){var o={},i={};i[n]=0;var c=t.PriorityQueue.make();c.push(n,0);for(var l,u,d,C,p,h,v,w,E;!c.empty();){l=c.pop(),u=l.value,C=l.cost,p=a[u]||{};for(d in p)p.hasOwnProperty(d)&&(h=p[d],v=C+h,w=i[d],E=typeof i[d]>"u",(E||w>v)&&(i[d]=v,c.push(d,v),o[d]=u))}if(typeof s<"u"&&typeof i[s]>"u"){var y=["Could not find a path from ",n," to ",s,"."].join("");throw new Error(y)}return o},extract_shortest_path_from_predecessor_list:function(a,n){for(var s=[],o=n;o;)s.push(o),a[o],o=a[o];return s.reverse(),s},find_path:function(a,n,s){var o=t.single_source_shortest_paths(a,n,s);return t.extract_shortest_path_from_predecessor_list(o,s)},PriorityQueue:{make:function(a){var n=t.PriorityQueue,s={},o;a=a||{};for(o in n)n.hasOwnProperty(o)&&(s[o]=n[o]);return s.queue=[],s.sorter=a.sorter||n.default_sorter,s},default_sorter:function(a,n){return a.cost-n.cost},push:function(a,n){var s={value:a,cost:n};this.queue.push(s),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};e.exports=t})(mt);var hn=mt.exports;(function(e){const t=Q,a=on,n=rn,s=ln,o=fn,i=U,c=D,l=hn;function u(y){return unescape(encodeURIComponent(y)).length}function d(y,x,f){const g=[];let N;for(;(N=y.exec(f))!==null;)g.push({data:N[0],index:N.index,mode:x,length:N[0].length});return g}function C(y){const x=d(i.NUMERIC,t.NUMERIC,y),f=d(i.ALPHANUMERIC,t.ALPHANUMERIC,y);let g,N;return c.isKanjiModeEnabled()?(g=d(i.BYTE,t.BYTE,y),N=d(i.KANJI,t.KANJI,y)):(g=d(i.BYTE_KANJI,t.BYTE,y),N=[]),x.concat(f,g,N).sort(function(B,P){return B.index-P.index}).map(function(B){return{data:B.data,mode:B.mode,length:B.length}})}function p(y,x){switch(x){case t.NUMERIC:return a.getBitsLength(y);case t.ALPHANUMERIC:return n.getBitsLength(y);case t.KANJI:return o.getBitsLength(y);case t.BYTE:return s.getBitsLength(y)}}function h(y){return y.reduce(function(x,f){const g=x.length-1>=0?x[x.length-1]:null;return g&&g.mode===f.mode?(x[x.length-1].data+=f.data,x):(x.push(f),x)},[])}function v(y){const x=[];for(let f=0;f<y.length;f++){const g=y[f];switch(g.mode){case t.NUMERIC:x.push([g,{data:g.data,mode:t.ALPHANUMERIC,length:g.length},{data:g.data,mode:t.BYTE,length:g.length}]);break;case t.ALPHANUMERIC:x.push([g,{data:g.data,mode:t.BYTE,length:g.length}]);break;case t.KANJI:x.push([g,{data:g.data,mode:t.BYTE,length:u(g.data)}]);break;case t.BYTE:x.push([{data:g.data,mode:t.BYTE,length:u(g.data)}])}}return x}function w(y,x){const f={},g={start:{}};let N=["start"];for(let b=0;b<y.length;b++){const B=y[b],P=[];for(let F=0;F<B.length;F++){const M=B[F],z=""+b+F;P.push(z),f[z]={node:M,lastCount:0},g[z]={};for(let G=0;G<N.length;G++){const L=N[G];f[L]&&f[L].node.mode===M.mode?(g[L][z]=p(f[L].lastCount+M.length,M.mode)-p(f[L].lastCount,M.mode),f[L].lastCount+=M.length):(f[L]&&(f[L].lastCount=M.length),g[L][z]=p(M.length,M.mode)+4+t.getCharCountIndicator(M.mode,x))}}N=P}for(let b=0;b<N.length;b++)g[N[b]].end=0;return{map:g,table:f}}function E(y,x){let f;const g=t.getBestModeForData(y);if(f=t.from(x,g),f!==t.BYTE&&f.bit<g.bit)throw new Error('"'+y+'" cannot be encoded with mode '+t.toString(f)+`.
 Suggested mode is: `+t.toString(g));switch(f===t.KANJI&&!c.isKanjiModeEnabled()&&(f=t.BYTE),f){case t.NUMERIC:return new a(y);case t.ALPHANUMERIC:return new n(y);case t.KANJI:return new o(y);case t.BYTE:return new s(y)}}e.fromArray=function(x){return x.reduce(function(f,g){return typeof g=="string"?f.push(E(g,null)):g.data&&f.push(E(g.data,g.mode)),f},[])},e.fromString=function(x,f){const g=C(x,c.isKanjiModeEnabled()),N=v(g),b=w(N,f),B=l.find_path(b.map,"start","end"),P=[];for(let F=1;F<B.length-1;F++)P.push(b.table[B[F]].node);return e.fromArray(h(P))},e.rawSplit=function(x){return e.fromArray(C(x,c.isKanjiModeEnabled()))}})(gt);const me=D,xe=fe,gn=Kt,mn=Ot,pn=at,wn=rt,Se=it,Ie=he,yn=Yt,ie=dt,Cn=ft,vn=Q,Ee=gt;function xn(e,t){const a=e.size,n=wn.getPositions(t);for(let s=0;s<n.length;s++){const o=n[s][0],i=n[s][1];for(let c=-1;c<=7;c++)if(!(o+c<=-1||a<=o+c))for(let l=-1;l<=7;l++)i+l<=-1||a<=i+l||(c>=0&&c<=6&&(l===0||l===6)||l>=0&&l<=6&&(c===0||c===6)||c>=2&&c<=4&&l>=2&&l<=4?e.set(o+c,i+l,!0,!0):e.set(o+c,i+l,!1,!0))}}function En(e){const t=e.size;for(let a=8;a<t-8;a++){const n=a%2===0;e.set(a,6,n,!0),e.set(6,a,n,!0)}}function Nn(e,t){const a=pn.getPositions(t);for(let n=0;n<a.length;n++){const s=a[n][0],o=a[n][1];for(let i=-2;i<=2;i++)for(let c=-2;c<=2;c++)i===-2||i===2||c===-2||c===2||i===0&&c===0?e.set(s+i,o+c,!0,!0):e.set(s+i,o+c,!1,!0)}}function An(e,t){const a=e.size,n=ie.getEncodedBits(t);let s,o,i;for(let c=0;c<18;c++)s=Math.floor(c/3),o=c%3+a-8-3,i=(n>>c&1)===1,e.set(s,o,i,!0),e.set(o,s,i,!0)}function Ne(e,t,a){const n=e.size,s=Cn.getEncodedBits(t,a);let o,i;for(o=0;o<15;o++)i=(s>>o&1)===1,o<6?e.set(o,8,i,!0):o<8?e.set(o+1,8,i,!0):e.set(n-15+o,8,i,!0),o<8?e.set(8,n-o-1,i,!0):o<9?e.set(8,15-o-1+1,i,!0):e.set(8,15-o-1,i,!0);e.set(n-8,8,1,!0)}function _n(e,t){const a=e.size;let n=-1,s=a-1,o=7,i=0;for(let c=a-1;c>0;c-=2)for(c===6&&c--;;){for(let l=0;l<2;l++)if(!e.isReserved(s,c-l)){let u=!1;i<t.length&&(u=(t[i]>>>o&1)===1),e.set(s,c-l,u),o--,o===-1&&(i++,o=7)}if(s+=n,s<0||a<=s){s-=n,n=-n;break}}}function bn(e,t,a){const n=new gn;a.forEach(function(l){n.put(l.mode.bit,4),n.put(l.getLength(),vn.getCharCountIndicator(l.mode,e)),l.write(n)});const s=me.getSymbolTotalCodewords(e),o=Ie.getTotalCodewordsCount(e,t),i=(s-o)*8;for(n.getLengthInBits()+4<=i&&n.put(0,4);n.getLengthInBits()%8!==0;)n.putBit(0);const c=(i-n.getLengthInBits())/8;for(let l=0;l<c;l++)n.put(l%2?17:236,8);return jn(n,e,t)}function jn(e,t,a){const n=me.getSymbolTotalCodewords(t),s=Ie.getTotalCodewordsCount(t,a),o=n-s,i=Ie.getBlocksCount(t,a),c=n%i,l=i-c,u=Math.floor(n/i),d=Math.floor(o/i),C=d+1,p=u-d,h=new yn(p);let v=0;const w=new Array(i),E=new Array(i);let y=0;const x=new Uint8Array(e.buffer);for(let B=0;B<i;B++){const P=B<l?d:C;w[B]=x.slice(v,v+P),E[B]=h.encode(w[B]),v+=P,y=Math.max(y,P)}const f=new Uint8Array(n);let g=0,N,b;for(N=0;N<y;N++)for(b=0;b<i;b++)N<w[b].length&&(f[g++]=w[b][N]);for(N=0;N<p;N++)for(b=0;b<i;b++)f[g++]=E[b][N];return f}function Sn(e,t,a,n){let s;if(Array.isArray(e))s=Ee.fromArray(e);else if(typeof e=="string"){let u=t;if(!u){const d=Ee.rawSplit(e);u=ie.getBestVersionForData(d,a)}s=Ee.fromString(e,u||40)}else throw new Error("Invalid data");const o=ie.getBestVersionForData(s,a);if(!o)throw new Error("The amount of data is too big to be stored in a QR Code");if(!t)t=o;else if(t<o)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+o+`.
`);const i=bn(t,a,s),c=me.getSymbolSize(t),l=new mn(c);return xn(l,t),En(l),Nn(l,t),Ne(l,a,0),t>=7&&An(l,t),_n(l,i),isNaN(n)&&(n=Se.getBestMask(l,Ne.bind(null,l,a))),Se.applyMask(n,l),Ne(l,a,n),{modules:l,version:t,errorCorrectionLevel:a,maskPattern:n,segments:s}}st.create=function(t,a){if(typeof t>"u"||t==="")throw new Error("No input text");let n=xe.M,s,o;return typeof a<"u"&&(n=xe.from(a.errorCorrectionLevel,xe.M),s=ie.from(a.version),o=Se.from(a.maskPattern),a.toSJISFunc&&me.setToSJISFunction(a.toSJISFunc)),Sn(t,s,n,o)};var pt={},Fe={};(function(e){function t(a){if(typeof a=="number"&&(a=a.toString()),typeof a!="string")throw new Error("Color should be defined as hex string");let n=a.slice().replace("#","").split("");if(n.length<3||n.length===5||n.length>8)throw new Error("Invalid hex color: "+a);(n.length===3||n.length===4)&&(n=Array.prototype.concat.apply([],n.map(function(o){return[o,o]}))),n.length===6&&n.push("F","F");const s=parseInt(n.join(""),16);return{r:s>>24&255,g:s>>16&255,b:s>>8&255,a:s&255,hex:"#"+n.slice(0,6).join("")}}e.getOptions=function(n){n||(n={}),n.color||(n.color={});const s=typeof n.margin>"u"||n.margin===null||n.margin<0?4:n.margin,o=n.width&&n.width>=21?n.width:void 0,i=n.scale||4;return{width:o,scale:o?4:i,margin:s,color:{dark:t(n.color.dark||"#000000ff"),light:t(n.color.light||"#ffffffff")},type:n.type,rendererOpts:n.rendererOpts||{}}},e.getScale=function(n,s){return s.width&&s.width>=n+s.margin*2?s.width/(n+s.margin*2):s.scale},e.getImageWidth=function(n,s){const o=e.getScale(n,s);return Math.floor((n+s.margin*2)*o)},e.qrToImageData=function(n,s,o){const i=s.modules.size,c=s.modules.data,l=e.getScale(i,o),u=Math.floor((i+o.margin*2)*l),d=o.margin*l,C=[o.color.light,o.color.dark];for(let p=0;p<u;p++)for(let h=0;h<u;h++){let v=(p*u+h)*4,w=o.color.light;if(p>=d&&h>=d&&p<u-d&&h<u-d){const E=Math.floor((p-d)/l),y=Math.floor((h-d)/l);w=C[c[E*i+y]?1:0]}n[v++]=w.r,n[v++]=w.g,n[v++]=w.b,n[v]=w.a}}})(Fe);(function(e){const t=Fe;function a(s,o,i){s.clearRect(0,0,o.width,o.height),o.style||(o.style={}),o.height=i,o.width=i,o.style.height=i+"px",o.style.width=i+"px"}function n(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}e.render=function(o,i,c){let l=c,u=i;typeof l>"u"&&(!i||!i.getContext)&&(l=i,i=void 0),i||(u=n()),l=t.getOptions(l);const d=t.getImageWidth(o.modules.size,l),C=u.getContext("2d"),p=C.createImageData(d,d);return t.qrToImageData(p.data,o,l),a(C,u,d),C.putImageData(p,0,0),u},e.renderToDataURL=function(o,i,c){let l=c;typeof l>"u"&&(!i||!i.getContext)&&(l=i,i=void 0),l||(l={});const u=e.render(o,i,l),d=l.type||"image/png",C=l.rendererOpts||{};return u.toDataURL(d,C.quality)}})(pt);var wt={};const In=Fe;function He(e,t){const a=e.a/255,n=t+'="'+e.hex+'"';return a<1?n+" "+t+'-opacity="'+a.toFixed(2).slice(1)+'"':n}function Ae(e,t,a){let n=e+t;return typeof a<"u"&&(n+=" "+a),n}function Tn(e,t,a){let n="",s=0,o=!1,i=0;for(let c=0;c<e.length;c++){const l=Math.floor(c%t),u=Math.floor(c/t);!l&&!o&&(o=!0),e[c]?(i++,c>0&&l>0&&e[c-1]||(n+=o?Ae("M",l+a,.5+u+a):Ae("m",s,0),s=0,o=!1),l+1<t&&e[c+1]||(n+=Ae("h",i),i=0)):s++}return n}wt.render=function(t,a,n){const s=In.getOptions(a),o=t.modules.size,i=t.modules.data,c=o+s.margin*2,l=s.color.light.a?"<path "+He(s.color.light,"fill")+' d="M0 0h'+c+"v"+c+'H0z"/>':"",u="<path "+He(s.color.dark,"stroke")+' d="'+Tn(i,o,s.margin)+'"/>',d='viewBox="0 0 '+c+" "+c+'"',p='<svg xmlns="http://www.w3.org/2000/svg" '+(s.width?'width="'+s.width+'" height="'+s.width+'" ':"")+d+' shape-rendering="crispEdges">'+l+u+`</svg>
`;return typeof n=="function"&&n(null,p),p};const Bn=Vt,Te=st,yt=pt,Pn=wt;function Ue(e,t,a,n,s){const o=[].slice.call(arguments,1),i=o.length,c=typeof o[i-1]=="function";if(!c&&!Bn())throw new Error("Callback required as last argument");if(c){if(i<2)throw new Error("Too few arguments provided");i===2?(s=a,a=t,t=n=void 0):i===3&&(t.getContext&&typeof s>"u"?(s=n,n=void 0):(s=n,n=a,a=t,t=void 0))}else{if(i<1)throw new Error("Too few arguments provided");return i===1?(a=t,t=n=void 0):i===2&&!t.getContext&&(n=a,a=t,t=void 0),new Promise(function(l,u){try{const d=Te.create(a,n);l(e(d,t,n))}catch(d){u(d)}})}try{const l=Te.create(a,n);s(null,e(l,t,n))}catch(l){s(l)}}ne.create=Te.create;ne.toCanvas=Ue.bind(null,yt.render);ne.toDataURL=Ue.bind(null,yt.renderToDataURL);ne.toString=Ue.bind(null,function(e,t,a){return Pn.render(e,a)});function Mn({sessions:e,isLoading:t,loadingStatus:a,onAddNew:n,onEdit:s,onDelete:o,onConnect:i,onCheckStatus:c}){le();const l=u=>{switch(u){case"open":return r.jsx(H,{className:"bg-green-500",children:"Conectado"});case"close":return r.jsx(H,{variant:"destructive",children:"Desconectado"});case"connecting":return r.jsx(H,{variant:"secondary",children:"Conectando..."});default:return r.jsx(H,{variant:"outline",children:"Verificando..."})}};return r.jsxs(de,{children:[r.jsxs(Be,{children:[r.jsx(Pe,{children:"SessÃµes Configuradas"}),r.jsx(Me,{children:"Gerencie as sessÃµes do WhatsApp da sua empresa"})]}),r.jsx(ue,{children:t?r.jsx("p",{children:"Carregando..."}):e.length===0?r.jsxs("div",{className:"text-center py-8",children:[r.jsx(Ke,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),r.jsx("p",{className:"text-muted-foreground",children:"Nenhuma sessÃ£o configurada."}),r.jsx(k,{onClick:n,className:"mt-4",children:"Adicionar Primeira SessÃ£o"})]}):r.jsxs(vt,{children:[r.jsx(xt,{children:r.jsxs(We,{children:[r.jsx(Z,{children:"Nome da SessÃ£o"}),r.jsx(Z,{children:"Nome do Agente"}),r.jsx(Z,{children:"Status"}),r.jsx(Z,{children:"Prompt"}),r.jsx(Z,{className:"text-right",children:"AÃ§Ãµes"})]})}),r.jsx(Et,{children:e.map(u=>r.jsxs(We,{children:[r.jsx(X,{className:"font-medium",children:u.session_name}),r.jsx(X,{children:u.agent_name}),r.jsx(X,{children:r.jsxs("div",{className:"flex items-center gap-2",children:[l(u.connection_status),r.jsx(k,{size:"sm",variant:"ghost",onClick:()=>c(u.session_name),disabled:a[u.session_name],children:r.jsx(nt,{className:`h-4 w-4 ${a[u.session_name]?"animate-spin":""}`})})]})}),r.jsx(X,{children:r.jsx("span",{className:"text-sm text-muted-foreground",children:u.agent_prompt?u.agent_prompt.length>50?u.agent_prompt.substring(0,50)+"...":u.agent_prompt:"Sem prompt definido"})}),r.jsx(X,{className:"text-right",children:r.jsxs("div",{className:"flex gap-2 justify-end",children:[u.connection_status!=="open"&&r.jsxs(k,{size:"sm",variant:"outline",onClick:()=>i(u.session_name),children:[r.jsx($t,{className:"h-4 w-4 mr-1"}),"Conectar"]}),r.jsx(k,{size:"sm",variant:"ghost",onClick:()=>s(u),children:r.jsx(Pt,{className:"h-4 w-4"})}),r.jsx(k,{size:"sm",variant:"ghost",onClick:()=>o(u.id),children:r.jsx(Nt,{className:"h-4 w-4"})})]})})]},u.id))})]})})]})}function Rn({sessions:e}){const{toast:t}=le(),a=Oe(),[n,s]=T.useState(""),[o,i]=T.useState(""),[c,l]=T.useState(""),[u,d]=T.useState(!1),[C,p]=T.useState(!1),[h,v]=T.useState(null);T.useEffect(()=>{(async()=>{const{data:{user:g}}=await I.auth.getUser();if(g){const{data:N}=await I.from("profiles").select("company_id").eq("id",g.id).single();N&&v(N.company_id)}})()},[]);const{data:w}=Je({queryKey:["store-settings",h],queryFn:async()=>{if(!h)return null;const{data:f,error:g}=await I.from("store_settings").select("default_whatsapp_session").eq("company_id",h).single();return g&&g.code!=="PGRST116"?(console.error("Erro ao buscar configuraÃ§Ãµes:",g),null):f},enabled:!!h});T.useEffect(()=>{if(w!=null&&w.default_whatsapp_session&&!n){const f=e.find(g=>g.session_name===w.default_whatsapp_session&&g.connection_status==="open");f&&s(f.session_name)}},[w,e,n]);const E=_e({mutationFn:async f=>{if(!h)throw new Error("Company ID nÃ£o encontrado");const{error:g}=await I.from("store_settings").upsert({company_id:h,default_whatsapp_session:f},{onConflict:"company_id"});if(g)throw g},onSuccess:()=>{a.invalidateQueries({queryKey:["store-settings"]}),t({title:"SessÃ£o padrÃ£o salva",description:"Esta sessÃ£o serÃ¡ selecionada automaticamente nos prÃ³ximos testes."})},onError:f=>{console.error("Erro ao salvar sessÃ£o padrÃ£o:",f),t({title:"Erro ao salvar",description:"NÃ£o foi possÃ­vel salvar a sessÃ£o padrÃ£o.",variant:"destructive"})}}),y=async()=>{if(!n){t({title:"Erro",description:"Selecione uma sessÃ£o para enviar a mensagem.",variant:"destructive"});return}if(!o||!c){t({title:"Erro",description:"Preencha o nÃºmero de telefone e a mensagem.",variant:"destructive"});return}const f=o.replace(/\D/g,"");if(f.length<10||f.length>11){t({title:"NÃºmero invÃ¡lido",description:"O nÃºmero deve ter entre 10 e 11 dÃ­gitos.",variant:"destructive"});return}d(!0),p(!1);try{const g=await I.functions.invoke("whatsapp-send",{body:{instanceName:n,number:`55${f}`,message:c}});if(g.error)throw new Error(g.error.message);p(!0),t({title:"âœ… Mensagem enviada com sucesso!",description:`Mensagem enviada para ${o} via ${n}`,className:"bg-green-50 border-green-200"}),l(""),i(""),setTimeout(()=>p(!1),3e3)}catch(g){console.error("Erro ao enviar mensagem:",g),t({title:"âŒ Erro ao enviar",description:g instanceof Error?g.message:"NÃ£o foi possÃ­vel enviar a mensagem.",variant:"destructive"})}finally{d(!1)}},x=e.filter(f=>f.connection_status==="open");return r.jsxs(de,{className:C?"border-green-500 animate-pulse":"",children:[r.jsx(Be,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsxs(Pe,{className:"flex items-center gap-2",children:["Teste de Envio",C&&r.jsx(Ce,{className:"h-5 w-5 text-green-500 animate-scale-in"})]}),r.jsx(Me,{children:"Envie uma mensagem de teste pelo WhatsApp"})]}),n&&(w==null?void 0:w.default_whatsapp_session)===n&&r.jsxs(H,{variant:"secondary",className:"flex items-center gap-1",children:[r.jsx(ze,{className:"h-3 w-3"}),"PadrÃ£o"]})]})}),r.jsxs(ue,{className:"space-y-4",children:[C&&r.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 animate-fade-in",children:[r.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[r.jsx(Ce,{className:"h-5 w-5"}),r.jsx("p",{className:"font-medium",children:"Mensagem enviada com sucesso!"})]}),r.jsx("p",{className:"text-sm text-green-600 mt-1",children:"Verifique o WhatsApp do destinatÃ¡rio para confirmar o recebimento."})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(W,{htmlFor:"session",children:"SessÃ£o"}),n&&n!==(w==null?void 0:w.default_whatsapp_session)&&r.jsxs(k,{variant:"ghost",size:"sm",onClick:()=>E.mutate(n),disabled:E.isPending,className:"text-xs",children:[E.isPending?r.jsx(qe,{className:"h-3 w-3 mr-1 animate-spin"}):r.jsx(ze,{className:"h-3 w-3 mr-1"}),"Definir como padrÃ£o"]})]}),r.jsxs(At,{value:n,onValueChange:s,children:[r.jsx(_t,{children:r.jsx(bt,{placeholder:"Selecione uma sessÃ£o conectada"})}),r.jsx(jt,{children:x.length===0?r.jsx($e,{value:"none",disabled:!0,children:"Nenhuma sessÃ£o conectada"}):x.map(f=>r.jsx($e,{value:f.session_name,children:r.jsxs("div",{className:"flex items-center gap-2",children:[f.session_name,(w==null?void 0:w.default_whatsapp_session)===f.session_name&&r.jsx(H,{variant:"outline",className:"text-xs",children:"PadrÃ£o"})]})},f.id))})]})]}),r.jsxs("div",{className:"grid gap-2",children:[r.jsx(W,{htmlFor:"phone",children:"NÃºmero do WhatsApp"}),r.jsx(be,{id:"phone",placeholder:"Ex: 11999998888",value:o,onChange:f=>i(f.target.value),disabled:!n||u,className:C?"border-green-400":""})]}),r.jsxs("div",{className:"grid gap-2",children:[r.jsx(W,{htmlFor:"message",children:"Mensagem"}),r.jsx(Re,{id:"message",placeholder:"Digite sua mensagem de teste...",value:c,onChange:f=>l(f.target.value),rows:4,disabled:!n||u,className:C?"border-green-400":""})]}),r.jsx(k,{onClick:y,disabled:!n||u||!o||!c,className:"w-full relative overflow-hidden",variant:"default",children:u?r.jsxs(r.Fragment,{children:[r.jsx(qe,{className:"h-4 w-4 mr-2 animate-spin"}),"Enviando mensagem..."]}):C?r.jsxs(r.Fragment,{children:[r.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Mensagem Enviada!"]}):r.jsxs(r.Fragment,{children:[r.jsx(Qt,{className:"h-4 w-4 mr-2"}),"Enviar Mensagem"]})})]})]})}function kn(){const{toast:e}=le(),[t,a]=T.useState(null),[n,s]=T.useState([{status:"pending",label:"Novo Pedido",message:`ðŸ”” *Novo Pedido!*

Recebemos seu pedido #{order_number}!

ðŸ“¦ *Itens:*
{order_items}

ðŸ’° *Total:* R$ {order_total}

Estamos preparando com carinho! ðŸ˜Š`,enabled:!0},{status:"preparando",label:"Preparando",message:`ðŸ‘¨â€ðŸ³ *Pedido em PreparaÃ§Ã£o*

Seu pedido #{order_number} estÃ¡ sendo preparado!

â±ï¸ Tempo estimado: {estimated_time} minutos`,enabled:!0},{status:"pronto",label:"Pronto",message:`âœ… *Pedido Pronto!*

Seu pedido #{order_number} estÃ¡ pronto!

ðŸƒ Em breve sairÃ¡ para entrega.`,enabled:!0},{status:"em_entrega",label:"Em Entrega",message:`ðŸš´ *Saiu para Entrega!*

Seu pedido #{order_number} estÃ¡ a caminho!

ðŸ“ EndereÃ§o: {delivery_address}`,enabled:!0},{status:"concluido",label:"ConcluÃ­do",message:`ðŸŽ‰ *Pedido Entregue!*

Obrigado pela preferÃªncia!

Esperamos vocÃª novamente! â¤ï¸`,enabled:!0},{status:"cancelado",label:"Cancelado",message:`âŒ *Pedido Cancelado*

Seu pedido #{order_number} foi cancelado.

Motivo: {cancellation_reason}

Qualquer dÃºvida, estamos Ã  disposiÃ§Ã£o.`,enabled:!1}]),[o,i]=T.useState(!1);T.useEffect(()=>{async function d(){const{data:{user:C}}=await I.auth.getUser();if(C){const{data:p}=await I.from("profiles").select("company_id").eq("id",C.id).single();if(p!=null&&p.company_id){a(p.company_id);const{data:h,error:v}=await I.from("whatsapp_config").select("*").eq("company_id",p.company_id).eq("config_type","status_message");if(!v&&h&&h.length>0){const w=n.map(E=>{const y=h.find(x=>x.status===E.status);return y?{...E,message:y.message_template,enabled:y.is_active}:E});s(w)}}}}d()},[]);const c=(d,C)=>{s(p=>p.map(h=>h.status===d?{...h,message:C}:h))},l=(d,C)=>{s(p=>p.map(h=>h.status===d?{...h,enabled:C}:h))},u=async()=>{if(!t){e({title:"Erro",description:"ID da empresa nÃ£o encontrado.",variant:"destructive"});return}i(!0);try{for(const d of n){const{error:C}=await I.from("whatsapp_config").upsert({company_id:t,config_type:"status_message",status:d.status,message_template:d.message,is_active:d.enabled},{onConflict:"company_id,status,config_type"});if(C)throw C}e({title:"ConfiguraÃ§Ãµes salvas!",description:"As mensagens de status foram atualizadas com sucesso."})}catch(d){console.error("Erro ao salvar mensagens:",d),e({title:"Erro ao salvar",description:"NÃ£o foi possÃ­vel salvar as configuraÃ§Ãµes.",variant:"destructive"})}finally{i(!1)}};return r.jsxs(de,{children:[r.jsxs(Be,{children:[r.jsx(Pe,{children:"Mensagens por Status"}),r.jsx(Me,{children:"Configure as mensagens automÃ¡ticas para cada mudanÃ§a de status do pedido"})]}),r.jsxs(ue,{className:"space-y-6",children:[n.map(d=>r.jsxs("div",{className:"space-y-3 p-4 border rounded-lg",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(W,{className:"text-base font-semibold",children:d.label}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(W,{htmlFor:`enabled-${d.status}`,className:"text-sm",children:"Enviar notificaÃ§Ã£o"}),r.jsx(St,{id:`enabled-${d.status}`,checked:d.enabled,onCheckedChange:C=>l(d.status,C)})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(W,{htmlFor:`msg-${d.status}`,className:"text-sm text-muted-foreground",children:["Mensagem (use variÃ¡veis: ","{order_number}",", ","{order_items}",", ","{order_total}",", ","{estimated_time}",", ","{delivery_address}",")"]}),r.jsx(Re,{id:`msg-${d.status}`,value:d.message,onChange:C=>c(d.status,C.target.value),rows:5,disabled:!d.enabled,className:"font-mono text-sm"})]})]},d.status)),r.jsxs(k,{onClick:u,disabled:o,className:"w-full",children:[r.jsx(Mt,{className:"h-4 w-4 mr-2"}),o?"Salvando...":"Salvar ConfiguraÃ§Ãµes"]})]})]})}function Dn({open:e,onOpenChange:t,formData:a,onFormChange:n,onSave:s,onCancel:o,isEditing:i}){return r.jsx(Ye,{open:e,onOpenChange:t,children:r.jsxs(Ge,{className:"sm:max-w-[500px]",children:[r.jsxs(Ze,{children:[r.jsx(Xe,{children:i?"Editar SessÃ£o":"Nova SessÃ£o WhatsApp"}),r.jsx(et,{children:i?"Atualize as informaÃ§Ãµes da sessÃ£o WhatsApp.":"Configure uma nova sessÃ£o do WhatsApp para sua empresa."})]}),r.jsxs("div",{className:"grid gap-4 py-4",children:[r.jsxs("div",{className:"grid gap-2",children:[r.jsx(W,{htmlFor:"session_name",children:"Nome da SessÃ£o *"}),r.jsx(be,{id:"session_name",placeholder:"Ex: Atendimento Principal",value:a.session_name,onChange:c=>n({...a,session_name:c.target.value})})]}),r.jsxs("div",{className:"grid gap-2",children:[r.jsx(W,{htmlFor:"agent_name",children:"Nome do Agente *"}),r.jsx(be,{id:"agent_name",placeholder:"Ex: Assistente Virtual",value:a.agent_name,onChange:c=>n({...a,agent_name:c.target.value})})]}),r.jsxs("div",{className:"grid gap-2",children:[r.jsx(W,{htmlFor:"agent_prompt",children:"Prompt do Agente"}),r.jsx(Re,{id:"agent_prompt",placeholder:"Defina o comportamento e personalidade do agente...",value:a.agent_prompt,onChange:c=>n({...a,agent_prompt:c.target.value}),rows:4})]})]}),r.jsxs(tt,{children:[r.jsx(k,{variant:"outline",onClick:o,children:"Cancelar"}),r.jsx(k,{onClick:s,children:i?"Salvar AlteraÃ§Ãµes":"Adicionar SessÃ£o"})]})]})})}function Ln({open:e,qrCode:t,sessionName:a,onClose:n,onRefresh:s}){return r.jsx(Ye,{open:e,onOpenChange:o=>!o&&n(),children:r.jsxs(Ge,{className:"sm:max-w-[425px]",children:[r.jsxs(Ze,{children:[r.jsx(Xe,{children:"Conectar WhatsApp"}),r.jsxs(et,{children:["Escaneie o QR Code abaixo com o WhatsApp da sessÃ£o: ",a]})]}),r.jsxs("div",{className:"flex flex-col items-center justify-center py-6",children:[t&&r.jsx("img",{src:t,alt:"QR Code WhatsApp",className:"w-64 h-64 border-2 border-border rounded-lg"}),r.jsx("p",{className:"text-sm text-muted-foreground mt-4 text-center",children:'O QR Code expira em alguns minutos. Se necessÃ¡rio, clique em "Gerar Novo QR Code".'})]}),r.jsxs(tt,{children:[r.jsx(k,{variant:"outline",onClick:n,children:"Fechar"}),r.jsxs(k,{onClick:()=>s(a),children:[r.jsx(nt,{className:"h-4 w-4 mr-2"}),"Gerar Novo QR Code"]})]})]})})}function qn(){const{toast:e}=le(),t=Oe(),[a,n]=T.useState(null),[s,o]=T.useState(!1),[i,c]=T.useState(null),[l,u]=T.useState(null),[d,C]=T.useState({open:!1,qrCode:"",sessionName:""}),[p,h]=T.useState({}),[v,w]=T.useState({session_name:"",agent_name:"",agent_prompt:""});T.useEffect(()=>{async function m(){const{data:{user:A}}=await I.auth.getUser();if(A){const{data:_}=await I.from("profiles").select("company_id").eq("id",A.id).single();_!=null&&_.company_id&&n(_.company_id)}}m()},[]);const{data:E=[],isLoading:y}=Je({queryKey:["whatsapp-sessions",a],queryFn:async()=>{if(console.log("[WhatsApp] ðŸ”„ Carregando sessÃµes para empresa:",a),!a)return[];const{data:m,error:A}=await I.from("whatsapp_config").select("*").eq("company_id",a).eq("config_type","session").order("created_at",{ascending:!1});if(A)throw console.error("[WhatsApp] âŒ Erro ao carregar sessÃµes:",A),A;return console.log("[WhatsApp] âœ… SessÃµes carregadas:",(m==null?void 0:m.length)||0),m},enabled:!!a,staleTime:3e4,gcTime:6e4}),x=_e({mutationFn:async m=>{if(m.id){const{error:A}=await I.from("whatsapp_config").update({session_name:m.session_name,agent_name:m.agent_name,agent_prompt:m.agent_prompt||null}).eq("id",m.id);if(A)throw A;return{isNew:!1,data:m}}else{const{error:A}=await I.from("whatsapp_config").insert({company_id:a,config_type:"session",session_name:m.session_name,agent_name:m.agent_name,agent_prompt:m.agent_prompt||null});if(A)throw A;return{isNew:!0,data:m}}},onSuccess:async({isNew:m,data:A})=>{if(t.invalidateQueries({queryKey:["whatsapp-sessions"]}),e({title:i?"SessÃ£o atualizada":"SessÃ£o adicionada",description:`A sessÃ£o foi ${i?"atualizada":"adicionada"} com sucesso.`}),b(),m)try{const _=await I.functions.invoke("whatsapp-evolution",{body:{sessionName:A.session_name,agentName:A.agent_name,agentPrompt:A.agent_prompt||""}});_.error?(console.error("Erro ao comunicar com Evolution API:",_.error),e({title:"AtenÃ§Ã£o",description:"SessÃ£o salva, mas houve erro ao comunicar com Evolution API.",variant:"destructive"})):console.log("Sucesso ao comunicar com Evolution API:",_.data)}catch(_){console.error("Erro ao chamar edge function:",_)}},onError:()=>{e({title:`Erro ao ${i?"atualizar":"adicionar"}`,description:`NÃ£o foi possÃ­vel ${i?"atualizar":"adicionar"} a sessÃ£o.`,variant:"destructive"})}}),f=_e({mutationFn:async m=>{const A=E.find(j=>j.id===m),{error:_}=await I.from("whatsapp_config").delete().eq("id",m);if(_)throw _;if(A)try{await I.functions.invoke("whatsapp-evolution",{body:{instanceName:A.session_name,action:"delete"}})}catch(j){console.error("Erro ao deletar da Evolution API:",j)}},onSuccess:()=>{t.invalidateQueries({queryKey:["whatsapp-sessions"]}),e({title:"SessÃ£o removida",description:"A sessÃ£o foi removida com sucesso."})},onError:()=>{e({title:"Erro ao remover",description:"NÃ£o foi possÃ­vel remover a sessÃ£o.",variant:"destructive"})}}),g=()=>{w({session_name:"",agent_name:"",agent_prompt:""}),c(null),o(!0)},N=m=>{w({session_name:m.session_name,agent_name:m.agent_name,agent_prompt:m.agent_prompt||""}),c(m),o(!0)},b=()=>{o(!1),c(null),w({session_name:"",agent_name:"",agent_prompt:""})},B=()=>{if(!v.session_name.trim()||!v.agent_name.trim()){e({title:"Campos obrigatÃ³rios",description:"Nome da sessÃ£o e nome do agente sÃ£o obrigatÃ³rios.",variant:"destructive"});return}if(!i&&E.find(A=>A.session_name.toLowerCase()===v.session_name.trim().toLowerCase())){e({title:"Nome duplicado",description:"JÃ¡ existe uma sessÃ£o com este nome. Por favor, escolha outro nome.",variant:"destructive"});return}i?x.mutate({...v,id:i.id}):x.mutate(v)},P=m=>{f.mutate(m),u(null)},F=T.useRef({}),M=1e4,z=async(m,A=!1)=>{var R,q;console.log(`[WhatsApp] ðŸ” Verificando status da instÃ¢ncia: ${m}`);const _=Date.now(),j=F.current[m]||0;if(!A&&_-j<M){const S=Math.ceil((M-(_-j))/1e3);return console.log(`[WhatsApp] â³ Throttle ativo. Aguardar ${S}s`),e({title:"Aguarde",description:`PrÃ³xima verificaÃ§Ã£o disponÃ­vel em ${S} segundos`,variant:"default"}),((R=E.find(V=>V.session_name===m))==null?void 0:R.connection_status)||"unknown"}h(S=>({...S,[m]:!0})),F.current[m]=_;try{console.log(`[WhatsApp] ðŸ“¡ Enviando requisiÃ§Ã£o de status para: ${m}`);const S=await I.functions.invoke("whatsapp-evolution",{body:{instanceName:m,action:"status"}});if(console.log("[WhatsApp] ðŸ“¥ Resposta recebida:",S),S.error)throw console.error("[WhatsApp] âŒ Erro na resposta:",S.error),new Error(S.error.message||"Erro ao verificar status");if((q=S.data)!=null&&q.success){const V=S.data.data.instance.state;console.log(`[WhatsApp] âœ… Status da instÃ¢ncia ${m}: ${V}`);const Ct=E.map(pe=>pe.session_name===m?{...pe,connection_status:V}:pe);return t.setQueryData(["whatsapp-sessions",a],Ct),A||e({title:"Status atualizado",description:`Status da sessÃ£o: ${V==="open"?"Conectado":V==="close"?"Desconectado":"Conectando..."}`}),V}return console.warn("[WhatsApp] âš ï¸ Resposta sem sucesso:",S.data),"unknown"}catch(S){return console.error(`[WhatsApp] âŒ Erro ao verificar status de ${m}:`,S),A||e({title:"Erro ao verificar status",description:S instanceof Error?S.message:"NÃ£o foi possÃ­vel verificar o status da conexÃ£o",variant:"destructive"}),"unknown"}finally{h(S=>({...S,[m]:!1}))}},G=async m=>{var A;console.log(`[WhatsApp] ðŸ”§ Verificando existÃªncia da instÃ¢ncia: ${m}`);try{const _=await I.functions.invoke("whatsapp-evolution",{body:{instanceName:m,action:"status"}});if(console.log("[WhatsApp] ðŸ“¥ Resposta de verificaÃ§Ã£o:",_),_.error||!((A=_.data)!=null&&A.success)){console.warn(`[WhatsApp] âš ï¸ InstÃ¢ncia nÃ£o existe, tentando criar: ${m}`);const j=E.find(q=>q.session_name===m);if(!j)throw new Error("SessÃ£o nÃ£o encontrada no banco de dados");const R=await I.functions.invoke("whatsapp-evolution",{body:{sessionName:j.session_name,agentName:j.agent_name,agentPrompt:j.agent_prompt||""}});if(console.log("[WhatsApp] ðŸ“¥ Resposta de criaÃ§Ã£o:",R),R.error)throw new Error(R.error.message||"Erro ao criar instÃ¢ncia");return console.log(`[WhatsApp] âœ… InstÃ¢ncia criada com sucesso: ${m}`),!0}return console.log(`[WhatsApp] âœ… InstÃ¢ncia jÃ¡ existe: ${m}`),!0}catch(_){throw console.error(`[WhatsApp] âŒ Erro ao verificar/criar instÃ¢ncia ${m}:`,_),_}},L=async m=>{var A,_;console.log(`[WhatsApp] ðŸ”Œ Iniciando conexÃ£o para: ${m}`);try{e({title:"Verificando instÃ¢ncia",description:"Validando comunicaÃ§Ã£o com Evolution API..."}),console.log(`[WhatsApp] ðŸ”§ Garantindo que instÃ¢ncia existe: ${m}`),await G(m),e({title:"Gerando QR Code",description:"Aguarde enquanto geramos o QR Code..."}),console.log(`[WhatsApp] ðŸ“¡ Solicitando QR Code para: ${m}`);const j=await I.functions.invoke("whatsapp-evolution",{body:{instanceName:m,action:"connect"}});if(console.log("[WhatsApp] ðŸ“¥ Resposta do QR Code:",j),j.error)throw console.error("[WhatsApp] âŒ Erro na resposta:",j.error),new Error(j.error.message||"Edge Function returned a non-2xx status code");const _findQr=K=>{const J=[K];for(;J.length;){const X=J.pop();if(!X)continue;if(typeof X==="string"){const tt=X.trim();if(!tt)continue;if(tt.startsWith("data:image"))return tt;if(tt.length>120&&/^[A-Za-z0-9+/=\n\r]+$/.test(tt))return tt;if(tt.length>30&&/^[0-9A-Z $%*+\-./:]+$/.test(tt))return tt;continue}if(typeof X==="object")for(const [tt,gt]of Object.entries(X)){const et=String(tt).toLowerCase();if((et.includes("qr")||et.includes("code")||et.includes("base64"))&&typeof gt==="string"&&gt.trim())return gt.trim();gt&&typeof gt==="object"&&J.push(gt)}}return""},Rr=(A=j.data)!=null&&A.success?(j.data.data||j.data):null;let qrRaw=(Rr==null?void 0:Rr.code)||(Rr==null?void 0:Rr.qrcode)||(Rr==null?void 0:Rr.qr)||(Rr==null?void 0:Rr.base64)||(Rr==null?void 0:Rr.qrCode)||_findQr(j.data)||"";if(!qrRaw){const K=await I.functions.invoke("whatsapp-evolution",{body:{instanceName:m,action:"status"}});qrRaw=_findQr((K==null?void 0:K.data)||{})||""}if(qrRaw){console.log("[WhatsApp] âœ… QR Code recebido com sucesso");try{const R=String(qrRaw).trim(),q=R.startsWith("data:image")?R:/^[A-Za-z0-9+/=]+$/.test(R)&&R.length>200?`data:image/png;base64,${R}`:await ne.toDataURL(R,{width:300,margin:2});console.log("[WhatsApp] ðŸŽ¨ QR Code renderizado com sucesso"),C({open:!0,qrCode:q,sessionName:m}),console.log("[WhatsApp] ðŸ”„ Iniciando polling de status");const S=setInterval(async()=>{const V=await z(m,!0);console.log(`[WhatsApp] ðŸ“Š Status atual: ${V}`),V==="open"?(console.log("[WhatsApp] âœ… ConexÃ£o estabelecida com sucesso!"),clearInterval(S),C({open:!1,qrCode:"",sessionName:""}),e({title:"Conectado com sucesso!",description:"Sua sessÃ£o do WhatsApp estÃ¡ conectada."}),t.invalidateQueries({queryKey:["whatsapp-sessions"]})):V==="close"&&(console.warn("[WhatsApp] âš ï¸ ConexÃ£o fechada"),clearInterval(S),e({title:"Erro na conexÃ£o",description:"NÃ£o foi possÃ­vel conectar. Verifique se o QR Code foi escaneado corretamente.",variant:"destructive"}))},3e3);setTimeout(()=>{clearInterval(S),d.open&&(console.warn("[WhatsApp] â° Timeout do QR Code"),e({title:"Tempo esgotado",description:"O QR Code expirou. Por favor, tente novamente.",variant:"destructive"}))},12e4)}catch(R){throw console.error("[WhatsApp] âŒ Erro ao gerar QR Code:",R),new Error("Erro ao gerar imagem do QR Code")}}else throw console.error("[WhatsApp] âŒ QR Code nÃ£o disponÃ­vel na resposta",j.data),new Error("QR Code nÃ£o disponÃ­vel")}catch(j){console.error("[WhatsApp] âŒ Erro ao conectar:",j);const R=j instanceof Error?j.message:"NÃ£o foi possÃ­vel gerar o QR Code.";console.error(`[WhatsApp] ðŸ’¬ Mensagem de erro: ${R}`),e({title:"Erro ao gerar QR Code",description:R,variant:"destructive"})}};return r.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[r.jsx(de,{className:"border-yellow-500 bg-yellow-50 dark:bg-yellow-950/20",children:r.jsx(ue,{className:"pt-6",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(qt,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-500 mt-0.5"}),r.jsxs("div",{className:"space-y-1",children:[r.jsx("p",{className:"text-sm font-medium text-yellow-800 dark:text-yellow-200",children:"Limite de verificaÃ§Ãµes de status"}),r.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Para evitar sobrecarga na API, as verificaÃ§Ãµes de status tÃªm um intervalo mÃ­nimo de 10 segundos entre cada chamada."})]})]})})}),r.jsxs("div",{className:"flex items-center justify-between mb-6",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Ke,{className:"h-6 w-6"}),r.jsx("h1",{className:"text-2xl font-bold",children:"ConfiguraÃ§Ãµes WhatsApp"})]}),r.jsxs(k,{onClick:g,children:[r.jsx(It,{className:"h-4 w-4 mr-2"}),"Nova SessÃ£o"]})]}),r.jsxs(Tt,{defaultValue:"sessions",className:"space-y-4",children:[r.jsxs(Bt,{className:"grid w-full grid-cols-3",children:[r.jsx(we,{value:"sessions",children:"SessÃµes"}),r.jsx(we,{value:"test",children:"Teste de Envio"}),r.jsx(we,{value:"status",children:"Mensagens de Status"})]}),r.jsx(ye,{value:"sessions",children:r.jsx(Mn,{sessions:E,isLoading:y,loadingStatus:p,onAddNew:g,onEdit:N,onDelete:m=>u(m),onConnect:L,onCheckStatus:z})}),r.jsx(ye,{value:"test",children:r.jsx(Rn,{sessions:E})}),r.jsx(ye,{value:"status",children:r.jsx(kn,{})})]}),r.jsx(Dn,{open:s,onOpenChange:o,formData:v,onFormChange:w,onSave:B,onCancel:b,isEditing:!!i}),r.jsx(Rt,{open:!!l,onOpenChange:()=>u(null),children:r.jsxs(kt,{children:[r.jsxs(Dt,{children:[r.jsx(Lt,{children:"Confirmar exclusÃ£o"}),r.jsx(Ft,{children:"Tem certeza que deseja remover esta sessÃ£o do WhatsApp? Esta aÃ§Ã£o nÃ£o pode ser desfeita."})]}),r.jsxs(Ut,{children:[r.jsx(Wt,{children:"Cancelar"}),r.jsx(zt,{onClick:()=>l&&P(l),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Remover"})]})]})}),r.jsx(Ln,{open:d.open,qrCode:d.qrCode,sessionName:d.sessionName,onClose:()=>C({open:!1,qrCode:"",sessionName:""}),onRefresh:L})]})}export{qn as default};

