import{c as de,j as e,G as ue,aQ as oe,S as H,m as U,n as V,p as W,q as G,aR as ee,B as A,Q as Le,C as me,z as pe,b as Me,d as ze,H as xe,f as De,a7 as he,aS as fe,ab as ge,ac as je,ad as ve,ae as be,a6 as z,aT as Fe,aU as ye,r as g,R as Be,y as Ke,aK as Qe,u as Ne,aV as He,aH as R,x as S,aW as le,L as Ue,aX as X,aY as J,aI as Ve,aJ as We}from"./index-v68zVK4x.js";import{u as Ge}from"./useCompanyId-BPuD7pC1.js";import{T as se}from"./truck-BReM8TfE.js";import{T as Xe}from"./triangle-alert-pjCGKzCy.js";import{T as Je}from"./theme-toggle-DqinLoEg.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=de("BellOff",[["path",{d:"M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5",key:"o7mx20"}],["path",{d:"M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7",key:"16f1lm"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=de("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]),Z=[{id:"pending",title:"Novo",color:"bg-blue-500"},{id:"preparing",title:"Em Preparo",color:"bg-yellow-500"},{id:"ready",title:"Pronto",color:"bg-green-500"},{id:"delivering",title:"Em Entrega",color:"bg-purple-500"},{id:"completed",title:"Conclu√≠do",color:"bg-muted"},{id:"cancelled",title:"Cancelado",color:"bg-red-500"}],es={novo:"pending",pendente:"pending",pending:"pending",preparando:"preparing",preparing:"preparing",pronto:"ready",ready:"ready",em_entrega:"delivering",delivering:"delivering",entregando:"delivering",concluido:"completed",conclu√≠da:"completed",completed:"completed",cancelado:"cancelled",cancelled:"cancelled"},Y=s=>es[s==null?void 0:s.toLowerCase()]||"pending",ss=(s,l)=>{switch(s){case"pending":return"preparing";case"preparing":return l==="pickup"?"ready":"delivering";case"ready":return"completed";case"delivering":return"completed";default:return s}},ts=["Cliente desistiu","Erro no pedido","Falta de insumos","Endere√ßo incorreto","Cliente n√£o atendeu","Outros"],ce=[15,30,45,60,90,120];function as({settings:s,onSettingsChange:l,searchTerm:n,onSearchChange:j,showFilters:v,onToggleFilters:y,selectedOrdersCount:_,onBulkStatusChange:d}){return e.jsxs("div",{className:"sticky top-0 bg-background/95 backdrop-blur-sm z-10 border-b pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx(oe,{checked:s.storeOpen,onCheckedChange:r=>l({storeOpen:r})}),e.jsx("span",{className:`text-sm font-medium ${s.storeOpen?"text-success":"text-destructive"}`,children:s.storeOpen?"Aberto":"Fechado"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm",children:"Aceite Autom√°tico"}),e.jsx(oe,{checked:s.autoAccept,onCheckedChange:r=>l({autoAccept:r})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs(H,{value:String(s.deliveryTime),onValueChange:r=>l({deliveryTime:Number(r)}),children:[e.jsx(U,{className:"w-28 h-8",children:e.jsx(V,{})}),e.jsx(W,{children:ce.map(r=>e.jsxs(G,{value:String(r),children:[r," min"]},r))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"w-4 h-4"}),e.jsxs(H,{value:String(s.pickupTime),onValueChange:r=>l({pickupTime:Number(r)}),children:[e.jsx(U,{className:"w-28 h-8",children:e.jsx(V,{})}),e.jsx(W,{children:ce.map(r=>e.jsxs(G,{value:String(r),children:[r," min"]},r))})]})]}),e.jsx("input",{type:"text",placeholder:"Buscar pedidos...",value:n,onChange:r=>j(r.target.value),className:"text-sm border rounded px-3 py-1 w-48"}),_>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:[_," selecionados"]}),e.jsxs(H,{onValueChange:d,children:[e.jsx(U,{className:"w-40 h-8",children:e.jsx(V,{placeholder:"Alterar status"})}),e.jsx(W,{children:Z.map(r=>e.jsx(G,{value:r.id,children:r.title},r.id))})]})]}),e.jsx(A,{variant:s.soundEnabled?"default":"outline",size:"sm",onClick:()=>l({soundEnabled:!s.soundEnabled}),children:s.soundEnabled?e.jsx(Ze,{className:"w-4 h-4"}):e.jsx(Ye,{className:"w-4 h-4"})}),e.jsxs(A,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Le,{className:"w-4 h-4 mr-1"}),"Filtros"]})]}),v&&e.jsxs(me,{className:"mt-3 p-3",children:[e.jsx("h3",{className:"font-semibold mb-2 text-sm",children:"Colunas Vis√≠veis"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:Z.map(r=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pe,{checked:s.visibleColumns[r.id],onCheckedChange:N=>l({visibleColumns:{...s.visibleColumns,[r.id]:N}}),disabled:r.id==="pending"&&s.autoAccept}),e.jsx("label",{className:"text-sm",children:r.title})]},r.id))})]})]})}function ns({order:s,isSelected:l,onSelect:n,onClick:j,onPrint:v,onStatusChange:y,onDragStart:_,onDragEnd:d,alertTime:r,isPrinting:N,onOpenWhatsApp:x}){const u=Math.floor((Date.now()-new Date(s.created_at).getTime())/6e4),q=s.status==="preparing"&&u>=r,P=()=>{const m=ss(s.status,s.type);y(s.id,m,s.status,s)};return e.jsxs(me,{className:`cursor-move hover:shadow-lg transition-all duration-200 ease-out select-none hover:scale-[1.02] ${q?"border-destructive border-2":""} ${s.status==="pending"?"bg-blue-50/50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800 animate-pulse-subtle":""}`,draggable:!0,onDragStart:m=>_(m,s),onDragEnd:d,onClick:j,children:[e.jsxs(Me,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{checked:l,onCheckedChange:n,onClick:m=>m.stopPropagation()}),e.jsxs(ze,{className:"text-sm",children:["#",s.order_number||s.id.slice(0,8)]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[q&&e.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 rounded-full bg-destructive/10 text-destructive",children:[e.jsx(Xe,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs font-medium",children:"Atrasado"})]}),s.status==="preparing"&&e.jsxs("div",{className:`flex items-center gap-1 text-xs ${q?"text-destructive font-medium":"text-muted-foreground"}`,children:[e.jsx(xe,{className:"w-3 h-3"}),u," min"]})]})]}),s.status==="pending"&&e.jsx("div",{className:"flex justify-center mt-2",children:e.jsx("div",{className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-primary/10 to-primary/5 text-primary border border-primary/20",children:s.source==="whatsapp"?"Delivery WhatsApp":s.source==="digital_menu"?"Delivery Card√°pio Digital":s.source==="counter"?"Pedido Balc√£o":s.type==="delivery"?"Delivery Card√°pio Digital":"Pedido Balc√£o"})}),e.jsx("div",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs mt-2 ${s.type==="delivery"?"bg-blue-500/10 text-blue-600 dark:bg-blue-500/20 dark:text-blue-400":"bg-green-500/10 text-green-600 dark:bg-green-500/20 dark:text-green-400"}`,children:s.type==="delivery"?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-3 h-3"}),"Entrega"]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-3 h-3"}),"Retirada"]})})]}),e.jsxs(De,{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.customer_name}),s.customer_phone&&e.jsxs("button",{onClick:m=>{m.stopPropagation(),x(s.customer_phone,s.order_number)},className:"flex items-center gap-1 text-xs text-green-600 hover:underline",children:[e.jsx(he,{className:"w-3 h-3"}),s.customer_phone]})]}),e.jsxs("div",{className:"flex gap-1",children:[s.status!=="pending"&&s.status!=="cancelled"&&e.jsxs(A,{variant:"outline",size:"sm",className:"flex-1 h-7 text-xs",onClick:m=>{m.stopPropagation(),v(s,!0)},disabled:N,children:[e.jsx(fe,{className:"w-3 h-3 mr-1"}),N?"Imprimindo...":"Imprimir"]}),s.status!=="completed"&&s.status!=="cancelled"&&e.jsx(A,{variant:"default",size:"sm",className:"flex-1 h-7 text-xs",onClick:m=>{m.stopPropagation(),P()},children:"Avan√ßar"})]})]})]})}function rs({column:s,orders:l,onDrop:n,onDragOver:j,onCardClick:v,onCardSelect:y,selectedOrders:_,onPrintOrder:d,onUpdateStatus:r,onDragStart:N,onDragEnd:x,alertTime:u,isPrinting:w,isDraggedOver:q,onOpenWhatsApp:P}){return e.jsxs("div",{className:"flex-shrink-0 w-80",onDragOver:j,onDrop:m=>n(m,s.id),children:[e.jsx("div",{className:`${s.color} text-white p-3 rounded-t-lg`,children:e.jsxs("h3",{className:"font-semibold",children:[s.title," (",l.length,")"]})}),e.jsx("div",{className:`bg-card border border-border min-h-[400px] max-h-[calc(100vh-300px)] overflow-y-auto p-2 rounded-b-lg space-y-2 transition-all duration-200 ${q?"bg-primary/5":""}`,children:l.length>0?l.map(m=>e.jsx(ns,{order:m,isSelected:_.has(m.id),onSelect:()=>y(m.id),onClick:()=>v(m),onPrint:d,onStatusChange:r,onDragStart:N,onDragEnd:x,alertTime:u,isPrinting:w,onOpenWhatsApp:P},m.id)):e.jsx("div",{className:"text-center py-8 text-muted-foreground text-sm",children:"Nenhum pedido"})})]})}function is({order:s,open:l,onClose:n,onPrint:j,onCancel:v,onOpenWhatsApp:y,isPrinting:_}){var N,x;if(!s)return null;const d=((N=s.items)==null?void 0:N.reduce((u,w)=>u+(w.price||0)*(w.quantity||0),0))||0,r=d+(s.delivery_fee||0);return e.jsx(ge,{open:l,onOpenChange:n,children:e.jsxs(je,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ve,{children:e.jsxs(be,{className:"text-xl",children:["Pedido #",s.order_number]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.type==="delivery"?e.jsxs("div",{className:"flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/10 text-blue-600 text-sm",children:[e.jsx(se,{className:"w-4 h-4"}),"Entrega"]}):e.jsxs("div",{className:"flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/10 text-green-600 text-sm",children:[e.jsx(ee,{className:"w-4 h-4"}),"Retirada"]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(xe,{className:"w-4 h-4"}),new Date(s.created_at).toLocaleString("pt-BR")]})]}),e.jsx(z,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Cliente"}),e.jsx("p",{className:"text-sm",children:s.customer_name}),s.customer_phone&&e.jsxs("button",{onClick:()=>y(s.customer_phone,s.order_number),className:"flex items-center gap-1 text-sm text-green-600 hover:underline mt-1",children:[e.jsx(he,{className:"w-4 h-4"}),s.customer_phone]}),s.address&&e.jsxs("div",{className:"flex gap-1 text-sm text-muted-foreground mt-1",children:[e.jsx(Fe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.address})]})]}),e.jsx(z,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Itens do Pedido"}),e.jsx("div",{className:"space-y-2",children:(x=s.items)==null?void 0:x.map((u,w)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[u.quantity,"x ",u.name]}),u.observations&&e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:["Obs: ",u.observations]})]}),e.jsxs("p",{className:"font-medium",children:["R$ ",((u.price||0)*(u.quantity||0)).toFixed(2)]})]},w))})]}),e.jsx(z,{}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["R$ ",d.toFixed(2)]})]}),s.delivery_fee&&s.delivery_fee>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Taxa de entrega:"}),e.jsxs("span",{children:["R$ ",s.delivery_fee.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between font-bold text-lg pt-2 border-t",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["R$ ",r.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:"Pagamento:"}),e.jsx("span",{className:"capitalize",children:s.payment_method})]})]}),s.observations&&e.jsxs(e.Fragment,{children:[e.jsx(z,{}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-1",children:"Observa√ß√µes"}),e.jsx("p",{className:"text-sm text-muted-foreground italic",children:s.observations})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[s.status!=="cancelled"&&s.status!=="completed"&&e.jsxs(A,{variant:"destructive",onClick:v,className:"flex-1",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Cancelar Pedido"]}),s.status!=="pending"&&s.status!=="cancelled"&&e.jsxs(A,{variant:"outline",onClick:()=>j(s,!0),disabled:_,className:"flex-1",children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),_?"Imprimindo...":"Reimprimir"]})]})]})]})})}function os({open:s,onClose:l,onConfirm:n,orderNumber:j}){const[v,y]=g.useState(""),_=()=>{v&&(n(v),y(""))};return e.jsx(ge,{open:s,onOpenChange:l,children:e.jsxs(je,{className:"max-w-md",children:[e.jsx(ve,{children:e.jsxs(be,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"w-5 h-5 text-destructive"}),"Cancelar Pedido #",j]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione o motivo do cancelamento:"}),e.jsx(Be,{value:v,onValueChange:y,children:ts.map(d=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ke,{value:d,id:d}),e.jsx(Qe,{htmlFor:d,className:"cursor-pointer",children:d})]},d))}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(A,{variant:"outline",onClick:l,className:"flex-1",children:"Voltar"}),e.jsx(A,{variant:"destructive",onClick:_,disabled:!v,className:"flex-1",children:"Confirmar Cancelamento"})]})]})]})})}function ls(){const{toast:s}=Ne(),l=He(),{companyId:n}=Ge(),[j,v]=g.useState(null),[y,_]=g.useState(!1),[d,r]=g.useState(null),[N,x]=g.useState(new Set),[u,w]=g.useState(""),[q,P]=g.useState(!1),[m,D]=g.useState(null),[L,we]=g.useState(!1),[_e,F]=g.useState(!1),[O,te]=g.useState({storeOpen:!0,autoAccept:!1,soundEnabled:!0,deliveryTime:30,pickupTime:45,alertTime:10,autoPrint:!0,notificationSound:"/sounds/default-notification.mp3",visibleColumns:{pending:!0,preparing:!0,ready:!0,delivering:!0,completed:!0,cancelled:!1}}),$=g.useCallback(()=>{m&&(m.pause(),m.currentTime=0,D(null))},[m]),{data:B=[],isLoading:Ce}=R({queryKey:["orders",n],queryFn:async()=>n?(console.log("Fetching orders via API for company:",n),(await X.getOrders(n)).data.map(a=>({...a,status:Y(a.status)}))):[],enabled:!!n,refetchInterval:!1,refetchOnWindowFocus:!1}),{data:I}=R({queryKey:["store-settings",n],queryFn:async()=>{if(!n)return null;const{data:t,error:a}=await S.from("store_settings").select("*").eq("company_id",n).single();if(a)throw a;return t},enabled:!!n}),{data:b}=R({queryKey:["company-data",n],queryFn:async()=>{if(!n)return null;const{data:t,error:a}=await S.from("companies").select("*").eq("id",n).single();if(a)throw a;return t},enabled:!!n}),K=I==null?void 0:I.printer_settings,Q=K==null?void 0:K.layout_configs;g.useEffect(()=>{const t=()=>{if(!L){const a=O.notificationSound||"/sounds/default-notification.mp3",o=new Audio(a);o.volume=.01,o.play().then(()=>{o.pause(),o.currentTime=0,we(!0),console.log("‚úÖ √Åudio pr√©-carregado com sucesso:",a)}).catch(()=>{console.log("‚è≥ Aguardando intera√ß√£o do usu√°rio para √°udio")})}};return document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0}),()=>{document.removeEventListener("click",t),document.removeEventListener("keydown",t),document.removeEventListener("touchstart",t)}},[L,O.notificationSound]),g.useEffect(()=>{if(!n)return;const t=S.channel("orders-realtime").on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:`company_id=eq.${n}`},a=>{if(console.log("üîî Real-time update received:",a),a.eventType==="INSERT"){const o=a.new;if(console.log("üÜï Novo pedido recebido:",o.order_number),$(),O.soundEnabled&&L){const p=O.notificationSound||"/sounds/default-notification.mp3",c=new Audio(p);c.loop=!0,c.volume=.7;const C=c.play();C!==void 0&&C.then(()=>{console.log("‚úÖ Som tocando:",p),D(c)}).catch(E=>{console.error("‚ùå Erro ao tocar som:",E),s({title:"üîá Som desabilitado",description:"Clique em qualquer lugar para habilitar notifica√ß√µes sonoras"})}),setTimeout(()=>{c.pause(),c.currentTime=0,D(null)},2e4)}s({title:"üéâ Novo Pedido!",description:`Pedido #${o.order_number} de ${o.customer_name}`})}l.invalidateQueries({queryKey:["orders",n]})}).subscribe(a=>{console.log("üîî Realtime subscription status:",a)});return()=>{$(),S.removeChannel(t)}},[n,O.soundEnabled,L,l,s,$]),R({queryKey:["store-settings",n],queryFn:async()=>{if(!n)return null;const{data:t}=await S.from("store_settings").select("*").eq("company_id",n).single();if(t){const a=t.visible_columns,o=t.printer_settings;te({storeOpen:t.store_open??!0,autoAccept:t.auto_accept??!1,soundEnabled:t.sound_enabled??!0,deliveryTime:t.delivery_time??30,pickupTime:t.pickup_time??45,alertTime:t.alert_time??10,autoPrint:(o==null?void 0:o.auto_print)??!0,notificationSound:t.notification_sound??"/sounds/default-notification.mp3",visibleColumns:{pending:(a==null?void 0:a.pending)??!0,preparing:(a==null?void 0:a.preparing)??!0,ready:(a==null?void 0:a.ready)??!0,delivering:(a==null?void 0:a.delivering)??!0,completed:(a==null?void 0:a.completed)??!0,cancelled:(a==null?void 0:a.cancelled)??!1}})}return t},enabled:!!n,refetchInterval:!1,refetchOnWindowFocus:!1});const M=le({mutationFn:async({orderId:t,status:a,previousStatus:o,order:p,cancellationReason:c})=>{var C;if(!n)throw new Error("Company not found");if(await X.updateOrderStatus(t,a,n),o==="pending"&&a==="preparing"&&p){$();const{data:E}=await S.from("store_settings").select("printer_settings").eq("company_id",n).single(),k=E==null?void 0:E.printer_settings;if((k==null?void 0:k.auto_print)??!0){const{data:i}=await S.from("companies").select("*").eq("id",n).single(),ie=f=>f?typeof f=="string"?f:[f.street&&f.number?`${f.street}, ${f.number}`:f.street,f.complement,f.neighborhood,f.city&&f.state?`${f.city} - ${f.state}`:f.city,f.zip_code?`CEP: ${f.zip_code}`:null].filter(Boolean).join(`
`):"",$e={...p,company_name:(i==null?void 0:i.name)||"EMPRESA",company_fantasy_name:(i==null?void 0:i.fantasy_name)||(i==null?void 0:i.name),company_phone:(i==null?void 0:i.phone)||"",company_address:ie(i==null?void 0:i.address),company_email:(i==null?void 0:i.email)||""},T=(C=k==null?void 0:k.sectors)==null?void 0:C.caixa;T!=null&&T.enabled&&(T!=null&&T.printer_name)&&J.printOrder($e,T.printer_name,!1,"caixa",T.layout,T.copies||1).then(()=>console.log("‚úÖ Impress√£o autom√°tica realizada")).catch(f=>console.error("‚ùå Erro na impress√£o autom√°tica:",f))}}return{orderId:t,status:a}},onMutate:async({orderId:t,status:a})=>{await l.cancelQueries({queryKey:["orders",n]});const o=l.getQueryData(["orders",n]);return l.setQueryData(["orders",n],p=>p&&p.map(c=>c.id===t?{...c,status:a,updated_at:new Date().toISOString()}:c)),{previousOrders:o}},onSuccess:()=>{s({title:"Status atualizado",description:"O status do pedido foi atualizado com sucesso."})},onError:(t,a,o)=>{o!=null&&o.previousOrders&&l.setQueryData(["orders",n],o.previousOrders),s({title:"Erro",description:"Erro ao atualizar status do pedido.",variant:"destructive"})}}),Se=le({mutationFn:async t=>{if(!n)throw new Error("Company not found");await X.updateStoreSettings(n,t)},onSuccess:()=>{l.invalidateQueries({queryKey:["store-settings",n]})}}),ae=async(t,a=!1)=>{var o,p;console.log("=".repeat(50)),console.log("üñ®Ô∏è IN√çCIO DO PROCESSO DE IMPRESS√ÉO"),console.log("Pedido:",t.order_number),console.log("Status atual:",t.status),console.log("Reimpress√£o:",a),console.log("QZ Tray dispon√≠vel?",typeof window<"u"&&typeof window.qz<"u"),console.log("Order completo recebido:",{id:t.id,order_number:t.order_number,customer_name:t.customer_name,items_count:(o=t.items)==null?void 0:o.length}),P(!0);try{console.log("Chamando qzPrinter.printOrder...");const c=i=>i?typeof i=="string"?i:[i.street&&i.number?`${i.street}, ${i.number}`:i.street,i.complement,i.neighborhood,i.city&&i.state?`${i.city} - ${i.state}`:i.city,i.zip_code?`CEP: ${i.zip_code}`:null].filter(Boolean).join(`
`):"",C={...t,company_name:(b==null?void 0:b.name)||"EMPRESA",company_fantasy_name:(b==null?void 0:b.fantasy_name)||(b==null?void 0:b.name)||"EMPRESA",company_phone:(b==null?void 0:b.phone)||"",company_address:c(b==null?void 0:b.address),company_email:(b==null?void 0:b.email)||""};console.log("‚úÖ Order enriquecido com dados da empresa:",{hasCompanyName:!!C.company_name,hasCompanyPhone:!!C.company_phone,hasCompanyAddress:!!C.company_address,hasCompanyEmail:!!C.company_email,orderNumber:C.order_number});const E="caixa",k=I==null?void 0:I.printer_settings,h=(p=k==null?void 0:k.sectors)==null?void 0:p[E];if(console.log("üñ®Ô∏è Configura√ß√£o de impress√£o:",{sector:E,enabled:h==null?void 0:h.enabled,printer:h==null?void 0:h.printer_name,copies:h==null?void 0:h.copies,hasLayout:!!(h!=null&&h.layout)}),h!=null&&h.enabled&&(h!=null&&h.printer_name))await J.printOrder(C,h.printer_name,a,E,h.layout,h.copies||1);else{const i=Q==null?void 0:Q[E];await J.printOrder(C,void 0,a,E,i,1)}console.log("‚úÖ Impress√£o conclu√≠da com sucesso!"),s({title:"‚úÖ Impress√£o enviada",description:a?"Reimpress√£o enviada para a impressora com sucesso.":"O pedido foi enviado para a impressora com sucesso."})}catch(c){console.error("=".repeat(50)),console.error("‚ùå ERRO AO IMPRIMIR"),console.error("Tipo do erro:",typeof c),console.error("Erro completo:",c),console.error("Stack:",c==null?void 0:c.stack),console.error("=".repeat(50));const C=(c==null?void 0:c.message)||String(c)||"Erro desconhecido ao imprimir";s({title:"‚ùå Erro ao imprimir",description:C,variant:"destructive"})}finally{P(!1),console.log("‚úì Processo de impress√£o finalizado"),console.log("=".repeat(50))}},Oe=(t,a)=>{r(a),t.dataTransfer.effectAllowed="move",t.currentTarget instanceof HTMLElement&&(t.currentTarget.style.opacity="0.5")},Ee=t=>{r(null),t.currentTarget instanceof HTMLElement&&(t.currentTarget.style.opacity="")},ke=t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="move"},Te=(t,a)=>{t.preventDefault(),d&&d.status!==a&&M.mutate({orderId:d.id,status:a,previousStatus:d.status,order:d}),r(null)},ne=(t,a,o,p,c)=>{M.mutate({orderId:t,status:a,previousStatus:o,order:p,cancellationReason:c})},Ae=t=>{const a=new Set(N);a.has(t)?a.delete(t):a.add(t),x(a)},qe=t=>{N.forEach(a=>{M.mutate({orderId:a,status:t})}),x(new Set)},re=(t,a)=>{if(!t){s({title:"Telefone n√£o dispon√≠vel",variant:"destructive"});return}const o=t.replace(/\D/g,""),p=`Ol√°! Sobre o pedido #${a}, como posso ajudar?`,c=`https://wa.me/55${o}?text=${encodeURIComponent(p)}`;window.open(c,"_blank")};g.useEffect(()=>{O.autoAccept&&B.filter(a=>a.status==="pending").forEach(a=>{ne(a.id,"preparing",a.status,a)})},[O.autoAccept,B]);const Pe=t=>{te(a=>({...a,...t})),Se.mutate(t)},Ie=t=>{j&&(M.mutate({orderId:j.id,status:"cancelled",cancellationReason:t}),F(!1),v(null))},Re=B.filter(t=>{var o,p,c;if(!u)return!0;const a=u.toLowerCase();return((o=t.order_number)==null?void 0:o.toLowerCase().includes(a))||((p=t.customer_name)==null?void 0:p.toLowerCase().includes(a))||((c=t.customer_phone)==null?void 0:c.includes(u))});return Ce?e.jsxs("div",{className:"flex items-center justify-center h-screen",children:[e.jsx(Ue,{className:"w-8 h-8 animate-spin"}),e.jsx("span",{className:"ml-3 text-lg",children:"Carregando pedidos..."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(as,{settings:O,onSettingsChange:Pe,searchTerm:u,onSearchChange:w,showFilters:y,onToggleFilters:()=>_(!y),selectedOrdersCount:N.size,onBulkStatusChange:qe}),e.jsx("div",{className:"flex gap-4 overflow-x-auto pb-4 min-h-[500px]",children:Z.filter(t=>t.id==="pending"&&O.autoAccept?!1:O.visibleColumns[t.id]).map(t=>{const a=Re.filter(p=>Y(p.status)===t.id),o=d&&Y(d.status)!==t.id;return e.jsx(rs,{column:t,orders:a,onDrop:Te,onDragOver:ke,onCardClick:p=>{$(),v(p)},onCardSelect:Ae,selectedOrders:N,onPrintOrder:ae,onUpdateStatus:ne,onDragStart:Oe,onDragEnd:Ee,alertTime:O.alertTime,isPrinting:q,isDraggedOver:!!o,onOpenWhatsApp:re},t.id)})}),e.jsx(is,{order:j,open:!!j,onClose:()=>v(null),onPrint:ae,onCancel:()=>F(!0),onOpenWhatsApp:re,isPrinting:q}),e.jsx(os,{open:_e,onClose:()=>F(!1),onConfirm:Ie,orderNumber:(j==null?void 0:j.order_number)||""})]})}function hs(){const{toast:s}=Ne(),[l,n]=g.useState(!0),[j,v]=g.useState(""),[y,_]=g.useState(""),[d,r]=g.useState(null);R({queryKey:["company-info"],queryFn:async()=>{const{data:{user:x}}=await S.auth.getUser();if(!x)return null;const{data:u}=await S.from("profiles").select("role, company_id").eq("id",x.id).single(),{data:w}=await S.from("companies").select("*").eq("id",u==null?void 0:u.company_id).single();return w&&(v(w.fantasy_name||w.name),_(w.subdomain),r(w.id)),w}}),R({queryKey:["store-settings",d],queryFn:async()=>{if(!d)return null;const{data:x}=await S.from("store_settings").select("*").eq("company_id",d).single();return x&&n(x.store_open||!1),x},enabled:!!d});const N=async()=>{if(d)try{const x=!l,{error:u}=await S.from("store_settings").update({store_open:x}).eq("company_id",d);if(u)throw u;n(x),s({title:x?"Loja Aberta":"Loja Fechada",description:x?"Sua loja est√° agora aberta e recebendo pedidos.":"Sua loja est√° fechada e n√£o receber√° novos pedidos."})}catch{s({title:"Erro",description:"N√£o foi poss√≠vel alterar o status da loja.",variant:"destructive"})}};return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx("header",{className:"bg-card/50 backdrop-blur border-b border-border sticky top-0 z-10",children:e.jsx("div",{className:"px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ve,{children:e.jsx(We,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold",children:"Gest√£o de Pedidos"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y?`${y}.anafood.vip`:"Configure seu dom√≠nio"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Je,{}),e.jsxs(A,{variant:l?"default":"destructive",size:"sm",onClick:N,children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),l?"Loja Aberta":"Loja Fechada"]})]})]})})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx("div",{className:"h-full p-6",children:e.jsx(ls,{})})})]})}export{hs as default};
