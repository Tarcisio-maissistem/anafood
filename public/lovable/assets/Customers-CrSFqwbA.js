import{r as g,u as D,aV as L,aZ as P,aH as b,x as l,aW as w,j as e,C as k,b as B,d as H,B as u,T as K,f as O,P as Q,I as r,a_ as A,a$ as I,b0 as _,b1 as x,b2 as R,b3 as j,a7 as U,M as $,aT as V,b4 as W,ab as Z,ac as G,ad as J,ae as X,aK as o,b5 as Y,ah as ee}from"./index-DebmrVr5.js";import{S as se}from"./square-pen-DWZLd2w9.js";function te(){const[d,E]=g.useState(""),[F,p]=g.useState(!1),[c,v]=g.useState(null),[a,i]=g.useState({name:"",phone:"",email:"",address:"",neighborhood:"",city:"",state:"",zip_code:"",notes:""}),{toast:h}=D(),C=L(),{isAdmin:m}=P(),{data:t}=b({queryKey:["profile"],queryFn:async()=>{const{data:{user:s}}=await l.auth.getUser();if(!s)return null;const{data:n}=await l.from("profiles").select("company_id").eq("id",s.id).single();return n}}),{data:T=[],isLoading:z}=b({queryKey:["customers",t==null?void 0:t.company_id,m],queryFn:async()=>{if(!(t!=null&&t.company_id))return console.log("No company_id found for customers query"),[];console.log("Fetching customers for company:",t.company_id);const{data:s,error:n}=await l.from("customers").select("*").eq("company_id",t.company_id).order("name");if(n)throw console.error("Error fetching customers:",n),n;return console.log("Customers fetched:",s),s},enabled:!!(t!=null&&t.company_id)}),q=w({mutationFn:async s=>{if(!(t!=null&&t.company_id))throw new Error("Company ID not found");if(c){const{error:n}=await l.from("customers").update(s).eq("id",c.id);if(n)throw n}else{const{error:n}=await l.from("customers").insert([{name:s.name||"",phone:s.phone||"",email:s.email,address:s.address,neighborhood:s.neighborhood,city:s.city,state:s.state,zip_code:s.zip_code,notes:s.notes,company_id:t.company_id}]);if(n)throw n}},onSuccess:()=>{C.invalidateQueries({queryKey:["customers"]}),h({title:c?"Cliente atualizado":"Cliente cadastrado",description:"Operação realizada com sucesso."}),y()},onError:s=>{h({title:"Erro ao salvar cliente",description:s.message,variant:"destructive"})}}),S=w({mutationFn:async s=>{const{error:n}=await l.from("customers").delete().eq("id",s);if(n)throw n},onSuccess:()=>{C.invalidateQueries({queryKey:["customers"]}),h({title:"Cliente excluído",description:"Cliente removido com sucesso."})},onError:s=>{h({title:"Erro ao excluir cliente",description:s.message,variant:"destructive"})}}),f=s=>{s?(v(s),i(s)):(v(null),i({name:"",phone:"",email:"",address:"",neighborhood:"",city:"",state:"",zip_code:"",notes:""})),p(!0)},y=()=>{p(!1),v(null),i({name:"",phone:"",email:"",address:"",neighborhood:"",city:"",state:"",zip_code:"",notes:""})},M=()=>{if(!a.name||!a.phone){h({title:"Campos obrigatórios",description:"Nome e telefone são obrigatórios.",variant:"destructive"});return}q.mutate(a)},N=T.filter(s=>{var n;return s.name.toLowerCase().includes(d.toLowerCase())||s.phone.includes(d)||((n=s.email)==null?void 0:n.toLowerCase().includes(d.toLowerCase()))});return e.jsxs("div",{className:"p-6",children:[e.jsxs(k,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(H,{className:"text-2xl font-bold",children:"Clientes"}),m&&e.jsxs(u,{onClick:()=>f(),children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Novo Cliente"]})]})}),e.jsxs(O,{children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(r,{placeholder:"Buscar por nome, telefone ou email...",value:d,onChange:s=>E(s.target.value),className:"pl-10"})]})}),z?e.jsx("div",{className:"text-center py-8",children:"Carregando..."}):N.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:d?"Nenhum cliente encontrado.":"Nenhum cliente cadastrado."}):e.jsxs(A,{children:[e.jsx(I,{children:e.jsxs(_,{children:[e.jsx(x,{children:"Nome"}),e.jsx(x,{children:"Telefone"}),e.jsx(x,{children:"Email"}),e.jsx(x,{children:"Endereço"}),e.jsx(x,{className:"text-right",children:"Ações"})]})}),e.jsx(R,{children:N.map(s=>e.jsxs(_,{children:[e.jsx(j,{className:"font-medium",children:s.name}),e.jsx(j,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(U,{className:"h-3 w-3 text-muted-foreground"}),s.phone]})}),e.jsx(j,{children:m?s.email&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{className:"h-3 w-3 text-muted-foreground"}),s.email]}):e.jsx("span",{className:"text-muted-foreground",children:"***@***.com"})}),e.jsx(j,{children:m?s.address&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-3 w-3 text-muted-foreground"}),s.address,s.neighborhood&&`, ${s.neighborhood}`]}):e.jsx("span",{className:"text-muted-foreground",children:"***"})}),e.jsx(j,{className:"text-right",children:m?e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>f(s),title:"Editar",children:e.jsx(se,{className:"h-4 w-4"})}),e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>{confirm("Deseja realmente excluir este cliente?")&&S.mutate(s.id)},title:"Excluir",children:e.jsx(W,{className:"h-4 w-4 text-destructive"})})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Sem permissão"})})]},s.id))})]})]})]}),e.jsx(Z,{open:F,onOpenChange:p,children:e.jsxs(G,{className:"max-w-2xl",children:[e.jsx(J,{children:e.jsx(X,{children:c?"Editar Cliente":"Novo Cliente"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"name",children:"Nome *"}),e.jsx(r,{id:"name",value:a.name,onChange:s=>i({...a,name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"phone",children:"Telefone *"}),e.jsx(r,{id:"phone",value:a.phone,onChange:s=>i({...a,phone:s.target.value})})]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"email",children:"Email"}),e.jsx(r,{id:"email",type:"email",value:a.email,onChange:s=>i({...a,email:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"address",children:"Endereço"}),e.jsx(r,{id:"address",value:a.address,onChange:s=>i({...a,address:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"neighborhood",children:"Bairro"}),e.jsx(r,{id:"neighborhood",value:a.neighborhood,onChange:s=>i({...a,neighborhood:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"city",children:"Cidade"}),e.jsx(r,{id:"city",value:a.city,onChange:s=>i({...a,city:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"state",children:"Estado"}),e.jsx(r,{id:"state",value:a.state,onChange:s=>i({...a,state:s.target.value}),maxLength:2})]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"zip_code",children:"CEP"}),e.jsx(r,{id:"zip_code",value:a.zip_code,onChange:s=>i({...a,zip_code:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"notes",children:"Observações"}),e.jsx(Y,{id:"notes",value:a.notes,onChange:s=>i({...a,notes:s.target.value}),rows:3})]})]}),e.jsxs(ee,{children:[e.jsx(u,{variant:"outline",onClick:y,children:"Cancelar"}),e.jsx(u,{onClick:M,children:c?"Atualizar":"Cadastrar"})]})]})})]})}export{te as Customers};

