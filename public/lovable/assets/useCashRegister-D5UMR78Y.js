import{c as q,u as I,aV as D,aH as v,x as n,aW as p}from"./index-v68zVK4x.js";import{u as K}from"./useCompanyId-BPuD7pC1.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=q("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=q("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);function P(){const{companyId:c}=K(),{toast:l}=I(),_=D(),{data:r,isLoading:x}=v({queryKey:["cash-register-active",c],queryFn:async()=>{if(!c)return null;const{data:e,error:a}=await n.from("cash_registers").select("*").eq("company_id",c).eq("status","open").order("opened_at",{ascending:!1}).limit(1).maybeSingle();if(a)throw a;return e},enabled:!!c}),{data:d}=v({queryKey:["cash-register-summary",r==null?void 0:r.id],queryFn:async()=>{if(!(r!=null&&r.id))return null;const{data:e,error:a}=await n.from("cash_movements").select("*").eq("cash_register_id",r.id).order("created_at",{ascending:!0});if(a)throw a;const{data:o}=await n.from("check_payments").select("amount, payment_method_type").eq("cash_register_id",r.id).eq("status","completed"),{data:u}=await n.from("checks").select("id, total_amount").eq("cash_register_id",r.id).eq("status","closed"),s=(u==null?void 0:u.length)||0,m=(o==null?void 0:o.reduce((t,i)=>t+i.amount,0))||0,f=(o==null?void 0:o.filter(t=>t.payment_method_type==="cash").reduce((t,i)=>t+i.amount,0))||0,b=(o==null?void 0:o.filter(t=>["credit","debit"].includes(t.payment_method_type||"")).reduce((t,i)=>t+i.amount,0))||0,w=(o==null?void 0:o.filter(t=>t.payment_method_type==="pix").reduce((t,i)=>t+i.amount,0))||0,k=(o==null?void 0:o.filter(t=>t.payment_method_type==="credit").reduce((t,i)=>t+i.amount,0))||0,C=(o==null?void 0:o.filter(t=>t.payment_method_type==="debit").reduce((t,i)=>t+i.amount,0))||0,M=(e==null?void 0:e.filter(t=>t.movement_type==="withdrawal").reduce((t,i)=>t+i.amount,0))||0,S=(e==null?void 0:e.filter(t=>t.movement_type==="deposit").reduce((t,i)=>t+i.amount,0))||0,O=s>0?m/s:0,F=[{type:"cash",name:"Dinheiro",total:f},{type:"pix",name:"PIX",total:w},{type:"credit",name:"Cartão Crédito",total:k},{type:"debit",name:"Cartão Débito",total:C}].filter(t=>t.total>0);return{...r,movements:e||[],total_sales:m,total_cash:f,total_card:b,total_pix:w,total_withdrawals:M,total_deposits:S,total_checks:s,average_ticket:O,payments_by_type:F}},enabled:!!(r!=null&&r.id)}),h=p({mutationFn:async e=>{if(!c)throw new Error("Company ID not found");const{data:a}=await n.auth.getUser();if(!a.user)throw new Error("User not authenticated");const{data:o}=await n.from("profiles").select("full_name").eq("id",a.user.id).single(),{data:u,error:s}=await n.from("cash_registers").insert({company_id:c,operator_id:a.user.id,operator_name:(o==null?void 0:o.full_name)||"Operador",opening_amount:e.opening_amount,opening_notes:e.opening_notes,terminal_name:e.terminal_name,status:"open",opened_at:new Date().toISOString()}).select().single();if(s)throw s;return u},onSuccess:()=>{_.invalidateQueries({queryKey:["cash-register-active",c]}),l({title:"Caixa aberto",description:"O caixa foi aberto com sucesso."})},onError:e=>{l({title:"Erro ao abrir caixa",description:"Não foi possível abrir o caixa.",variant:"destructive"}),console.error("Error opening register:",e)}}),g=p({mutationFn:async e=>{var m;if(!r)throw new Error("No active register");const{data:a}=await n.auth.getUser(),o=r.opening_amount+((d==null?void 0:d.total_cash)||0)+((d==null?void 0:d.total_deposits)||0)-((d==null?void 0:d.total_withdrawals)||0),{data:u,error:s}=await n.from("cash_registers").update({status:"closed",closed_at:new Date().toISOString(),closed_by:(m=a.user)==null?void 0:m.id,closing_amount:e.closing_amount,closing_notes:e.closing_notes,expected_amount:o,difference:e.closing_amount-o}).eq("id",r.id).select().single();if(s)throw s;return u},onSuccess:()=>{_.invalidateQueries({queryKey:["cash-register-active",c]}),l({title:"Caixa fechado",description:"O caixa foi fechado com sucesso."})},onError:e=>{l({title:"Erro ao fechar caixa",description:"Não foi possível fechar o caixa.",variant:"destructive"}),console.error("Error closing register:",e)}}),E=p({mutationFn:async e=>{if(!r||!c)throw new Error("No active register");const{data:a}=await n.auth.getUser();if(!a.user)throw new Error("User not authenticated");const{data:o}=await n.from("profiles").select("full_name").eq("id",a.user.id).single(),{data:u,error:s}=await n.from("cash_movements").insert({cash_register_id:r.id,company_id:c,created_by:a.user.id,created_by_name:(o==null?void 0:o.full_name)||"Operador",movement_type:e.movement_type,amount:e.amount,reason:e.reason}).select().single();if(s)throw s;return u},onSuccess:(e,a)=>{_.invalidateQueries({queryKey:["cash-register-summary",r==null?void 0:r.id]}),l({title:a.movement_type==="withdrawal"?"Sangria registrada":"Suprimento registrado",description:`Valor: R$ ${a.amount.toFixed(2)}`})},onError:e=>{l({title:"Erro ao registrar movimentação",description:"Não foi possível registrar a movimentação.",variant:"destructive"}),console.error("Error adding movement:",e)}}),y=p({mutationFn:async e=>{const{error:a}=await n.from("cash_movements").delete().eq("id",e);if(a)throw a},onSuccess:()=>{_.invalidateQueries({queryKey:["cash-register-summary",r==null?void 0:r.id]}),l({title:"Movimentação removida",description:"A movimentação foi removida com sucesso."})},onError:e=>{l({title:"Erro ao remover movimentação",description:"Não foi possível remover a movimentação.",variant:"destructive"}),console.error("Error deleting movement:",e)}});return{activeRegister:r,summary:d,isLoading:x,isRegisterOpen:!!r,openRegister:h.mutate,closeRegister:g.mutate,addMovement:E.mutate,deleteMovement:y.mutate,isOpening:h.isPending,isClosing:g.isPending,isDeleting:y.isPending}}export{U as B,H,P as u};
