import{r as m,u as Q,aV as z,aH as v,x as r,aW as N,j as e,C as H,b as L,d as A,B as d,T as I,f as P,P as O,I as b,a_ as R,a$ as $,b0 as q,b1 as l,b2 as U,b3 as u,aj as S,b4 as V,ab as W,ac as G,ad as J,ae as X,aK as D,aQ as Y,ah as Z}from"./index-DebmrVr5.js";import{S as ee}from"./square-pen-DWZLd2w9.js";function te(){const[h,E]=m.useState(""),[T,x]=m.useState(!1),[o,f]=m.useState(null),[n,c]=m.useState({name:"",on_off:!0}),{toast:i}=Q(),j=z(),{data:s}=v({queryKey:["profile"],queryFn:async()=>{const{data:{user:a}}=await r.auth.getUser();if(!a)return null;const{data:t}=await r.from("profiles").select("company_id").eq("id",a.id).single();return t}}),{data:F=[],isLoading:k}=v({queryKey:["categories",s==null?void 0:s.company_id],queryFn:async()=>{if(!(s!=null&&s.company_id))return[];const{data:a,error:t}=await r.from("categories").select("*").eq("company_id",s.company_id).order("name");if(t)throw t;return a},enabled:!!(s!=null&&s.company_id)}),{data:y={}}=v({queryKey:["product-counts",s==null?void 0:s.company_id],queryFn:async()=>{if(!(s!=null&&s.company_id))return{};const{data:a,error:t}=await r.from("products").select("category_id").eq("company_id",s.company_id);if(t)throw t;const g={};return a==null||a.forEach(C=>{C.category_id&&(g[C.category_id]=(g[C.category_id]||0)+1)}),g},enabled:!!(s!=null&&s.company_id)}),K=N({mutationFn:async a=>{if(!(s!=null&&s.company_id))throw new Error("Company ID not found");if(o){const{error:t}=await r.from("categories").update(a).eq("id",o.id);if(t)throw t}else{const{error:t}=await r.from("categories").insert([{name:a.name||"",on_off:a.on_off,company_id:s.company_id}]);if(t)throw t}},onSuccess:()=>{j.invalidateQueries({queryKey:["categories"]}),i({title:o?"Categoria atualizada":"Categoria cadastrada",description:"Operação realizada com sucesso."}),_()},onError:a=>{i({title:"Erro ao salvar categoria",description:a.message,variant:"destructive"})}}),M=N({mutationFn:async a=>{const{error:t}=await r.from("categories").delete().eq("id",a);if(t)throw t},onSuccess:()=>{j.invalidateQueries({queryKey:["categories"]}),j.invalidateQueries({queryKey:["product-counts"]}),i({title:"Categoria excluída",description:"Categoria removida com sucesso."})},onError:a=>{i({title:"Erro ao excluir categoria",description:a.message,variant:"destructive"})}}),p=a=>{a?(f(a),c(a)):(f(null),c({name:"",on_off:!0})),x(!0)},_=()=>{x(!1),f(null),c({name:"",on_off:!0})},B=()=>{if(!n.name){i({title:"Campo obrigatório",description:"Nome é obrigatório.",variant:"destructive"});return}K.mutate(n)},w=F.filter(a=>a.name.toLowerCase().includes(h.toLowerCase()));return e.jsxs("div",{className:"container mx-auto p-6",children:[e.jsxs(H,{children:[e.jsx(L,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(A,{className:"text-2xl font-bold",children:"Categorias"}),e.jsxs(d,{onClick:()=>p(),children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),"Nova Categoria"]})]})}),e.jsxs(P,{children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(O,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(b,{placeholder:"Buscar categorias...",value:h,onChange:a=>E(a.target.value),className:"pl-10"})]})}),k?e.jsx("div",{className:"text-center py-8",children:"Carregando..."}):w.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:h?"Nenhuma categoria encontrada.":"Nenhuma categoria cadastrada."}):e.jsxs(R,{children:[e.jsx($,{children:e.jsxs(q,{children:[e.jsx(l,{children:"Nome"}),e.jsx(l,{children:"Produtos"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Criada em"}),e.jsx(l,{className:"text-right",children:"Ações"})]})}),e.jsx(U,{children:w.map(a=>e.jsxs(q,{children:[e.jsx(u,{className:"font-medium",children:a.name}),e.jsx(u,{children:e.jsxs(S,{variant:"outline",children:[y[a.id]||0," produtos"]})}),e.jsx(u,{children:e.jsx(S,{variant:a.on_off?"default":"secondary",children:a.on_off?"Ativa":"Inativa"})}),e.jsx(u,{children:a.created_at&&new Date(a.created_at).toLocaleDateString("pt-BR")}),e.jsxs(u,{className:"text-right",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>p(a),children:e.jsx(ee,{className:"h-4 w-4"})}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>{const t=y[a.id]||0;t>0?i({title:"Não é possível excluir",description:`Esta categoria possui ${t} produto(s) associado(s).`,variant:"destructive"}):confirm("Deseja realmente excluir esta categoria?")&&M.mutate(a.id)},children:e.jsx(V,{className:"h-4 w-4 text-destructive"})})]})]},a.id))})]})]})]}),e.jsx(W,{open:T,onOpenChange:x,children:e.jsxs(G,{children:[e.jsx(J,{children:e.jsx(X,{children:o?"Editar Categoria":"Nova Categoria"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{children:[e.jsx(D,{htmlFor:"name",children:"Nome *"}),e.jsx(b,{id:"name",value:n.name,onChange:a=>c({...n,name:a.target.value})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(D,{htmlFor:"on_off",children:"Categoria Ativa"}),e.jsx(Y,{id:"on_off",checked:n.on_off,onCheckedChange:a=>c({...n,on_off:a})})]})]}),e.jsxs(Z,{children:[e.jsx(d,{variant:"outline",onClick:_,children:"Cancelar"}),e.jsx(d,{onClick:B,children:o?"Atualizar":"Cadastrar"})]})]})})]})}export{te as Categories};

