import{c as Z,u as ee,aV as se,r as x,aH as L,x as t,aW as V,j as e,aI as ae,aw as re,C as ie,b as oe,d as ne,e as te,B as p,f as le,P as ce,I as T,a_ as de,a$ as me,b0 as B,b1 as v,b2 as ue,b3 as N,aj as A,b4 as he,ab as xe,ac as je,ad as fe,ae as pe,af as ge,aK as U,M as ve,N as k,S as Ne,m as ye,n as we,p as be,q as H,ah as Ce,o as Ee,s as Q,bM as Se}from"./index-DebmrVr5.js";import{A as _e,a as De,b as Te,c as Ae,d as Ue,e as ke,f as Ie,g as Pe}from"./alert-dialog-9XA5iY7m.js";import{U as qe}from"./user-plus-BW64w261.js";import{S as Me}from"./square-pen-DWZLd2w9.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=Z("CircleUser",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}],["path",{d:"M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662",key:"154egf"}]]),Oe=Ee({email:Q().email({message:"Email inválido"}),fullName:Q().min(3,{message:"Nome deve ter no mínimo 3 caracteres"}),role:Se(["company_admin","company_staff"],{errorMap:()=>({message:"Role inválido"})})});function He(){const{toast:j}=ee(),P=se(),[g,R]=x.useState(""),[K,y]=x.useState(!1),[G,w]=x.useState(!1),[o,f]=x.useState(null),[c,d]=x.useState({email:"",fullName:"",role:"company_staff"}),[m,b]=x.useState({}),{data:a}=L({queryKey:["profile"],queryFn:async()=>{const{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("User not found");const{data:i,error:r}=await t.from("profiles").select("company_id, id").eq("id",s.id).single();if(r)throw r;return i}}),{data:q=[],isLoading:$}=L({queryKey:["company-users",a==null?void 0:a.company_id],queryFn:async()=>{if(!(a!=null&&a.company_id))return[];const{data:s,error:i}=await t.from("user_roles").select("user_id, role").eq("company_id",a.company_id);if(i)throw i;if(!s||s.length===0)return[];const r=s.map(u=>u.user_id),{data:l,error:n}=await t.from("profiles").select("id, full_name").in("id",r);if(n)throw n;const{data:{users:S},error:z}=await t.auth.admin.listUsers();return z&&console.error("Error fetching auth users:",z),s.map(u=>{const _=l==null?void 0:l.find(D=>D.id===u.user_id),h=S==null?void 0:S.find(D=>D.id===u.user_id);return{id:u.user_id,email:(h==null?void 0:h.email)||"Email não disponível",full_name:(_==null?void 0:_.full_name)||null,role:u.role,created_at:(h==null?void 0:h.created_at)||new Date().toISOString()}})},enabled:!!(a!=null&&a.company_id)}),M=q.filter(s=>{var i;return((i=s.full_name)==null?void 0:i.toLowerCase().includes(g.toLowerCase()))||s.email.toLowerCase().includes(g.toLowerCase())}),C=V({mutationFn:async s=>{var r,l;if(!(a!=null&&a.company_id))throw new Error("Company ID not found");const{data:{session:i}}=await t.auth.getSession();if(!i)throw new Error("Sessão não encontrada");if(s.userId){const n=await t.functions.invoke("user-management",{body:{userId:s.userId,fullName:s.fullName,role:s.role},headers:{"Content-Type":"application/json"},method:"POST"});if(n.error)throw new Error(n.error.message);if((r=n.data)!=null&&r.error)throw new Error(n.data.error)}else{const n=await t.functions.invoke("user-management",{body:{email:s.email,fullName:s.fullName,role:s.role,companyId:a.company_id},headers:{"Content-Type":"application/json"},method:"POST"});if(n.error)throw new Error(n.error.message);if((l=n.data)!=null&&l.error)throw new Error(n.data.error)}},onSuccess:()=>{P.invalidateQueries({queryKey:["company-users"]}),j({title:"Sucesso",description:o?"Usuário atualizado com sucesso":"Usuário criado com sucesso! Um email de confirmação foi enviado para o novo usuário."}),F()},onError:s=>{console.error("Error saving user:",s),j({title:"Erro",description:s.message||"Erro ao salvar usuário",variant:"destructive"})}}),E=V({mutationFn:async s=>{var l;if(s===(a==null?void 0:a.id))throw new Error("Você não pode excluir sua própria conta");const{data:{session:i}}=await t.auth.getSession();if(!i)throw new Error("Sessão não encontrada");const r=await t.functions.invoke("user-management",{body:{userId:s,currentUserId:a==null?void 0:a.id},headers:{"Content-Type":"application/json"},method:"POST"});if(r.error)throw new Error(r.error.message);if((l=r.data)!=null&&l.error)throw new Error(r.data.error)},onSuccess:()=>{P.invalidateQueries({queryKey:["company-users"]}),j({title:"Sucesso",description:"Usuário excluído com sucesso"}),w(!1),f(null)},onError:s=>{console.error("Error deleting user:",s),j({title:"Erro",description:s.message||"Erro ao excluir usuário",variant:"destructive"})}}),O=s=>{s?(f(s),d({email:s.email,fullName:s.full_name||"",role:s.role})):(f(null),d({email:"",fullName:"",role:"company_staff"})),b({}),y(!0)},F=()=>{y(!1),f(null),d({email:"",fullName:"",role:"company_staff"}),b({})},J=()=>{const s=Oe.safeParse(c);if(!s.success){const i={};s.error.errors.forEach(r=>{r.path[0]&&(i[r.path[0]]=r.message)}),b(i);return}C.mutate({...c,userId:o==null?void 0:o.id})},W=s=>{if(s.id===(a==null?void 0:a.id)){j({title:"Ação não permitida",description:"Você não pode excluir sua própria conta",variant:"destructive"});return}f(s),w(!0)},X=()=>{o&&E.mutate(o.id)},Y=s=>s==="company_admin"?e.jsxs(A,{variant:"default",className:"gap-1",children:[e.jsx(k,{className:"w-3 h-3"})," Admin"]}):e.jsx(A,{variant:"secondary",children:"Usuário"});return e.jsxs("div",{className:"flex flex-col h-screen",children:[e.jsx("header",{className:"bg-card/50 backdrop-blur border-b border-border sticky top-0 z-10",children:e.jsx("div",{className:"px-4 py-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ae,{className:"lg:hidden"}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(re,{className:"w-6 h-6"}),"Gerenciamento de Usuários"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Gerencie os usuários e permissões da sua empresa"})]})]})})})}),e.jsx("div",{className:"flex-1 overflow-auto p-6",children:e.jsxs(ie,{children:[e.jsx(oe,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx(ne,{children:"Usuários da Empresa"}),e.jsxs(te,{children:[q.length," usuário(s) cadastrado(s)"]})]}),e.jsxs(p,{onClick:()=>O(),className:"gap-2",children:[e.jsx(qe,{className:"w-4 h-4"}),"Adicionar Usuário"]})]})}),e.jsxs(le,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(T,{placeholder:"Buscar por nome ou email...",value:g,onChange:s=>R(s.target.value),className:"pl-10"})]})}),$?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Carregando usuários..."}):M.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:g?"Nenhum usuário encontrado":"Nenhum usuário cadastrado"}):e.jsx("div",{className:"rounded-md border",children:e.jsxs(de,{children:[e.jsx(me,{children:e.jsxs(B,{children:[e.jsx(v,{children:"Usuário"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Role"}),e.jsx(v,{className:"text-right",children:"Ações"})]})}),e.jsx(ue,{children:M.map(s=>e.jsxs(B,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:s.full_name||"Sem nome"}),s.id===(a==null?void 0:a.id)&&e.jsx(A,{variant:"outline",className:"text-xs",children:"Você"})]})}),e.jsx(N,{className:"text-muted-foreground",children:s.email}),e.jsx(N,{children:Y(s.role)}),e.jsx(N,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>O(s),title:"Editar",children:e.jsx(Me,{className:"w-4 h-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>W(s),disabled:s.id===(a==null?void 0:a.id),title:s.id===(a==null?void 0:a.id)?"Não pode excluir a si mesmo":"Excluir",className:"text-destructive hover:text-destructive",children:e.jsx(he,{className:"w-4 h-4"})})]})})]},s.id))})]})})]})]})}),e.jsx(xe,{open:K,onOpenChange:y,children:e.jsxs(je,{children:[e.jsxs(fe,{children:[e.jsx(pe,{children:o?"Editar Usuário":"Adicionar Novo Usuário"}),e.jsx(ge,{children:o?"Atualize as informações do usuário":"Preencha os dados para criar um novo usuário"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"email",children:[e.jsx(ve,{className:"inline w-4 h-4 mr-2"}),"Email"]}),e.jsx(T,{id:"email",type:"email",placeholder:"usuario@exemplo.com",value:c.email,onChange:s=>d({...c,email:s.target.value}),disabled:!!o}),m.email&&e.jsx("p",{className:"text-sm text-destructive",children:m.email})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"fullName",children:[e.jsx(I,{className:"inline w-4 h-4 mr-2"}),"Nome Completo"]}),e.jsx(T,{id:"fullName",placeholder:"João Silva",value:c.fullName,onChange:s=>d({...c,fullName:s.target.value})}),m.fullName&&e.jsx("p",{className:"text-sm text-destructive",children:m.fullName})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"role",children:[e.jsx(k,{className:"inline w-4 h-4 mr-2"}),"Permissão"]}),e.jsxs(Ne,{value:c.role,onValueChange:s=>d({...c,role:s}),children:[e.jsx(ye,{children:e.jsx(we,{})}),e.jsxs(be,{children:[e.jsx(H,{value:"company_admin",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-4 h-4"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Admin"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Acesso total ao sistema"})]})]})}),e.jsx(H,{value:"company_staff",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Usuário"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Acesso limitado ao sistema"})]})]})})]})]}),m.role&&e.jsx("p",{className:"text-sm text-destructive",children:m.role})]})]}),e.jsxs(Ce,{children:[e.jsx(p,{variant:"outline",onClick:F,children:"Cancelar"}),e.jsx(p,{onClick:J,disabled:C.isPending,children:C.isPending?"Salvando...":o?"Atualizar":"Criar"})]})]})}),e.jsx(_e,{open:G,onOpenChange:w,children:e.jsxs(De,{children:[e.jsxs(Te,{children:[e.jsx(Ae,{children:"Tem certeza?"}),e.jsxs(Ue,{children:["Esta ação não pode ser desfeita. O usuário ",e.jsx("strong",{children:o==null?void 0:o.full_name})," será removido permanentemente do sistema."]})]}),e.jsxs(ke,{children:[e.jsx(Ie,{children:"Cancelar"}),e.jsx(Pe,{onClick:X,className:"bg-destructive hover:bg-destructive/90",disabled:E.isPending,children:E.isPending?"Excluindo...":"Excluir"})]})]})})]})}export{He as default};

